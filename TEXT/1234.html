<!doctype html>
<html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

<!-- 放在 <head> -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>Paper Story Viewer</title>
<style>
  :root{ --ratio:16 / 9; }
  html,body{ height:100%; }
  body{
    margin:0; background:transparent !important; color:#222;
    font-family: "Segoe UI", "Roboto", "Helvetica Neue", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    user-select:none; display:grid; place-items:center;
  }
  .centerer{ box-sizing:border-box; width:100%; height:100%; display:grid; place-items:center; padding:0; background:transparent; }
  .box{
    width: min(1200px, 75vw, calc(80vh * (16/9)));
    display:grid; grid-template-rows: 1fr 0; gap:.75rem;
    background:transparent; position:relative;
  }
  .stageWrap{ width:100%; display:flex; align-items:center; justify-content:center; background:transparent; }
  .stage{
    width:100%;
    aspect-ratio:var(--ratio);
    position:relative; overflow:hidden; border:none; background:transparent;
    max-height:80vh;
  }
  .controls{ display:flex; align-items:center; gap:.5rem; justify-content:center; padding:.25rem 0; background:transparent; }
  .item{ position:absolute; will-change: transform, opacity; -webkit-backface-visibility:hidden; backface-visibility:hidden; }
  .item.bgfull{ left:0 !important; width:100% !important; }
  .item img{ display:block; width:100%; height:auto; transform-origin:center center; -webkit-user-drag:none; user-drag:none; }

  /* 階層特效 */
  .layer-foreground img{
    filter:
      drop-shadow( 0.3em  0.3em   1px rgba(0,0,0,.55))
      drop-shadow(-0.3em  0       0 rgba(0,0,0,.55))
      drop-shadow( 0      0.3em   0 rgba(0,0,0,.55))
      drop-shadow( 0     -0.3em  0px rgba(0,0,0,.45))
      drop-shadow( 0.1em  0.1em   2px rgba(0,0,0,.35))
      drop-shadow(-0.1em  -0.1em   0 rgba(0,0,0,.35))
      drop-shadow(0 0em 2em rgba(0,0,0,1))
  }
  .layer-character img{
    filter:
     drop-shadow( 0.4em  0.2em   0 rgba(0,0,0,.50))
      drop-shadow(-0.2em -0.1em   1px rgba(0,0,0,.50))
      drop-shadow( 0      0.2em   2px rgba(0,0,0,.50))
      drop-shadow( 0     -0.2em   2px rgba(0,0,0,.40))
      drop-shadow(0 1em 1em rgba(0,0,0,0.5))
  }
  .layer-background img{
    filter:
     drop-shadow( 0.3em  0   1px rgba(0,0,0,.40))
     drop-shadow(-0.3em  0   1px rgba(0,0,0,.40))
     drop-shadow( 0    0.1em 0 rgba(0,0,0,.40))
     drop-shadow( 0   -0.1em 0 rgba(0,0,0,.32))
     drop-shadow(0 0em 1em rgba(0,0,0,0.6))
  }

  /* iOS 濾鏡收斂 */
  @supports (-webkit-overflow-scrolling: touch) {
    .layer-foreground img{
      filter:
        drop-shadow( 0.4em  0.4em   5px rgba(0,0,0,0.8))
        drop-shadow(-0.3em -0.3em   1px rgba(0,0,0,0.6))
        drop-shadow(0 0em 2em rgba(0,0,0,1));
    }
    .layer-character img{
      filter:
        drop-shadow( 0.3em  0.3em   3px rgba(0,0,0,0.8))
        drop-shadow(-0.2em -0.2em   2px rgba(0,0,0,0.5))
        drop-shadow(0 0em 0.8em rgba(0,0,0,0.8));
    }
    .layer-background img{
      filter:
        drop-shadow( 0.2em  0.2em   4px rgba(0,0,0,0.8))
        drop-shadow(-0.1em -0.2em   2px rgba(0,0,0,0.4))
        drop-shadow(0 0em 1em rgba(0,0,0,1));
    }
  }

  /* Keyframes */
  @keyframes in-from {
    0%   { transform: translate3d(var(--fromX,0),var(--fromY,0),0); opacity:0; }
    70%  { transform: translate3d(var(--inOverX,0),var(--inOverY,0),0); opacity:1; }
    100% { transform: translate3d(0,0,0); opacity:1; }
  }
  @keyframes in-from-nofade {
    0%   { transform: translate3d(var(--fromX,0),var(--fromY,0),0); }
    70%  { transform: translate3d(var(--inOverX,0),var(--inOverY,0),0); }
    100% { transform: translate3d(0,0,0); }
  }
  @keyframes out-to {
    0%   { transform: translate3d(0,0,0); opacity:1; }
    18%  { transform: translate3d(var(--outPreX,0),var(--outPreY,0),0); }
    100% { transform: translate3d(var(--toX,0),var(--toY,0),0); opacity:0; }
  }
  @keyframes out-to-nofade {
    0%   { transform: translate3d(0,0,0); }
    18%  { transform: translate3d(var(--outPreX,0),var(--outPreY,0),0); }
    100% { transform: translate3d(var(--toX,0),var(--toY,0),0); }
  }
  @keyframes in-linear {
    0%   { transform: translate3d(var(--fromX,0),var(--fromY,0),0); opacity:0; }
    100% { transform: translate3d(0,0,0); opacity:1; }
  }
  @keyframes in-linear-nofade {
    0%   { transform: translate3d(var(--fromX,0),var(--fromY,0),0); }
    100% { transform: translate3d(0,0,0); }
  }
  @keyframes out-linear {
    0%   { transform: translate3d(0,0,0); opacity:1; }
    100% { transform: translate3d(var(--toX,0),var(--toY,0),0); opacity:0; }
  }
  @keyframes out-linear-nofade {
    0%   { transform: translate3d(0,0,0); }
    100% { transform: translate3d(var(--toX,0),var(--toY,0),0); }
  }

  /* 進/出場的預備態（關鍵修正） */
  .item.pre-in{
    opacity:0;
    transform: translate3d(var(--fromX,0), var(--fromY,0), 0);
  }
  .item.pre-out{
    opacity:1;
    transform: translate3d(0,0,0);
  }

  .navBtn{
    display:flex; position:absolute; top:50%; transform:translateY(-50%);
    width:48px; height:48px; border-radius:50%;
    background:rgba(32,33,36,.7); color:#e8eaed; fill:#e8eaed;
    border:0; outline:none; cursor:pointer;
    align-items:center; justify-content:center;
    transition:background .3s; z-index:999999;
  }
  .box .navBtn.left{ left:-35px; } .box .navBtn.right{ right:-35px; }
  .navBtn:hover{ background:rgba(32,33,36,.9); }
  .navBtn:active{ transform:translateY(-50%) scale(.98); }
  .hint{position:absolute; inset:auto 0 8px 0; text-align:center; font-size:12px; color:#888;}

  .speech-bubble .content{ line-height:1.45; white-space:pre-wrap; word-break:break-word; margin:0; }
  .speech-bubble .content > *:first-child{ margin-top:0; }
  .speech-bubble .content br:first-child{ display:none; }
</style>
</head><body ondragstart="return false;">
<div class="centerer">
  <div class="box">
    <div class="stageWrap"><div id="stage" class="stage" aria-label="故事舞台"></div></div>

    <button id="navPrev" class="navBtn left" aria-label="上一頁" title="上一頁">
      <svg width="36" height="36" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true">
        <path d="M30.83 32.92L21.66 23.75l9.17-9.17L28 11.75l-12 12 12 12z"></path>
        <path d="M0-.25h48v48H0z" fill="none"></path>
      </svg>
    </button>
    <button id="navNext" class="navBtn right" aria-label="下一頁" title="下一頁">
      <svg width="36" height="36" viewBox="0 0 48 48" fill="currentColor" aria-hidden="true">
        <path d="M17.17 32.92l9.17-9.17-9.17-9.17L20 11.75l12 12-12 12z"></path>
        <path d="M0-.25h48v48H0z" fill="none"></path>
      </svg>
    </button>

    <div class="controls"><div id="hint" class="hint">正在預載圖片…</div></div>
  </div>
</div>
<script>
const EASE='cubic-bezier(.2,.9,.2,1)';
const LIN='linear';
const project = {"pages":[{"id":"loztikk","name":"第 1 頁","items":[{"id":"qk5a50x","name":"圖片","src":"https://rorocat030.github.io/shierusya/TEXT/img/12345.jpg","layer":"bgfull","top":-15.933952049007406,"left":0,"width":100,"order":0,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"al4zrt0","name":"圖片","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":17.978113751203946,"left":7.866755773925947,"width":54.84108169215697,"order":0,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"yxklfvz","name":"圖片（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":19.978113751203946,"left":9.866755773925947,"width":54.84108169215697,"order":1,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"ukfnmbo","name":"圖片（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":21.978113751203946,"left":11.866755773925947,"width":54.84108169215697,"order":2,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"y7b2lnb","name":"圖片（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":23.978113751203946,"left":13.866755773925947,"width":54.84108169215697,"order":3,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"ujlpb6t","name":"圖片（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":31.00962700756204,"left":7.154947523558997,"width":54.84108169215697,"order":4,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"d0imxrx","name":"圖片（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":17.493283053447364,"left":26.92944061274097,"width":54.84108169215697,"order":5,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"aenwmaq","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":44.02149000613367,"left":-1.9147325407044509,"width":54.84108169215697,"order":6,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"rc9qi33","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":33.23068325818447,"left":41.87757588843552,"width":54.84108169215697,"order":7,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"qffwsfx","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":35.23068325818447,"left":43.87757588843552,"width":54.84108169215697,"order":8,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"0xlpm8y","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":37.23068325818447,"left":45.87757588843552,"width":54.84108169215697,"order":9,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"incu6pb","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":39.23068325818447,"left":47.87757588843552,"width":54.84108169215697,"order":10,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"f31n61a","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":39.76283856137873,"left":30.453568963865717,"width":54.84108169215697,"order":11,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"w06olbc","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":-18.200878842295772,"left":28.566438756093852,"width":54.84108169215697,"order":12,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"yi9pcx4","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":52.77796721883751,"left":20.916715957017338,"width":54.84108169215697,"order":13,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"qsaduxy","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":54.77796721883751,"left":22.916715957017338,"width":54.84108169215697,"order":14,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true},{"id":"07smupj","name":"圖片（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）（複製）","src":"https://rorocat030.github.io/shierusya/TEXT/img/TREE.png","layer":"character","top":56.77796721883751,"left":24.916715957017338,"width":54.84108169215697,"order":15,"flipX":false,"rotate":0,"inDir":"in-bottom","inDelay":0,"inSpeed":0.7,"inCustomDur":1,"outDir":"auto","outDelay":0,"outSpeed":0.7,"outCustomDur":1,"inFade":true,"outFade":true}]}],"currentPage":0,"ratio":{"w":16,"h":9}};
let idx = 0;
let busy = false;
const stage = document.getElementById('stage');
const navPrev = document.getElementById('navPrev');
const navNext = document.getElementById('navNext');
const hintEl = document.getElementById('hint');

/* --- 圖片可畫就緒（避免先畫終點） --- */
function imgReady(img){ return img.complete && img.naturalWidth > 0; }
function decodeSafe(img){
  if (imgReady(img)) return Promise.resolve();
  if (typeof img.decode === 'function') return img.decode().catch(()=>{});
  return new Promise(res=>{ img.addEventListener('load', res, {once:true}); img.addEventListener('error', res, {once:true}); });
}
async function waitForPageImages(pageIdx, {timeout=800}={}){
  const nodes = qPageNodes(pageIdx);
  const imgs = nodes.flatMap(n => Array.from(n.querySelectorAll('img')));
  if (imgs.length === 0) return;
  const all = Promise.allSettled(imgs.map(decodeSafe));
  await Promise.race([all, new Promise(r=>setTimeout(r, timeout))]);
}

/* --- 工具 --- */
function zBase(layer){ return layer==='foreground'?30: layer==='speech'?25: layer==='character'?20: layer==='background'?10: 0; }
function zIndexOf(it){ return zBase(it.layer)*100 + (it.order||0); }
function zIndexForPreview(it, pageIdx){ return pageIdx*10000 + zIndexOf(it); }
function oppositeOut(inDir){ return ({'in-top':'out-top','in-bottom':'out-bottom','in-left':'out-left','in-right':'out-right'})[inDir] || 'out-bottom'; }
function rgba(hex,a){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)||['','00','00','00']; const r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16); return `rgba(${r},${g},${b},${a})`; }
function textFromHTML(html){ const d=document.createElement('div'); d.innerHTML=html||''; return d.textContent||d.innerText||''; }

function rectIn(el, container){ const r=el.getBoundingClientRect(), s=container.getBoundingClientRect(); return { x:r.left-s.left, y:r.top-s.top, w:r.width, h:r.height, sw:s.width, sh:s.height }; }
function overshoot(px){ return Math.min(24, Math.abs(px)*0.03) * (px>0 ? -1 : (px<0 ? 1 : 0)); }
function preNudge(px){ return Math.min(24, Math.abs(px)*0.04) * (px>0 ? -1 : (px<0 ? 1 : 0)); }
function setInVars(node, dir, container){
  const r=rectIn(node, container);
  let v;
  if(dir==='in-left')   v={ x:-(r.x + r.w + 4), y:0 };
  else if(dir==='in-right') v={ x:(r.sw - r.x)+r.w + 4, y:0 };
  else if(dir==='in-top')   v={ x:0, y:-(r.y + r.h + 4) };
  else                      v={ x:0, y:(r.sh - r.y)+r.h + 4 };
  node.style.setProperty('--fromX', v.x+'px'); node.style.setProperty('--fromY', v.y+'px');
  node.style.setProperty('--inOverX', overshoot(v.x)+'px'); node.style.setProperty('--inOverY', overshoot(v.y)+'px');
}
function setOutVars(node, dir, container){
  const r=rectIn(node, container);
  let v;
  if(dir==='out-left')   v={ x:-(r.x + r.w + 4), y:0 };
  else if(dir==='out-right') v={ x:(r.sw - r.x)+r.w + 4, y:0 };
  else if(dir==='out-top')   v={ x:0, y:-(r.y + r.h + 4) };
  else                       v={ x:0, y:(r.sh - r.y)+r.h + 4 };
  node.style.setProperty('--toX', v.x+'px'); node.style.setProperty('--toY', v.y+'px');
  node.style.setProperty('--outPreX', preNudge(v.x)+'px'); node.style.setProperty('--outPreY', preNudge(v.y)+'px');
}

function bubbleCSS(selector,s){
  let triRaw = s.triangle || 'sym'; if(triRaw==='symmetrical') triRaw='sym';
  const br = (s.brMode === 'per')
    ? `${Number(s.brTL||0)}px `+
      `${Number(s.brTR||0)}px `+
      `${Number(s.brBR||0)}px `+
      `${Number(s.brBL||0)}px`
    : `${Number(s.brAll||16)}px`;
  const base = `${selector}{ position:relative; display:block; box-sizing:border-box; width:100%;
    padding:${s.padEm}em; background:${s.bg}; color:${s.textColor};
    font-weight:700; text-shadow:0 -.05em .1em rgba(0,0,0,.3); border-radius:${br}; }`;
  if(triRaw === 'none') return base;
  const side = s.side || 'bottom', isH = (side==='top'||side==='bottom');
  const opposite = {top:'bottom', right:'left', bottom:'top', left:'right'}[side];
  const offsetAxis = isH ? 'left' : 'top';
  const size = `${s.sizeEm}em`;
  const nearEm = Math.max(0, Math.min(0.05, Number(s.nudgeEm ?? (s.nudge ? 0.05 : 0))));
  const near = `${nearEm}em`;
  const triKey = (triRaw==='sym') ? 'symmetrical' : (triRaw==='left'?'left':'right');
  const cut = (triKey!=='symmetrical') ? (isH ? triKey : (triKey==='right'?'top':'bottom')) : null;
  const marginOffset = (triKey==='symmetrical') ? `-${size}` : `calc(-${size}/2)`;
  const arrow = `${selector}:after{ content:''; position:absolute; ${side}:${near}; ${offsetAxis}:${Math.max(10,Math.min(90,s.pointer))}% ;
    width:0; height:0; border-style:solid; border-color:transparent; border-width:${size};
    border-${side}-width:0; border-${opposite}-color:${s.bg}; ${cut ? `border-${cut}-width:0;` : ''} margin-${offsetAxis}:${marginOffset}; margin-${side}:-${size}; }`;
  return base + arrow;
}
function autoFontPxForNode(node, s){
  const raw=textFromHTML(s.html||''); const lines=raw.split(/\r?\n/).map(x=>x.trim()); const longest=lines.reduce((m,l)=> l.length>m.length?l:m,'')||raw;
  const meas=document.createElement('span'); Object.assign(meas.style,{position:'absolute',visibility:'hidden',whiteSpace:'pre',left:'-9999px',top:'-9999px',fontWeight:'700'}); meas.textContent=longest||''; document.body.appendChild(meas);
  const tryFit = (px)=>{ const padPx=(Number(s.padEm||1))*px*2; const inner=Math.max(10, node.getBoundingClientRect().width - padPx); meas.style.fontSize=px+'px'; const w=meas.getBoundingClientRect().width; return w<=inner; };
  let lo=6, hi, test=16, lastOk=lo;
  while(test<=1024 && tryFit(test)){ lastOk=test; test=Math.ceil(test*1.5); }
  hi=Math.min(1024, Math.max(test, lastOk+1)); lo=lastOk;
  let best=lo; for(let i=0;i<15;i++){ const mid=(lo+hi)/2; if(tryFit(mid)){ best=mid; lo=mid; } else { hi=mid; } }
  document.body.removeChild(meas); return best;
}

/* --- 節點生成 --- */
function createNode(it, pageIdx){
  const d=document.createElement('div');
  d.className='item layer-'+it.layer + (it.layer==='bgfull'?' bgfull': (it.layer==='speech'?' speech':'' ));
  d.style.top=it.top+'%'; d.style.left=(it.layer==='bgfull'?'0':it.left)+'%'; d.style.width=(it.layer==='bgfull'?'100':it.width)+'%';
  d.style.zIndex=zIndexForPreview(it, pageIdx);
  if(it.layer==='speech'){
    const bubble=document.createElement('div'); bubble.className='speech-bubble speech-'+it.id;
    const content=document.createElement('div'); content.className='content'; content.innerHTML=it.speech?.html||''; bubble.appendChild(content); d.appendChild(bubble);
    const st=document.createElement('style'); st.textContent=bubbleCSS('.speech-'+it.id,{
      side:it.speech.side||'bottom',
      triangle:(it.speech.triangle==='symmetrical'?'sym':(it.speech.triangle||'sym')),
      pointer:Math.max(10,Math.min(90, Number(it.speech.pointer||50))),
      nudgeEm: Math.max(0, Math.min(0.05, Number(it.speech.nudgeEm ?? (it.speech.nudge ? 0.05 : 0)))),
      sizeEm:Number(it.speech.sizeEm||1.2), padEm:Number(it.speech.padEm||1),
      bg:rgba(it.speech.bgHex||'#00aabb',(Number(it.speech.alpha||100)/100)),
      textColor:it.speech.textHex||'#ffffff',
      brMode:it.speech.brMode||'unified',
      brAll:Number(it.speech.brAll??16),
      brTL:Number(it.speech.brTL ?? it.speech.brAll ?? 16),
      brTR:Number(it.speech.brTR ?? it.speech.brAll ?? 16),
      brBR:Number(it.speech.brBR ?? it.speech.brAll ?? 16),
      brBL:Number(it.speech.brBL ?? it.speech.brAll ?? 16),
    }); d.appendChild(st);
  }else{
    const img=document.createElement('img'); img.src=it.src; img.alt=it.name||''; img.setAttribute('draggable','false');
    if(it.layer==='bgfull'){ img.style.transform='none'; } else { img.style.transform='scaleX('+(it.flipX?-1:1)+') rotate('+(it.rotate||0)+'deg)'; }
    d.appendChild(img);
  }
  d.dataset.inDir=it.inDir; d.dataset.inDelay=it.inDelay; d.dataset.inSpeed=String(it.inSpeed);
  d.dataset.outDir=it.outDir||'auto'; d.dataset.outDelay=it.outDelay; d.dataset.outSpeed=String(it.outSpeed);
  d.dataset.inKind=(it.inSpeed==='custom')?'custom':'preset';
  d.dataset.outKind=(it.outSpeed==='custom')?'custom':'preset';
  d.dataset.inCustom=String(Math.max(0.2,Math.min(15, Number(it.inCustomDur||1))));
  d.dataset.outCustom=String(Math.max(0.2,Math.min(15, Number(it.outCustomDur||1))));
  d.dataset.page=String(pageIdx); d.dataset.item=it.id;
  d.dataset.inFade=(it.inFade===false?'0':'1'); d.dataset.outFade=(it.outFade===false?'0':'1');
  return d;
}
function qPageNodes(p){ return [...stage.querySelectorAll('.item[data-page="'+p+'"]')]; }
function clearAnim(n){ n.style.animation='none'; n.style.webkitAnimation='none'; void n.offsetWidth; }

/* --- Page mount --- */
function addPage(pageIdx, {onlyNonBg=false, markFirstBgPersisted=false}={}){
  const p = project.pages[pageIdx];
  p.items.forEach(it=>{
    if(onlyNonBg && it.layer==='bgfull') return;
    if(it.layer==='bgfull' && stage.querySelector('.item[data-page="'+pageIdx+'"][data-item="'+it.id+'"]')) return;
    const n = createNode(it, pageIdx);
    if(it.layer==='bgfull' && markFirstBgPersisted) n.dataset.persisted='1';
    stage.appendChild(n);
    if(it.layer==='speech') {
      const px1 = autoFontPxForNode(n, it.speech||{});
      n.querySelector('.speech-bubble').style.fontSize = px1 + 'px';
      requestAnimationFrame(()=>{ const px2 = autoFontPxForNode(n, it.speech||{}); n.querySelector('.speech-bubble').style.fontSize = px2 + 'px'; });
    }
  });
}
function durIn(n){ return (n.dataset.inKind==='custom')? Number(n.dataset.inCustom): Number(n.dataset.inSpeed); }
function durOut(n){ return (n.dataset.outKind==='custom')? Number(n.dataset.outCustom): Number(n.dataset.outSpeed); }

/* --- 進場：先 pre-in 一幀再跑動畫 --- */
async function playIn(pageIdx, {animateBg=true}={}) {
  const nodes = qPageNodes(pageIdx);
  nodes.forEach(clearAnim);

  const targets = nodes.filter(n => {
    const isBg = n.classList.contains('bgfull');
    const skipFirstOrPersist = (isBg && pageIdx===0) || (isBg && n.dataset.persisted==='1');
    const skipOpt = isBg && !animateBg;
    return !(skipFirstOrPersist || skipOpt);
  });

  targets.forEach(n => { setInVars(n, n.dataset.inDir, stage); n.classList.add('pre-in'); });
  await new Promise(requestAnimationFrame);

  targets.forEach(n => {
    const custom = (n.dataset.inKind==='custom');
    const name = custom
      ? ((n.dataset.inFade === '0') ? 'in-linear-nofade' : 'in-linear')
      : ((n.dataset.inFade === '0') ? 'in-from-nofade' : 'in-from');
    const d = (n.dataset.inKind==='custom') ? Number(n.dataset.inCustom) : Number(n.dataset.inSpeed);
    const delay = Number(n.dataset.inDelay)||0;

    n.addEventListener('animationstart', () => n.classList.remove('pre-in'), { once:true });

    n.style.animation = `${name} ${d}s ${custom?LIN:EASE} ${delay}s both`;
    n.style.webkitAnimation = n.style.animation;
  });

  const end = targets.reduce((m,n)=> Math.max(m, Number(n.dataset.inDelay) + ((n.dataset.inKind==='custom')? Number(n.dataset.inCustom): Number(n.dataset.inSpeed))), 0);
  return new Promise(r=>setTimeout(r, (end+0.05)*1000));
}

/* --- 出場：先 pre-out 一幀，避免瞬間消失 --- */
async function playOut(pageIdx, {excludeBg=false}={}) {
  const nodes = qPageNodes(pageIdx);
  nodes.forEach(clearAnim);

  const targets = nodes.filter(n => !(excludeBg && n.classList.contains('bgfull')));

  targets.forEach(n => {
    const base = (n.dataset.outDir === 'auto') ? oppositeOut(n.dataset.inDir) : n.dataset.outDir;
    setOutVars(n, base, stage);
    n.classList.add('pre-out');
  });

  await new Promise(requestAnimationFrame);

  const waits = [];
  targets.forEach(n => {
    const custom = (n.dataset.outKind === 'custom');
    const name = custom
      ? ((n.dataset.outFade === '0') ? 'out-linear-nofade' : 'out-linear')
      : ((n.dataset.outFade === '0') ? 'out-to-nofade' : 'out-to');
    const d = custom ? Number(n.dataset.outCustom) : Number(n.dataset.outSpeed);
    const delay = Number(n.dataset.outDelay) || 0;

    n.addEventListener('animationstart', () => n.classList.remove('pre-out'), { once: true });

    const done = new Promise(res => n.addEventListener('animationend', res, { once: true }));
    const fallback = new Promise(r => setTimeout(r, (delay + d + 0.05) * 1000));
    waits.push(Promise.race([done, fallback]));

    n.style.animation = `${name} ${d}s ${custom?LIN:EASE} ${delay}s both`;
    n.style.webkitAnimation = n.style.animation;
  });

  await Promise.all(waits);
}

/* --- 進出頁 --- */
function removePage(pageIdx, {onlyNonBg=false}={}) {
  qPageNodes(pageIdx).forEach(n=>{
    if(onlyNonBg && n.classList.contains('bgfull')) return;
    n.remove();
  });
}

/* --- 預載 --- */
function preloadAllImages(){
  const urls = new Set();
  project.pages.forEach(p=>{ p.items.forEach(it=>{ if(it.layer!=='speech' && it.src) urls.add(it.src); }); });
  const tasks = [...urls].map(u => new Promise(resolve=>{
    const im = new Image(); im.referrerPolicy='no-referrer';
    im.onload=()=>resolve(); im.onerror=()=>resolve(); im.src=u;
  }));
  return Promise.allSettled(tasks);
}

/* --- 啟動 --- */
async function openAt(current){
  idx = current;
  stage.innerHTML='';
  addPage(0, {markFirstBgPersisted:true});
  if(idx>0){
    for(let i=1;i<=idx;i++){
      removePage(i-1, {onlyNonBg:true});
      addPage(i);
    }
  }
  await new Promise(requestAnimationFrame);
  await waitForPageImages(idx);
  await playIn(idx);
}

async function go(to){
  if(to===idx) return;
  if(busy) return;
  busy = true;
  try{
    if(to>idx){
      await playOut(idx, {excludeBg:true});
      removePage(idx, {onlyNonBg:true});
      idx = to; addPage(idx);
      await new Promise(requestAnimationFrame);
      await waitForPageImages(idx);
      await playIn(idx, {animateBg:true});
    }else{
      await playOut(idx, {excludeBg:false});
      removePage(idx, {onlyNonBg:false});
      idx = to; addPage(idx, {onlyNonBg:true});
      await new Promise(requestAnimationFrame);
      await waitForPageImages(idx);
      await playIn(idx, {animateBg:false});
    }
  }finally{
    busy = false;
  }
}

/* --- 控制 --- */
navPrev.onclick = ()=> { if(idx>0) go(idx-1); };
navNext.onclick = ()=> { if(idx<project.pages.length-1) go(idx+1); };
document.addEventListener('keydown', (e)=>{ if(busy) return; if(e.key==='ArrowLeft') navPrev.click(); if(e.key==='ArrowRight') navNext.click(); });

window.addEventListener('resize', debounce(()=>{
  qPageNodes(idx).forEach(n=>{
    const pg = project.pages[idx];
    const it = pg?.items?.find(x=>x.id===n.dataset.item);
    if(it?.layer==='speech'){
      const px1 = autoFontPxForNode(n, it.speech||{});
      n.querySelector('.speech-bubble').style.fontSize = px1 + 'px';
      requestAnimationFrame(()=>{ const px2 = autoFontPxForNode(n, it.speech||{}); n.querySelector('.speech-bubble').style.fontSize = px2 + 'px'; });
    }
  });
}, 120));

function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* --- 啟動流程 --- */
(async ()=>{
  try{ await preloadAllImages(); }
  finally{
    if(hintEl) hintEl.remove();
    await openAt(0);
  }
})();
</script>
</body></html>
