<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>謝爾夏｜管理後台</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap" rel="stylesheet" />
  <style>
        #info {  white-space: pre-line;}

    :root { --name-w: auto; }
    * { box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', sans-serif; background:#f3f7fb; margin:0; min-height:100vh; color:#143158; }
    a { color:#1767a0; text-decoration:none; }
    .container { max-width: 1200px; margin: 32px auto; background: #fff; padding: 18px; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin: 0 0 6px 0; font-size: 22px; letter-spacing: .5px; }
    .hr-blue { width: 92%; height: 4px; background: #1767a0; margin: 8px auto 18px auto; border-radius: 2px; opacity: .85; }

    .row { display:flex; gap:12px; align-items:center; flex-direction: column; }
    .grow { flex:1; }
    .muted { color:#5a728f; }
    .warn { color:#b54708; }
    .ok { color:#157f3b; }
    .err { color:#b42318; }

    .card { background:#f7fbff; border:1px solid #e6eef6; border-radius:12px; padding:12px; margin:10px 0; }

    /* Auth */
    .auth-wrap { max-width:420px; margin:40px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .auth-title { text-align:center; font-weight:700; margin-bottom:10px; }
    .field { display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    input[type=text], input[type=password], input[type=number], select, textarea { padding:8px 6px; border:1px solid #d7e3ef; border-radius:8px; background:#fff; font-size:14px; color:#143158; }
    textarea { min-height:80px; }
    .btn { border:none; background:#1767a0; color:#fff; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 1px 4px #0001; }
    .btn.secondary { background:#e9f1f9; color:#143158;    max-height: 4em; }
    .btn.ghost { background:transparent; color:#1767a0; border:1px solid #1767a0; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .right { margin-left:auto; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px; }
    .tab-btn { border:none; background:#e9f1f9; color:#143158; padding:7px 10px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 1px 4px #0001; }
    .tab-btn.active { background:#1767a0; color:#fff; }

    /* Tables */
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fbfdff; border:1px solid #e6eef6; border-radius:8px; overflow:hidden; table-layout: fixed; }
    thead { background:#ddebf7; }
    th, td { padding:8px 10px; border-bottom:1px solid #edf3f9; text-align:left; vertical-align:middle; }
    tbody tr:hover { background:#eef6ff; }
    td input, td select, td textarea { width:100%; box-sizing: border-box; }

    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 8px 0; flex-direction: row-reverse; }
    .pill { font-size:12px; background:#143158; color:#fff; border-radius:6px; padding:4px 8px; }
    .chip { font-size:12px; background:#eef6ff; color:#143158; border-radius:999px; padding:2px 8px; }
    .spacer { flex:1; }
    .grid { display:grid; gap:8px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 860px){ .grid-3, .grid-4 { grid-template-columns: repeat(1,minmax(0,1fr)); } }

    .help { font-size:12px; color:#5a728f; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .center { text-align:center; }

    /* ===== A 專案登入彈窗 ===== */
    .modal-mask {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      width: min(420px, 92vw);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,.2);
      position: relative;
    }
    .modal h3 { margin: 0 0 8px 0; font-size: 18px; }
    .modal .field { margin: 8px 0; }
    .modal .row { flex-direction: row; justify-content: flex-end; }
    .modal .msg { font-size: 12px; color:#5a728f; min-height: 1.2em; }
    .modal .close-x { position:absolute; right:12px; top:8px; cursor:pointer; color:#5a728f; }
    .delta.plus { color:#157f3b; font-weight:700; }
    .delta.minus { color:#b42318; font-weight:700; }
  </style>
</head>
<body>
  <div class="container" id="app" hidden>
    <div class="row">
      <h1>謝爾夏｜管理後台</h1>
      <span class="pill">C 專案（資料庫）</span>
      <span class="chip" id="whoami"></span>
      <button class="btn ghost right" id="signoutBtn">登出</button>
    </div>
    <div class="hr-blue"></div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="t1">學生快取 / 玩家綁定</button>
      <button class="tab-btn" data-tab="t2">地區表</button>
      <button class="tab-btn" data-tab="t3">時薪/點數設定</button>
      <button class="tab-btn" data-tab="t4">販售道具</button>
      <button class="tab-btn" data-tab="t4spshop">其他商店</button>
      <button class="tab-btn" data-tab="t4gift">贈送道具</button>
      <button class="tab-btn" data-tab="t5">戰鬥攜帶物</button>
      <button class="tab-btn" data-tab="t6">教師文本</button>
      <button class="tab-btn" data-tab="t7">交易紀錄</button>
      <button class="tab-btn" data-tab="t8">場景介紹</button>

    </div>

    <div id="content"></div>
  </div>

  <!-- Auth Screen (C 專案) -->
  <div id="auth" class="auth-wrap" hidden>
    <div class="auth-title">登入管理後台（C 專案）</div>
    <div class="field">
      <label>電子郵件</label>
      <input id="email" type="text" />
    </div>
    <div class="field">
      <label>密碼</label>
      <input id="password" type="password" placeholder="••••••••" />
    </div>
    <div class="row">
      <button class="btn" id="signinBtn">登入</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </div>

  <!-- 你原本的 A 專案登入彈窗（保留可用），沒有 msg 節點也沒關係 -->
  <div id="aLoginMask" class="modal-mask" aria-hidden="true">
    <div class="modal">
      <div class="close-x" id="aLoginClose">✕</div>
      <h3>登入 A 專案</h3>
      <div class="field">
        <label>電子郵件</label>
        <input id="aEmail" type="text"/>
      </div>
      <div class="field">
        <label>密碼</label>
        <input id="aPassword" type="password" placeholder="••••••••" />
      </div>
      <div class="row">
        <button class="btn secondary" id="aLoginCancel">取消</button>
        <button class="btn" id="aLoginDo">登入</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // Supabase 客戶端（C：本庫 / A：玩家&角色）
    // ------------------------
    const C_URL = 'https://pptmmkpipwcgbxbimarp.supabase.co';
    const C_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwdG1ta3BpcHdjZ2J4YmltYXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDE5NjQsImV4cCI6MjA3MzUxNzk2NH0.E5ynYRbCKqnsppdhNZFHN4biiS-8hxhBplEG9FeUdcU';

    const A_URL = 'https://wfhwhvodgikpducrhgda.supabase.co';
    const A_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8';

    const adminClient = window.supabase.createClient(C_URL, C_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    });
    const aClient = window.supabase.createClient(A_URL, A_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // Enums（前端固定選單）
    const AREA_TYPES = ['學習','愛校','打工','特殊打工','遊戲','特製'];
    const CURRENCIES = ['一般貨幣','謝爾夏貨幣','愛校點數'];
    const isGameLike = (t) => t === '遊戲' || t === '特製';

    // 小工具
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs={}, children=[]) => {
      const n=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') n.className=v;
        else if(k==='text') n.textContent=v;
        else n.setAttribute(k,v);
      });
      children.forEach(c=>n.appendChild(c));
      return n;
    };
    const fmtTime = (s)=> s? new Date(s).toLocaleString('zh-TW', { timeZone:'Asia/Taipei' }) : '-';


// ===== 全域 Toast（一次性） =====
function ensureToastBox(){
  if (document.getElementById('toastBox')) return;
  const css = document.createElement('style');
  css.textContent = `
  #toastBox{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:99999}
  .toast{background:#143158;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);opacity:.98}
  .toast.ok{background:#157f3b}.toast.err{background:#b42318}.toast.warn{background:#b54708}
  `;
  document.head.appendChild(css);
  const box = document.createElement('div'); box.id = 'toastBox'; document.body.appendChild(box);
}
function toast(msg, kind='ok', ms=1600){
  ensureToastBox();
  const el = document.createElement('div');
  el.className = `toast ${kind}`;
  el.textContent = msg;
  document.getElementById('toastBox').appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0';
    setTimeout(()=> el.remove(), 280);
  }, ms);
}


    

    // 讀商品（用於 TAB7 下拉與自動帶幣別/價格/庫存）
async function loadShopItems(){
  const { data, error } = await adminClient
    .from('shop_items')
    .select('item_name, price_type, price, stock')
    .order('item_name',{ascending:true});
  if (error) { console.warn('[loadShopItems]', error); return []; }
  return data || [];
}

    // 活動 enum（要和資料庫 enum earn_kind_e 對得上）
const EARN_KIND = {
  work: '一般打工',
  special: '特殊打工',
  service: '愛校服務'
};


    // ===== 學生下拉快取 =====
    let STUDENT_OPTIONS = [];
    async function loadStudentNames() {
      const { data, error } = await adminClient
        .from('student_cache')
        .select('student_name')
        .order('student_name', { ascending: true });
      if (error) { console.warn('[loadStudentNames]', error); return []; }
      STUDENT_OPTIONS = (data || []).map(r => r.student_name);
      return STUDENT_OPTIONS;
    }
    function makeStudentSelect(currentValue) {
      const sel = document.createElement('select');
      sel.innerHTML = '';
      if (currentValue && !STUDENT_OPTIONS.includes(currentValue)) {
        const o = document.createElement('option');
        o.value = currentValue; o.textContent = currentValue + '（未在快取清單）';
        sel.appendChild(o);
      }
      STUDENT_OPTIONS.forEach(name => {
        const o = document.createElement('option');
        o.value = name; o.textContent = name;
        if (name === currentValue) o.selected = true;
        sel.appendChild(o);
      });
      if (!currentValue && sel.options.length > 0) sel.selectedIndex = 0;
      return sel;
    }
    function makeStudentFilterSelect(currentValue='') {
      const sel = document.createElement('select');
      const all = document.createElement('option'); all.value=''; all.textContent='（全部學生）';
      sel.appendChild(all);
      STUDENT_OPTIONS.forEach(name=>{
        const o=document.createElement('option'); o.value=name; o.textContent=name;
        if (name===currentValue) o.selected=true;
        sel.appendChild(o);
      });
      return sel;
    }

    // ===== A 登入彈窗（動態保險版） =====
    function ensureALoginDOM() {
      if (document.getElementById('aLoginMask')) {
        // 綁定現有 DOM 的按鈕（若存在）
        const closeX = document.getElementById('aLoginClose'); if (closeX) closeX.addEventListener('click', closeALoginModal);
        const cancel = document.getElementById('aLoginCancel'); if (cancel) cancel.addEventListener('click', closeALoginModal);
        const doBtn  = document.getElementById('aLoginDo');    if (doBtn)  doBtn.addEventListener('click', doALogin);
        return;
      }
      // 動態建立一份（含 msg）
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div id="aLoginMask" class="modal-mask" aria-hidden="false">
          <div class="modal">
            <div class="close-x" id="aLoginClose">✕</div>
            <h3>登入 A 專案（wfhwhvodgikpducrhgda）</h3>
            <div class="field">
              <label>電子郵件</label>
              <input id="aEmail" type="text" placeholder="you@example.com" />
            </div>
            <div class="field">
              <label>密碼</label>
              <input id="aPassword" type="password" placeholder="••••••••" />
            </div>
            <div class="row">
              <span class="msg" id="aLoginMsg"></span>
              <button class="btn secondary" id="aLoginCancel">取消</button>
              <button class="btn" id="aLoginDo">登入</button>
            </div>
          </div>
        </div>
      `.trim();
      document.body.appendChild(wrap.firstElementChild);
      document.getElementById('aLoginClose').addEventListener('click', closeALoginModal);
      document.getElementById('aLoginCancel').addEventListener('click', closeALoginModal);
      document.getElementById('aLoginDo').addEventListener('click', doALogin);
    }
    function openALoginModal() {
      ensureALoginDOM();
      const mask = document.getElementById('aLoginMask');
      const msg  = document.getElementById('aLoginMsg');
      const mail = document.getElementById('aEmail');
      const pwd  = document.getElementById('aPassword');
      if (msg)  msg.textContent = '';
      if (mail) mail.value = '';
      if (pwd)  pwd.value = '';
      if (mask) { mask.style.display = 'flex'; mask.setAttribute('aria-hidden', 'false'); }
      setTimeout(() => mail && mail.focus(), 0);
    }
    function closeALoginModal() {
      const mask = document.getElementById('aLoginMask');
      if (mask) { mask.style.display = 'none'; mask.setAttribute('aria-hidden', 'true'); }
    }
    async function doALogin(){
      const msg = document.getElementById('aLoginMsg');
      const email = (document.getElementById('aEmail')?.value || '').trim();
      const password = document.getElementById('aPassword')?.value || '';
      if (msg) msg.textContent = '登入中…';
      const { error } = await aClient.auth.signInWithPassword({ email, password });
      if (error) { if (msg) msg.textContent = '登入失敗：' + (error.message || ''); return; }
      if (msg) msg.textContent = '登入成功';
      setTimeout(() => {
        closeALoginModal();
        if (window.__afterALogin) { try { window.__afterALogin(); } catch(_){} }
      }, 400);
    }
    function ensureALogin() {
      return new Promise(async (resolve) => {
        const u = await aClient.auth.getUser();
        if (u?.data?.user) return resolve(true);
        openALoginModal();
        window.__afterALogin = () => resolve(true);
        const onCancel = () => resolve(false);
        // 綁一次取消/關閉
        setTimeout(()=>{
          const cancel = document.getElementById('aLoginCancel');
          const closeX = document.getElementById('aLoginClose');
          if (cancel) cancel.addEventListener('click', onCancel, { once:true });
          if (closeX) closeX.addEventListener('click', onCancel, { once:true });
        },0);
      });
    }

    // ------------------------
    // Auth (C 專案)
    // ------------------------
    async function showUIBySession(){
      const { data } = await adminClient.auth.getSession();
      if (data?.session) {
        $('#auth').hidden = true; $('#app').hidden = false;
        const who = data.session.user?.email || data.session.user?.id;
        $('#whoami').textContent = `已登入：${who}`;
        renderTab('t1');
      } else {
        $('#app').hidden = true; $('#auth').hidden = false;
      }
    }

    $('#signinBtn').addEventListener('click', async () => {
      $('#signinBtn').disabled = true; $('#authMsg').textContent = '登入中…';
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const { error } = await adminClient.auth.signInWithPassword({ email, password });
      if (error) { $('#authMsg').textContent = '登入失敗：' + (error.message || ''); } else { $('#authMsg').textContent = '登入成功'; }
      $('#signinBtn').disabled = false; showUIBySession();
    });

    $('#signoutBtn').addEventListener('click', async () => {
      await adminClient.auth.signOut();
      showUIBySession();
    });

    // ------------------------
    // Tabs 容器
    // ------------------------
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderTab(btn.dataset.tab);
      });
    });

    async function renderTab(key){
      const c = $('#content'); c.innerHTML = '';
      if (key==='t1') return renderTab1(c);
      if (key==='t2') return renderTab2(c);
      if (key==='t3') return renderTab3(c);
      if (key==='t4') return renderTab4(c);
      if (key==='t4spshop') return renderTab4Spshop(c);  
      if (key==='t4gift') return renderTab4Gift(c);
      if (key==='t5') return renderTab5(c);
      if (key==='t6') return renderTab6(c);
      if (key==='t7') return renderTab7(c); 
      if (key==='t8') return renderTab8(c);

    }

    // ------------------------
    // TAP1：學生快取（僅瀏覽）+ 玩家綁定（設定 DCID/is_admin）
    // ------------------------
    async function renderTab1(root){
      const bar = el('div', {class:'toolbar'});
      const syncBtn = el('button', {class:'btn'}, [document.createTextNode('↻ 從 A 專案同步：玩家 + 過審角色')]);
      const msg = el('span', {class:'muted'});
      bar.append(syncBtn, msg);

      // 左：學生快取
      const left = el('div', {class:'card grow'});
      left.append(el('div', {class:'row'}, [el('strong', {text:'學生快取（只讀）'}), el('span', {class:'chip', text:'student_cache'})] ));
      const leftTableWrap = el('div', {class:'table-wrap'});
      const leftTable = el('table');
      leftTable.innerHTML = `
      <colgroup>
      <col style="width: 10%;">
      <col style="width: 15%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
    </colgroup>
        <thead><tr>
          <th>student_id</th>
          <th>student_name</th>
          <th>player_id</th>
          <th>更新時間</th>
        </tr></thead><tbody id="t1-students"></tbody>`;
      leftTableWrap.append(leftTable); left.append(leftTableWrap);

      // 右：玩家綁定
      const right = el('div', {class:'card grow'});
      right.append(el('div', {class:'row'}, [el('strong', {text:'玩家綁定（DCID / 管理員）'}), el('span', {class:'chip', text:'player_links'})] ));
      const filter = el('input', {type:'text', placeholder:'搜尋玩家名稱/ID…', style:'min-width:200px'});
      const listBtn = el('button', {class:'btn secondary small'}, [document.createTextNode('重新載入')]);
      const rightBar = el('div', {class:'toolbar'}); rightBar.append(filter, listBtn);
      const rightTableWrap = el('div', {class:'table-wrap'});
      const rightTable = el('table');
      rightTable.innerHTML = `
      <colgroup>
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 5%;">
      <col style="width: 10%;">
    </colgroup>
        <thead><tr>
          <th>player_id</th>
          <th>玩家名稱</th>
          <th>DCID</th>
          <th>管理員</th>
          <th></th>
        </tr></thead><tbody id="t1-players"></tbody>`;
      rightTableWrap.append(rightTable); right.append(rightBar, rightTableWrap);

      const rowWrap = el('div', {class:'row'}); rowWrap.append(left, right);
      root.append(bar, rowWrap);

      // 同步：先確保 A 已登入
      syncBtn.addEventListener('click', async () => {
        syncBtn.disabled = true; msg.textContent = '檢查 A 專案登入狀態…';
        const ok = await ensureALogin();
        if (!ok) { msg.textContent = '已取消（未登入 A 專案）'; syncBtn.disabled = false; return; }

        msg.textContent = '同步中（讀 A → 寫 C）…';
        try {
          const players = await fetchAllPlayersFromA();
          const students = await fetchApprovedStudentsFromA();
          await upsertPlayersToC(players);
          await upsertStudentsToC(students);
          msg.textContent = `同步完成：玩家 ${players.length} 筆、過審角色 ${students.length} 筆。`;
          loadT1();
        } catch(e){ console.error(e); msg.textContent = '同步失敗：'+(e.message||e); }
        finally { syncBtn.disabled = false; }
      });

      listBtn.addEventListener('click', loadT1);
      filter.addEventListener('input', () => renderPlayersT1(window.__T1_PLAYERS || [], filter.value));

      async function loadT1(){
        await Promise.all([loadStudents(), loadPlayers()]);
      }
      async function loadStudents(){
        const { data, error } = await adminClient.from('student_cache').select('*').order('student_name', {ascending:true});
        const tb = $('#t1-students'); tb.innerHTML = '';
        if (error) { tb.innerHTML = `<tr><td colspan=4 class="err">讀取錯誤：${error.message}</td></tr>`; return; }
        (data||[]).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="mono">${r.student_id}</td><td>${r.student_name}</td><td class="mono">${r.player_id}</td><td>${fmtTime(r.updated_at)}</td>`;
          tb.appendChild(tr);
        });
      }
      async function loadPlayers(){
        const { data, error } = await adminClient.from('player_links').select('*').order('player_name',{ascending:true});
        if (error) { renderPlayersT1([], ''); return; }
        window.__T1_PLAYERS = data||[]; renderPlayersT1(window.__T1_PLAYERS, filter.value);
      }
      function renderPlayersT1(rows, q){
        const tb = $('#t1-players'); tb.innerHTML = '';
        const kw = (q||'').toLowerCase();
        rows.filter(r => !kw || (String(r.player_name||'').toLowerCase().includes(kw) || String(r.player_id||'').toLowerCase().includes(kw)))
            .forEach(r => tb.appendChild(playerRow(r)));
      }
      function playerRow(r){
        const tr = document.createElement('tr');
        const dc = el('input', {type:'text', value: r.discord_user_id || '', placeholder:'DCID'});
        const admin = el('input', {type:'checkbox'}); admin.checked = !!r.is_admin;
        const save = el('button', {class:'btn small'}, [document.createTextNode('儲存')]);
        const del = el('button', {class:'btn secondary small'}, [document.createTextNode('清空 DCID')]);
        tr.appendChild(el('td', {class:'mono', text:r.player_id}));
        tr.appendChild(el('td', {text:r.player_name||'-'}));
        const tdc = document.createElement('td'); tdc.appendChild(dc); tr.appendChild(tdc);
        const tadmin = document.createElement('td'); tadmin.appendChild(admin); tr.appendChild(tadmin);
        const tbtn = document.createElement('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);
        save.addEventListener('click', async () => {
          save.disabled = true;
          const { error } = await adminClient.from('player_links').update({ discord_user_id: dc.value||null, is_admin: admin.checked }).eq('player_id', r.player_id);
          save.disabled = false; if (!error) save.textContent='已儲存'; else save.textContent='失敗'; setTimeout(()=>save.textContent='儲存', 1200);
        });
        del.addEventListener('click', async () => {
          dc.value=''; await adminClient.from('player_links').update({ discord_user_id:null }).eq('player_id', r.player_id);
        });
        return tr;
      }

      // A 專案：抓全部玩家/過審角色
      async function fetchAllPlayersFromA(){
        const out=[]; let from=0, step=1000; while(true){
          const { data, error } = await aClient.from('players').select('player_id, username').range(from, from+step-1);
          if (error) throw error; if (!data || data.length===0) break; out.push(...data); if (data.length<step) break; from+=step;
        } return out;
      }
      async function fetchApprovedStudentsFromA(){
        const out=[]; let from=0, step=1000; while(true){
          const { data, error } = await aClient.from('students').select('student_id, name, player_id, student_code').not('student_code','is',null).order('name',{ascending:true}).range(from, from+step-1);
          if (error) throw error; if (!data || data.length===0) break; out.push(...data); if (data.length<step) break; from+=step;
        } return out;
      }
      async function upsertPlayersToC(rows){
        if (!rows.length) return; const payload = rows.map(x=>({ player_id: x.player_id, player_name: x.username }));
        const { error } = await adminClient.from('player_links').upsert(payload, { onConflict:'player_id' }); if (error) throw error;
      }
      async function upsertStudentsToC(rows){
        if (!rows.length) return; const payload = rows.map(x=>({ student_id: x.student_id, student_name: x.name, player_id: x.player_id }));
        const { error } = await adminClient.from('student_cache').upsert(payload, { onConflict:'student_id' }); if (error) throw error;
      }

      loadT1();
    }


// ------------------------
// TAP2：地區表 CRUD（支援多伺服器 + 型別篩選）
// ------------------------
async function renderTab2(root){
  const wrap = el('div', {class:'card'});

  // ===== 伺服器選擇列 =====
  const srvBar = el('div', {class:'toolbar'});
  const srvSel = document.createElement('select');
  const srvReload = el('button', {class:'btn secondary small'}, [document.createTextNode('重載伺服器')]);
  const srvInfo = el('span', {class:'muted'});
  srvBar.append(el('strong',{text:'伺服器'}), srvSel, srvReload, srvInfo);
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'地區管理'}),
    el('span',{class:'chip',text:'area（綁定伺服器）'})
  ]));
  wrap.append(srvBar);

  // ===== 型別篩選列（★ 新增） =====
  const typeBar = el('div', {class:'toolbar'});
  const typeFilter = document.createElement('select');
  typeFilter.appendChild(el('option',{value:'', text:'（全部型別）'}));
  AREA_TYPES.forEach(v => typeFilter.appendChild(el('option',{value:v, text:v})));
  typeBar.append(el('strong',{text:'顯示型別'}), typeFilter);
  wrap.append(typeBar);

  // ===== 新增區塊（受選定伺服器影響） =====
  const form = el('div', {class:'grid grid-4'});
  const f_name   = el('input', {type:'text', placeholder:'地區顯示名稱'});
  const f_type   = el('select'); AREA_TYPES.forEach(v=>f_type.appendChild(el('option',{value:v,text:v})));
  const f_chan   = el('input', {type:'text', placeholder:'Discord 頻道 ID（可空）'});
  const f_thread = el('input', {type:'text', placeholder:'Discord 討論串 ID（指定討論串互動 以此為主）'});
  const f_hook   = el('input', {type:'text', placeholder:'Webhook URL（可空）'});
  const f_limit  = el('input', {type:'number', placeholder:'每日上限（愛校用，可空）'});

  const f_mech_label = el('input', {type:'text', placeholder:'機制名稱（遊戲/特製才需要）'});
  const f_mech_code  = el('input', {type:'text', placeholder:'機制代碼（遊戲/特製才需要）'});
  const mechHint     = el('div', {class:'help', text:'只有型別為「遊戲」或「特製」時才會使用這兩個欄位'});

  const addBtn = el('button',{class:'btn'},[document.createTextNode('新增地區')]);
  form.append(f_name, f_type, f_chan, f_thread, f_hook, f_limit, f_mech_label, f_mech_code, addBtn);

  // 一覽表
  const list = el('div', {class:'table-wrap', style:'margin-top:10px'});
  list.innerHTML = `
     
    <table>
     <colgroup>
      <col style="width: 15%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 5%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
    </colgroup>
      <thead>
        <tr>
          <th>名稱</th>
          <th>型別</th>
          <th>頻道ID</th>
          <th>討論串ID</th>
          <th>Webhook</th>
          <th>上限(愛校服務)</th>
          <th>機制名稱（遊戲/特製）</th>
          <th>機制代碼（遊戲/特製）</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="areasBody"></tbody>
    </table>`;
  root.append(wrap, form, mechHint, list);

  // ===== 內部狀態 =====
  let CUR_SERVER = null;
  let SERVERS = [];
  let CUR_FILTER = ''; // ★ 目前型別篩選（'' = 全部）

  // ===== 輔助：切換機制欄顯示 =====
  function toggleCreateMechanicFields(){
    const on = isGameLike(f_type.value);
    f_mech_label.style.display = on ? '' : 'none';
    f_mech_code.style.display  = on ? '' : 'none';
    mechHint.style.display     = on ? 'block' : 'none';
  }
  f_type.addEventListener('change', toggleCreateMechanicFields);
  toggleCreateMechanicFields();

  // ===== 載入伺服器清單 =====
  async function loadServers(){
    const { data, error } = await adminClient
      .from('discord_servers')
      .select('server_id, server_name, is_active, updated_at')
      .order('server_name', {ascending:true});
    SERVERS = data || [];

    // 建立下拉
    srvSel.innerHTML = '';
    if (!SERVERS.length){
      const opt = document.createElement('option');
      opt.value = ''; opt.textContent = '（尚無伺服器，先到 Discord /ping 註冊）';
      srvSel.appendChild(opt);
      CUR_SERVER = null;
      srvInfo.textContent = '';
      addBtn.disabled = true;
      renderAreas([]);
      return;
    }
    SERVERS.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s.server_id;
      opt.textContent = `${s.server_name} (${s.server_id})${s.is_active ? '' : ' [停用]'}`;
      srvSel.appendChild(opt);
    });
    if (!CUR_SERVER || !SERVERS.find(s=>s.server_id===CUR_SERVER)){
      CUR_SERVER = SERVERS[0].server_id;
    }
    srvSel.value = CUR_SERVER;
    const cur = SERVERS.find(s=>s.server_id===CUR_SERVER);
    srvInfo.textContent = cur ? `目前伺服器：${cur.server_name}` : '';
    addBtn.disabled = !CUR_SERVER;

    // 維持現有型別篩選選項
    typeFilter.value = CUR_FILTER || '';
    await loadAreas();
  }

  srvSel.addEventListener('change', async ()=>{
    CUR_SERVER = srvSel.value || null;
    const cur = SERVERS.find(s=>s.server_id===CUR_SERVER);
    srvInfo.textContent = cur ? `目前伺服器：${cur.server_name}` : '';
    addBtn.disabled = !CUR_SERVER;
    await loadAreas(); // 會吃 CUR_FILTER
  });

  srvReload.addEventListener('click', loadServers);

  // ★ 型別篩選切換 → 只顯示該型別
  typeFilter.addEventListener('change', async ()=>{
    CUR_FILTER = typeFilter.value || '';
    await loadAreas();
  });

  // ===== 新增地區（會寫入 server_id） =====
  addBtn.addEventListener('click', async () => {
    if (!CUR_SERVER){ alert('請先選擇伺服器'); return; }
    addBtn.disabled = true;
    const body = {
      server_id:   CUR_SERVER,
      area_name:   f_name.value.trim(),
      area_type:   f_type.value,
      dc_channel_id: f_chan.value || null,
      dc_thread_id:  f_thread.value || null,
      webhook_url: f_hook.value || null,
      daily_limit: f_limit.value? Number(f_limit.value): null,
      mechanic_label: null,
      mechanic_code:  null
    };
    if (isGameLike(f_type.value)) {
      body.mechanic_label = (f_mech_label.value || null);
      body.mechanic_code  = (f_mech_code.value  || null);
    }
    const { error } = await adminClient.from('area').insert(body);
    addBtn.disabled = false;
    if (error){
      alert('新增失敗：' + (error.message||'')); return;
    }
    // 清空表單
    f_name.value=''; f_chan.value=''; f_thread.value=''; f_hook.value=''; f_limit.value='';
    f_mech_label.value=''; f_mech_code.value='';
    // ★ 重新載入並維持目前型別篩選
    await loadAreas();
  });

  // ===== 讀取 & 繪製地區（限定伺服器 + 型別篩選） =====
  async function loadAreas(){
    const tb = $('#areasBody'); tb.innerHTML='';
    if (!CUR_SERVER) return;

    let q = adminClient
      .from('area')
      .select('*')
      .eq('server_id', CUR_SERVER)
      .order('area_name',{ascending:true});

    // ★ 套用型別篩選
    if (CUR_FILTER) q = q.eq('area_type', CUR_FILTER);

    const { data, error } = await q;
    if (error){
      tb.innerHTML = `<tr><td colspan=9 class="err">讀取失敗：${error.message}</td></tr>`;
      return;
    }
    renderAreas(data || []);
  }

  function renderAreas(rows){
    const tb = $('#areasBody'); tb.innerHTML='';
    rows.forEach(r=>tb.appendChild(areaRow(r)));
  }

  function areaRow(r){
    const tr = document.createElement('tr');

    const name = el('input',{type:'text', value:r.area_name});
    const type = el('select'); AREA_TYPES.forEach(v=>{ 
      const o=el('option',{value:v,text:v}); 
      if(v===r.area_type) o.selected=true; 
      type.appendChild(o); 
    });

    const chan = el('input',{type:'text', value:r.dc_channel_id||''});
    const thrd = el('input',{type:'text', value:r.dc_thread_id||''});
    const hook = el('input',{type:'text', value:r.webhook_url||''});
    const lim  = el('input',{type:'number', value: r.daily_limit==null?'':r.daily_limit});

    const mechLabel = el('input',{type:'text', value: r.mechanic_label || ''});
    const mechCode  = el('input',{type:'text', value: r.mechanic_code  || ''});

    const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
    const del  = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

    const tdName = el('td',{},[name]);
    const tdType = el('td',{},[type]);
    const tdChan = el('td',{},[chan]);
    const tdThrd = el('td',{},[thrd]);
    const tdHook = el('td',{},[hook]);
    const tdLim  = el('td',{},[lim]);
    const tdMechLabel = el('td',{},[mechLabel]);
    const tdMechCode  = el('td',{},[mechCode]);
    const tbtn = el('td'); tbtn.append(save,' ',del);

    tr.append(tdName, tdType, tdChan, tdThrd, tdHook, tdLim, tdMechLabel, tdMechCode, tbtn);

    // 顯示切換（遊戲/特製才顯示機制）
    function toggleRowMechanic(){
      const on = isGameLike(type.value);
      tdMechLabel.style.display = on ? '' : 'none';
      tdMechCode.style.display  = on ? '' : 'none';
    }
    toggleRowMechanic();
    type.addEventListener('change', toggleRowMechanic);

    // 儲存（★ 儲存後重新載入，維持篩選）
    save.addEventListener('click', async ()=>{
      save.disabled=true;
      const body = {
        area_name:   name.value.trim(),
        area_type:   type.value,
        dc_channel_id: chan.value || null,
        dc_thread_id:  thrd.value || null,
        webhook_url: hook.value || null,
        daily_limit: lim.value ? Number(lim.value) : null,
        mechanic_label: null,
        mechanic_code:  null
      };
      if (isGameLike(type.value)) {
        body.mechanic_label = mechLabel.value || null;
        body.mechanic_code  = mechCode.value  || null;
      }
      const { error } = await adminClient.from('area').update(body).eq('area_id', r.area_id);
      save.disabled=false;
      if(!error){
        // 若型別被改到不符合目前篩選，重新載入後該列會自動消失
        await loadAreas();
      }
    });

    // 刪除（★ 刪除後重新載入，維持篩選）
    del.addEventListener('click', async ()=>{
      if (!confirm('確定刪除？')) return;
      const { error } = await adminClient.from('area').delete().eq('area_id', r.area_id);
      if (!error) await loadAreas();
    });

    return tr;
  }

  // 初始載入
  await loadServers();
}



// ------------------------
// TAP3：倍率管理（正確使用中文 enum 值）
// ------------------------
async function renderTab3(root){
  const wrap = el('div',{class:'card'});

  // 三個輸入框
  const f_work = el('input',{type:'number', min:0, placeholder:'一般打工｜每小時 → 一般貨幣（例：100）'});
  const f_spec = el('input',{type:'number', min:0, placeholder:'特殊打工｜每小時 → 謝爾夏貨幣（例：5）'});
  const f_svc  = el('input',{type:'number', min:0, placeholder:'愛校服務｜每次 → 愛校點數（例：1）'});

  const save = el('button',{class:'btn'},[document.createTextNode('儲存倍率')]);
  const reload = el('button',{class:'btn secondary'},[document.createTextNode('重新載入')]);
  const info = el('span',{class:'muted'});  // 讓它能換行 ↓
  info.style.whiteSpace = 'pre-line';

  wrap.append(
    el('div',{class:'row'},[
      el('strong',{text:'倍率管理'}),
      el('span',{class:'chip',text:'earn_current_rate（每種 kind 一行）'})
    ])
  );

  const grid = el('div',{class:'grid grid-4'});
  grid.append(f_work, f_spec, f_svc, save, reload);
  wrap.append(grid);

  const help = el('div',{class:'help'});
  help.innerHTML = `
    <ul style="margin:8px 0 0 18px;">
      <li>一般打工（${EARN_KIND.work}）：每小時給 <b>一般貨幣</b></li>
      <li>特殊打工（${EARN_KIND.special}）：每小時給 <b>謝爾夏貨幣</b></li>
      <li>愛校服務（${EARN_KIND.service}）：每次給 <b>愛校點數</b></li>
    </ul>
  `;
  wrap.append(help, info);
  root.append(wrap);

  const CUR = { work:'一般貨幣', special:'謝爾夏貨幣', service:'愛校點數' };

  function renderPreview(){
    const w = Number(f_work.value||0),
          s = Number(f_spec.value||0),
          p = Number(f_svc.value||0);
    info.textContent =
      `一般打工：+${w} ${CUR.work}／h\n` +
      `特殊打工：+${s} ${CUR.special}／h\n` +
      `愛校服務：+${p} ${CUR.service}／次`;
  }

  async function load(){
    const { data, error } = await adminClient
      .from('earn_current_rate')
      .select('kind, rate, currency');

    if (error) { info.textContent = '讀取失敗：' + (error.message || ''); return; }

    // 預設值
    let w=0, s=0, p=0;
    (data||[]).forEach(r=>{
      if (r.kind === EARN_KIND.work)    w = r.rate;
      if (r.kind === EARN_KIND.special) s = r.rate;
      if (r.kind === EARN_KIND.service) p = r.rate;
    });
    f_work.value = w; f_spec.value = s; f_svc.value = p;
    renderPreview();
  }

  f_work.addEventListener('input', renderPreview);
  f_spec.addEventListener('input', renderPreview);
  f_svc.addEventListener('input',  renderPreview);

  save.addEventListener('click', async ()=>{
    save.disabled = true;
    const rows = [
      { kind: EARN_KIND.work,    rate: Number(f_work.value||0), currency: CUR.work },
      { kind: EARN_KIND.special, rate: Number(f_spec.value||0), currency: CUR.special },
      { kind: EARN_KIND.service, rate: Number(f_svc.value ||0), currency: CUR.service }
    ];
    const { error } = await adminClient
      .from('earn_current_rate')
      .upsert(rows, { onConflict: 'kind' });
    save.disabled = false;
    if (error) { info.textContent = '儲存失敗：' + (error.message||''); return; }
    info.textContent = '已儲存。';
    load();
  });

  reload.addEventListener('click', load);
  load();
}


// ------------------------
// TAP4：販售道具（分類篩選、圖片彈窗、戰鬥欄位移到倒數第二、簡介/效果用 textarea）
// ------------------------
async function renderTab4(root){
  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'販售道具 (三大分類商品分別一次只能上架24個 下價請把庫存設定成0 勿刪除)'}),
    el('span',{class:'chip',text:'shop_items'})
  ]));

  // === 新增商品（不含「戰鬥用品」；預設 is_battle_item=false） ===
  const f = el('div',{class:'grid grid-4'});
  const f_name  = el('input',{type:'text',  placeholder:'道具名稱'});
  const f_desc  = el('input',{type:'text',  placeholder:'商家/商品簡介 請幫我-# 開頭 我懶得改程式碼> <'});
  const f_type  = el('select'); CURRENCIES.forEach(v=>f_type.appendChild(el('option',{value:v,text:v})));
  const f_price = el('input',{type:'number',placeholder:'售價'});
  const f_stock = el('input',{type:'number',placeholder:'庫存'});
  const f_effect= el('input',{type:'text',  placeholder:'效果文字（可空）'});
  const f_code  = el('input',{type:'text',  placeholder:'effect_code（可空）'});
  const f_uses  = el('input',{type:'number',placeholder:'可用次數（空=永久）'});
  const add = el('button',{class:'btn'},[document.createTextNode('新增')]);
  f.append(f_name,f_desc,f_type,f_price,f_stock,f_effect,f_code,f_uses,add);

  // === 工具列：分類篩選 ===
  const tool = el('div',{class:'toolbar'});
  const filterSel = document.createElement('select');
  [['','（全部）'], ['一般貨幣','一般貨幣商品'], ['謝爾夏貨幣','謝爾夏幣商品'], ['愛校點數','愛校點數商品']]
    .forEach(([val,lab])=> filterSel.appendChild(el('option',{value:val,text:lab})));
  const reloadBtn = el('button',{class:'btn secondary small'},[document.createTextNode('重新載入')]);
  const toolMsg = el('span',{class:'muted'});
  tool.append(el('strong',{text:'篩選'}), filterSel, reloadBtn, toolMsg);

  // === 列表 ===
  const list = el('div',{class:'table-wrap', style:'margin-top:10px'});
  list.innerHTML = `
    <table>
         <colgroup>
      <col style="width: 15%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 5%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
    </colgroup>
      <thead>
        <tr>
          <th>名稱</th>
          <th>簡介</th>
          <th>幣別</th>
          <th>售價</th>
          <th>庫存</th>
          <th>效果</th>
          <th>程式碼</th>
          <th>可用次數</th>
          <th>戰鬥</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="shopBody"></tbody>
    </table>`;
  wrap.append(f, tool, list);
  root.append(wrap);

  // ========= 圖片彈窗（沿用、可重用） =========
  let IMG_MODAL = null;
  function ensureImgModalDOM(){
    if (IMG_MODAL) return IMG_MODAL;
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div id="imgUrlMask" class="modal-mask" aria-hidden="true" style="display:none;">
        <div class="modal">
          <div class="close-x" id="imgClose">✕</div>
          <h3>商品圖片</h3>
          <div class="field">
            <label>圖片網址</label>
            <input id="imgUrlInput" type="text" placeholder="https://…" />
            <div class="help">貼上可直接存取的圖片網址，下方會即時預覽。留空按「確定」可清除圖片。</div>
          </div>
          <div class="field">
            <div style="border:1px solid #e6eef6;border-radius:8px;padding:8px;background:#f9fbff;text-align:center;">
              <img id="imgPreview" alt="預覽" style="max-width:100%;max-height:260px;display:none;" />
              <div id="imgPreviewEmpty" class="muted">（尚無圖片）</div>
            </div>
          </div>
          <div class="row">
            <span class="msg" id="imgMsg"></span>
            <button class="btn secondary" id="imgCancel">取消</button>
            <button class="btn" id="imgSave">確定</button>
          </div>
        </div>
      </div>
    `.trim();
    document.body.appendChild(wrap.firstElementChild);

    const mask   = document.getElementById('imgUrlMask');
    const input  = document.getElementById('imgUrlInput');
    const pv     = document.getElementById('imgPreview');
    const empty  = document.getElementById('imgPreviewEmpty');
    const msg    = document.getElementById('imgMsg');
    const save   = document.getElementById('imgSave');
    const cancel = document.getElementById('imgCancel');
    const closeX = document.getElementById('imgClose');

    function setPreview(url){
      if (url){ pv.src=url; pv.style.display='block'; empty.style.display='none'; }
      else { pv.removeAttribute('src'); pv.style.display='none'; empty.style.display='block'; }
    }
    pv.onerror = () => { msg.textContent='圖片載入失敗，請確認網址。'; pv.style.display='none'; empty.style.display='block'; };
    input.addEventListener('input', ()=>{ msg.textContent=''; setPreview(input.value.trim()); });

    function show(){ mask.style.display='flex'; mask.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(),0); }
    function hide(){ mask.style.display='none'; mask.setAttribute('aria-hidden','true'); msg.textContent=''; }

    closeX.addEventListener('click', hide);
    cancel.addEventListener('click', hide);

    IMG_MODAL = { show, hide, input, setPreview, msg, save };
    return IMG_MODAL;
  }
  function openImgModalForRow(row){
    const m = ensureImgModalDOM();
    m.input.value = row.img_url || '';
    m.setPreview(m.input.value);
    m.msg.textContent = '';
    if (m._saveHandler) m.save.removeEventListener('click', m._saveHandler);
    m._saveHandler = async () => {
      m.save.disabled = true; m.msg.textContent = '儲存中…';
      const url = (m.input.value || '').trim() || null;
      const { error } = await adminClient.from('shop_items').update({ img_url: url }).eq('id', row.id);
      m.save.disabled = false;
      if (error){ m.msg.textContent = '儲存失敗：' + (error.message||''); return; }
      row.img_url = url; m.hide();
    };
    m.save.addEventListener('click', m._saveHandler);
    m.show();
  }

  // === 新增 ===
  add.addEventListener('click', async ()=>{
    add.disabled=true;
    const body={
      item_name:  f_name.value.trim(),
      shop_desc:  f_desc.value || null,
      price_type: f_type.value,
      price:      Number(f_price.value||0),
      stock:      Number(f_stock.value||0),
      item_effect:f_effect.value || null,
      effect_code:f_code.value || null,
      max_uses:   f_uses.value ? Number(f_uses.value) : null,
      // 不送 is_battle_item → 後端預設 false
    };
    const { error } = await adminClient.from('shop_items').insert(body);
    add.disabled=false;
    if(!error){
      f_name.value=f_desc.value=f_effect.value=f_code.value='';
      f_price.value=f_stock.value=f_uses.value='';
      load(); // 依當前篩選重載
    } else {
      toolMsg.textContent = '新增失敗：' + (error.message||'');
    }
  });

  reloadBtn.addEventListener('click', ()=> load());
  filterSel.addEventListener('change', ()=> load());

  // === 載入 & 繪製（支援分類篩選） ===
  async function load(){
    const type = filterSel.value; // ''=全部 或 幣別
    let q = adminClient.from('shop_items').select('*').order('item_name',{ascending:true});
    if (type) q = q.eq('price_type', type);
    const { data, error } = await q;
    const tb = $('#shopBody'); tb.innerHTML='';
    if (error){ tb.innerHTML = `<tr><td colspan=10 class="err">讀取失敗：${error.message}</td></tr>`; return; }
    (data||[]).forEach(r=>tb.appendChild(row(r)));
    toolMsg.textContent = type ? `只顯示：${type}` : '顯示全部';
  }

  function row(r){
    const tr = document.createElement('tr');

    const name  = el('input',{type:'text', value:r.item_name});

    // ★ 簡介 textarea（可放大）
    const descArea = document.createElement('textarea');
    descArea.value = r.shop_desc || '';
    descArea.style.minHeight = '80px';
    descArea.style.resize = 'vertical';

    const type  = el('select'); 
    CURRENCIES.forEach(v=>{ 
      const o=el('option',{value:v,text:v}); 
      if(v===r.price_type) o.selected=true; 
      type.appendChild(o);
    });

    const price = el('input',{type:'number', value:r.price});
    const stock = el('input',{type:'number', value:r.stock});

    // ★ 效果 textarea（可放大）
    const effArea = document.createElement('textarea');
    effArea.value = r.item_effect || '';
    effArea.style.minHeight = '80px';
    effArea.style.resize = 'vertical';

    const code  = el('input',{type:'text', value:r.effect_code||''});
    const uses  = el('input',{type:'number', value: r.max_uses==null?'':r.max_uses});

    // ★ 戰鬥用品（移到操作前一格）
    const battle = el('input',{type:'checkbox'}); 
    battle.checked = !!r.is_battle_item;

    const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
    const img  = el('button',{class:'btn secondary small'},[document.createTextNode('圖片')]);
    const del  = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

    tr.append(
      el('td',{},[name]),
      el('td',{},[descArea]),
      el('td',{},[type]),
      el('td',{},[price]),
      el('td',{},[stock]),
      el('td',{},[effArea]),
      el('td',{},[code]),
      el('td',{},[uses]),
      el('td',{},[battle]) // 戰鬥用品放在按鈕前一格
    );
    const tbtn = el('td'); tbtn.append(save,' ',img,' ',del); tr.appendChild(tbtn);

    save.addEventListener('click', async()=>{
      save.disabled=true;
      const body={
        item_name:   name.value.trim(),
        shop_desc:   descArea.value || null,     // ★ textarea
        price_type:  type.value,
        price:       Number(price.value||0),
        stock:       Number(stock.value||0),
        item_effect: effArea.value || null,      // ★ textarea
        effect_code: code.value || null,
        max_uses:    uses.value ? Number(uses.value) : null,
        is_battle_item: !!battle.checked
      };
      const { error } = await adminClient.from('shop_items').update(body).eq('id', r.id);
      save.disabled=false;
      if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
    });

    img.addEventListener('click', ()=> openImgModalForRow(r));

    del.addEventListener('click', async()=>{
      if(!confirm('確定刪除？')) return;
      const { error } = await adminClient.from('shop_items').delete().eq('id', r.id);
      if(!error) tr.remove();
    });

    return tr;
  }

  // 初次載入
  load();
}
// ------------------------
// TAP4SPSHOP：其他商店（SPSHOP 分店庫存管理）
// - 下拉選「已設定 mechanic_code=spshop 的地區」
// - 選幣別 → 選該幣別商品 → 輸入庫存 → 儲存（upsert special_shop_stock）
// - 下方列表只顯示「當前選取地區」的上架商品，可即時改庫存或刪除該品項
// ------------------------
async function renderTab4Spshop(root){
  // 讀所有商品（拿來依幣別篩選）
  const ALL_ITEMS = await loadShopItems(); // [{item_name, price_type, price, stock}, ...]
  const itemByName = new Map(ALL_ITEMS.map(i => [i.item_name, i]));

  // 抓已設定 spshop 的地區
  const { data: AREAS, error: aErr } = await adminClient
    .from('area')
    .select('area_id, area_name')
    .eq('area_type','特製')
    .eq('mechanic_code','spshop')
    .order('area_name',{ascending:true});

  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'其他商店（SPSHOP 分店庫存）'}),
    el('span',{class:'chip',text:'special_shop_stock'})
  ]));

  // ---- 表頭控件：地區 + 幣別 + 商品 + 庫存 + 儲存
  const form = el('div',{class:'grid grid-4'});

  const f_area = document.createElement('select');
  if (!AREAS || AREAS.length===0){
    const o = document.createElement('option');
    o.value=''; o.textContent='（尚無 SPSHOP 地區，請先到「地區表」建立 特製＋mechanic_code=spshop）';
    f_area.appendChild(o);
  }else{
    AREAS.forEach(a => f_area.appendChild(el('option',{value:a.area_id, text:a.area_name})));
  }

  const f_curr = document.createElement('select');
  f_curr.appendChild(el('option',{value:'', text:'（選幣別）'}));
  CURRENCIES.forEach(v => f_curr.appendChild(el('option',{value:v, text:v})));

  const f_item = document.createElement('select');
  f_item.appendChild(el('option',{value:'', text:'（先選幣別）'}));

  const f_stock = el('input',{type:'number', placeholder:'庫存（0=售罄）', min:0});
  const btnSave = el('button',{class:'btn'},[document.createTextNode('上架／更新')]);
  const msg = el('span',{class:'muted'});

  form.append(
    el('div',{},[el('strong',{text:'分店（SPSHOP 地區）'}), f_area]),
    el('div',{},[el('strong',{text:'幣別'}), f_curr]),
    el('div',{},[el('strong',{text:'商品（依幣別）'}), f_item]),
    el('div',{},[el('strong',{text:'庫存'}), f_stock]),
    btnSave
  );
  wrap.append(form, msg);

  // ---- 列表：只顯示目前分店的上架商品
  const list = el('div',{class:'table-wrap', style:'margin-top:10px'});
  list.innerHTML = `

    <table>
          <colgroup>
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 25%;">
      <col style="width: 8%;">
    </colgroup>
      <thead>
        <tr>
          <th>商品名稱</th>
          <th>幣別</th>
          <th>單價</th>
          <th>店內庫存</th><
          th>更新時間</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="spshopBody"></tbody>
    </table>`;
  root.append(wrap, list);

  // ---- 幫助函式
  function fillItemsByCurrency(){
    const cat = f_curr.value;
    f_item.innerHTML = '';
    if (!cat){
      f_item.appendChild(el('option',{value:'', text:'（先選幣別）'}));
      return;
    }
    f_item.appendChild(el('option',{value:'', text:'（選擇商品）'}));
    ALL_ITEMS
      .filter(i => i.price_type === cat)
      .sort((a,b) => a.item_name.localeCompare(b.item_name,'zh-Hant'))
      .forEach(i => {
        const label = `${i.item_name}｜${i.price_type} ${i.price}`;
        f_item.appendChild(el('option',{value:i.item_name, text:label}));
      });
  }

  async function preloadStockForSelection(){
    // 選了地區 + 商品 → 查是否已上架，若有就帶出庫存
    const areaId = f_area.value, itemName = f_item.value;
    if (!areaId || !itemName){ f_stock.value=''; return; }
    const { data } = await adminClient
      .from('special_shop_stock')
      .select('stock')
      .eq('area_id', areaId)
      .eq('item_name', itemName)
      .maybeSingle();
    f_stock.value = data?.stock ?? '';
  }

  async function loadAreaStockList(){
  const tb = document.getElementById('spshopBody'); 
  tb.innerHTML='';
  const areaId = f_area.value;
  if (!areaId){ 
    tb.innerHTML = `<tr><td colspan="6" class="muted">請先選擇分店。</td></tr>`;
    return;
  }

  // 讀該分店已上架的商品（JOIN shop_items 拿幣別與單價）
  const { data, error } = await adminClient
    .from('special_shop_stock')
    .select(`item_name, stock, updated_at, shop_items(price, price_type)`)
    .eq('area_id', areaId)
    .order('item_name',{ascending:true});

  if (error){
    tb.innerHTML = `<tr><td colspan="6" class="err">${error.message}</td></tr>`;
    return;
  }

  // ← 這裡新增幣別篩選（有選幣別就只顯示該幣別）
  const cat = f_curr.value; // '' 代表不篩選
  const rows = (data || []).filter(r => {
    if (!cat) return true;
    const priceType = r.shop_items?.price_type || (itemByName.get(r.item_name)?.price_type ?? null);
    return priceType === cat;
  });

  if (!rows.length){
    tb.innerHTML = `<tr><td colspan="6" class="muted">沒有符合的商品${cat ? `（已套用幣別：${cat}）` : ''}。</td></tr>`;
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const priceType = r.shop_items?.price_type || (itemByName.get(r.item_name)?.price_type ?? '-');
    const price     = r.shop_items?.price ?? (itemByName.get(r.item_name)?.price ?? '-');

    const stockInput = el('input',{type:'number', min:0, value:String(r.stock)});
    stockInput.style.width = '110px';

    const btnUpdate = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
    const btnDel    = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

    tr.innerHTML = `
      <td>${r.item_name}</td>
      <td>${priceType}</td>
      <td class="mono">${price}</td>
    `;
    const tdStock = document.createElement('td'); tdStock.appendChild(stockInput);
    const tdTime  = document.createElement('td'); tdTime.textContent = fmtTime(r.updated_at);
    const tdBtn   = document.createElement('td'); tdBtn.append(btnUpdate, ' ', btnDel);
    tr.appendChild(tdStock); tr.appendChild(tdTime); tr.appendChild(tdBtn);
    tb.appendChild(tr);

    btnUpdate.addEventListener('click', async ()=>{
      btnUpdate.disabled=true;
      const newStock = Math.max(0, Number(stockInput.value||0));
      const { error } = await adminClient
        .from('special_shop_stock')
        .update({ stock: newStock })
        .eq('area_id', areaId)
        .eq('item_name', r.item_name);
      btnUpdate.disabled=false;
      if (!error){ btnUpdate.textContent='已儲存'; setTimeout(()=>btnUpdate.textContent='儲存', 900); loadAreaStockList(); }
    });

    btnDel.addEventListener('click', async ()=>{
      if (!confirm(`刪除上架「${r.item_name}」？`)) return;
      const { error } = await adminClient
        .from('special_shop_stock')
        .delete()
        .eq('area_id', areaId)
        .eq('item_name', r.item_name);
      if (!error) tr.remove();
    });
  });
}


  // ---- 事件
f_curr.addEventListener('change', ()=>{ 
  fillItemsByCurrency(); 
  f_stock.value=''; 
  loadAreaStockList();   // ← 幣別切換時也刷新下方列表
});
  f_item.addEventListener('change', preloadStockForSelection);
  f_area.addEventListener('change', ()=>{ preloadStockForSelection(); loadAreaStockList(); });

  btnSave.addEventListener('click', async ()=>{
    btnSave.disabled = true; msg.textContent = '處理中…';
    try{
      const areaId = f_area.value;
      const curr   = f_curr.value;
      const item   = f_item.value;
      const stockV = Number(f_stock.value || 0);

      if (!areaId) throw new Error('請先選擇分店地區');
      if (!curr)   throw new Error('請先選擇幣別');
      if (!item)   throw new Error('請選擇商品');
      if (!Number.isFinite(stockV) || stockV < 0) throw new Error('庫存需為 0 或正整數');

      // upsert: (area_id, item_name) 唯一鍵
      const payload = { area_id: areaId, item_name: item, stock: stockV };
      const { error } = await adminClient
        .from('special_shop_stock')
        .upsert(payload, { onConflict: 'area_id,item_name' });
      if (error) throw error;

      msg.textContent = '已上架／更新。';
      await loadAreaStockList();
      await preloadStockForSelection(); // 回填最新庫存
    }catch(e){
      msg.textContent = '失敗：' + (e.message || e);
    }finally{
      btnSave.disabled = false;
    }
  });

  // ---- 初始
  fillItemsByCurrency();
  if (AREAS && AREAS.length){
    f_area.value = AREAS[0].area_id;
    await loadAreaStockList();
  }
}

// ===== TAP：贈送道具（依幣別→選道具→選學生；數量可負=回收）=====
async function renderTab4Gift(root){
  await loadStudentNames(); // 用你既有的學生下拉

  // 先把所有商品抓一次；之後用幣別篩選
  let ALL_ITEMS = await loadShopItems(); // [{item_name, price_type, price, stock}...]

  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'贈送道具'}),
    el('span',{class:'chip',text:'inventory & transaction_log'})
  ]));

  // 表單
  const form = el('div',{class:'grid grid-4'});

  // 1) 幣別分類
  const f_curr = document.createElement('select');
  f_curr.appendChild(el('option',{value:'', text:'（先選幣別）'}));
  CURRENCIES.forEach(v=> f_curr.appendChild(el('option',{value:v, text:v})));

  // 2) 道具（依幣別動態填入）
  const f_item = document.createElement('select');
  f_item.appendChild(el('option',{value:'', text:'（請先選幣別）'}));

  // 3) 對象（學生）
  const f_student = makeStudentSelect();

  // 4) 數量（可負值=回收）
  const f_qty = el('input',{type:'number', step:'1', placeholder:'數量（可負值=回收）'});
  f_qty.value = 1;

  // 顯示持有量
  const ownedBox = el('div',{class:'help', text:'持有數量：-'});

  // 送出
  const btn = el('button',{class:'btn'},[document.createTextNode('確認')]);
  const msg = el('span',{class:'muted'});

  form.append(
    el('div',{},[el('strong',{text:'幣別'}), f_curr]),
    el('div',{},[el('strong',{text:'道具'}), f_item]),
    el('div',{},[el('strong',{text:'對象'}), f_student]),
    el('div',{},[el('strong',{text:'數量（可負）'}), f_qty]),
    btn
  );
  wrap.append(form, ownedBox, msg);
  root.append(wrap);

  // 幫助函式：依幣別填入道具清單
  function fillItemsByCurrency(){
    const cat = f_curr.value;
    f_item.innerHTML = '';
    if (!cat){
      f_item.appendChild(el('option',{value:'', text:'（請先選幣別）'}));
      return;
    }
    f_item.appendChild(el('option',{value:'', text:'（選擇道具）'}));
    ALL_ITEMS
      .filter(i => i.price_type === cat)
      .sort((a,b)=> a.item_name.localeCompare(b.item_name,'zh-Hant'))
      .forEach(i => f_item.appendChild(el('option',{value:i.item_name, text:i.item_name})));
  }

  // 讀取學生持有量
  async function refreshOwned(){
    const student = f_student.value;
    const item = f_item.value;
    if (!student || !item){ ownedBox.textContent = '持有數量：-'; return; }
    const { data, error } = await adminClient
      .from('inventory')
      .select('id, amount')
      .eq('student_name', student)
      .eq('item_name', item)
      .maybeSingle();
    const amt = data?.amount ?? 0;
    ownedBox.textContent = `持有數量：${amt}`;
  }

  // 送出邏輯（這段才是你原本壞掉的地方，下面補齊 try/catch/finally）
  btn.addEventListener('click', async ()=>{
    btn.disabled = true; msg.textContent = '處理中…';
    try{
      const curr    = f_curr.value;
      const item    = f_item.value;
      const student = f_student.value;
      const qty     = Number(f_qty.value || 0);

      if (!curr)    throw new Error('請先選幣別');
      if (!item)    throw new Error('請選擇道具');
      if (!student) throw new Error('請選擇對象');
      if (!Number.isFinite(qty) || qty === 0) throw new Error('數量不可為 0');

      // 先查目前持有量
      const { data: row, error: qErr } = await adminClient
        .from('inventory')
        .select('id, amount')
        .eq('student_name', student)
        .eq('item_name', item)
        .maybeSingle();
      if (qErr) throw qErr;

      const curAmt = row?.amount ?? 0;
      const newAmt = curAmt + qty;

      // 不允許變成負數
      if (newAmt < 0){
        throw new Error(`持有不足，最多可回收 ${curAmt}。`);
      }

      // 寫入 inventory
      if (row){ // 原本有
        if (newAmt === 0){
          const { error } = await adminClient
            .from('inventory')
            .delete()
            .eq('id', row.id);
          if (error) throw error;
        }else{
          const { error } = await adminClient
            .from('inventory')
            .update({ amount: newAmt })
            .eq('id', row.id);
          if (error) throw error;
        }
      }else{ // 原本沒有 → 只能是贈送（qty>0）
        if (qty < 0) throw new Error('該角色尚未持有此道具，無法回收。');
        const { error } = await adminClient
          .from('inventory')
          .insert({ student_name: student, item_name: item, amount: qty });
        if (error) throw error;
      }

     

      msg.textContent = '已送出！';
      await refreshOwned(); // 重新查詢持有量
    } catch(e){
      msg.textContent = '失敗：'+(e.message||e);
    } finally {
      btn.disabled = false;
    }
  });

  // 綁定事件
  f_curr.addEventListener('change', ()=>{ fillItemsByCurrency(); refreshOwned(); });
  f_item.addEventListener('change', refreshOwned);
  f_student.addEventListener('change', refreshOwned);

  // 初始
  fillItemsByCurrency();
  refreshOwned();
}


   // ------------------------
// TAP5：戰鬥攜帶物（學生名稱下拉 + 文案可伸縮）
// ------------------------
async function renderTab5(root){
  await loadStudentNames();
  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'戰鬥攜帶物'}),
    el('span',{class:'chip',text:'battle_items'})
  ]));

  const f = el('div',{class:'grid grid-4'});
  const f_student = makeStudentSelect();
  const f_slot = el('input',{type:'number', placeholder:'欄位 1-4', min:1, max:4});

  // ★ 改成 textarea：裝備名稱
  const f_name = document.createElement('textarea');
  f_name.placeholder = '裝備名稱（可多行）';
  f_name.style.minHeight = '80px';
  f_name.style.resize = 'vertical';

  // ★ 改成 textarea：效果文字
  const f_effect = document.createElement('textarea');
  f_effect.placeholder = '效果文字（可多行，可空）';
  f_effect.style.minHeight = '80px';
  f_effect.style.resize = 'vertical';

  const f_uses = el('input',{type:'number', placeholder:'剩餘可用次數（空=永久）'});
  const f_lock = el('select'); ['false','true'].forEach(v=>f_lock.appendChild(el('option',{value:v,text: v==='true'?'裝備後鎖定':'可回收'})));
  const add = el('button',{class:'btn'},[document.createTextNode('新增')]);
  f.append(f_student,f_slot,f_name,f_effect,f_uses,f_lock,add);

  const list = el('div',{class:'table-wrap',style:'margin-top:10px'});
  list.innerHTML = `

    <table>
          <colgroup>
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 25%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
    </colgroup>
      <thead>
        <tr>
        <th>角色</th>
        <th>欄位</th>
        <th>裝備</th>
        <th>效果</th
        ><th>可用次數</th>
        <th>鎖定</th>
        <th></th>
        
        </tr>
      </thead>
      <tbody id="battleBody"></tbody>
    </table>`;
  wrap.append(f,list);
  root.append(wrap);

  add.addEventListener('click', async ()=>{
    add.disabled=true;
    const body={
      student_name: f_student.value,
      slot:Number(f_slot.value||0),
      item_name:f_name.value.trim(),
      item_effect:f_effect.value||null,
      uses_left: f_uses.value? Number(f_uses.value): null,
      locked_until_broken: f_lock.value==='true'
    };
    const { error } = await adminClient.from('battle_items').insert(body);
    add.disabled=false;
    if(!error){
      f_slot.value=''; f_name.value=''; f_effect.value=''; f_uses.value='';
      load();
    }
  });

  async function load(){
    const { data } = await adminClient
      .from('battle_items')
      .select('*')
      .order('student_name',{ascending:true})
      .order('slot',{ascending:true});
    const tb=$('#battleBody'); tb.innerHTML='';
    (data||[]).forEach(r=>tb.appendChild(row(r)));
  }

  function row(r){
    const tr = document.createElement('tr');
    const stu = makeStudentSelect(r.student_name);
    const slot = el('input',{type:'number', value:r.slot, min:1, max:4});

    // ★ 改成 textarea：裝備名稱
    const name = document.createElement('textarea');
    name.value = r.item_name || '';
    name.style.minHeight = '80px';
    name.style.resize = 'vertical';

    // ★ 改成 textarea：效果文字
    const eff = document.createElement('textarea');
    eff.value = r.item_effect || '';
    eff.style.minHeight = '80px';
    eff.style.resize = 'vertical';

    const uses = el('input',{type:'number', value: r.uses_left==null?'':r.uses_left});
    const lock = el('select'); ['false','true'].forEach(v=>{
      const o=el('option',{value:v,text: v==='true'?'鎖定':'可回收'});
      if(String(r.locked_until_broken)===v) o.selected=true;
      lock.appendChild(o);
    });

    const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
    const del = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

    tr.append(
      el('td',{},[stu]),
      el('td',{},[slot]),
      el('td',{},[name]),
      el('td',{},[eff]),
      el('td',{},[uses]),
      el('td',{},[lock])
    );
    const tbtn=el('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);

    save.addEventListener('click', async()=>{
      save.disabled=true;
      const body={
        student_name: stu.value,
        slot:Number(slot.value||0),
        item_name:name.value.trim(),
        item_effect:eff.value||null,
        uses_left: uses.value? Number(uses.value): null,
        locked_until_broken: lock.value==='true'
      };
      const { error } = await adminClient.from('battle_items').update(body).eq('id', r.id);
      save.disabled=false;
      if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
    });

    del.addEventListener('click', async()=>{
      if(!confirm('確定刪除？')) return;
      const { error } = await adminClient.from('battle_items').delete().eq('id', r.id);
      if(!error) tr.remove();
    });

    return tr;
  }

  load();
}


   // ------------------------
// TAP6：教師文本（僅顯示選取的教室）
// ------------------------
async function renderTab6(root){
  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'教師文本'}),
    el('span',{class:'chip',text:'teacher_texts'})
  ]));

  // 先抓【學習】地區
  const { data: areas } = await adminClient
    .from('area')
    .select('area_id, area_name')
    .eq('area_type','學習')
    .order('area_name',{ascending:true});

  const areaMap = new Map((areas||[]).map(a=>[a.area_id, a.area_name]));

  // 表單（同時也是列表的篩選條件）
  const f = el('div',{class:'grid grid-4'});
  const f_area = el('select');
  (areas||[]).forEach(a => f_area.appendChild(el('option',{value:a.area_id, text:a.area_name})));
  const f_course = el('input',{type:'text', placeholder:'課程名稱'});
  const f_text   = el('textarea',{placeholder:'老師回應內容（台詞）'});
  const add      = el('button',{class:'btn'},[document.createTextNode('新增')]);
  f.append(f_area,f_course,f_text,add);

  const list = el('div',{class:'table-wrap',style:'margin-top:10px'});
  list.innerHTML = `

    <table>
            <colgroup>
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 8%;">
    </colgroup>
      <thead>
      <tr>
        <th>地區</th>
        <th>課程</th>
        <th>台詞</th>
        <th></th>
      </tr></thead>
      <tbody id="teacherBody"></tbody>
    </table>`;
  wrap.append(f, list);
  root.append(wrap);

  // 新增（寫入目前選到的教室）
  add.addEventListener('click', async ()=>{
    if (!f_area.value){ alert('請先建立並選擇教室'); return; }
    add.disabled = true;
    const body = { area_id: f_area.value, course_name: f_course.value.trim(), reply_text: f_text.value };
    const { error } = await adminClient.from('teacher_texts').insert(body);
    add.disabled = false;
    if (!error){ f_text.value = ''; f_course.value = ''; load(f_area.value); }
  });

  // 篩選：選單變更就只載入該教室
  f_area.addEventListener('change', ()=> load(f_area.value));

  // 只載入指定教室的文本
  async function load(areaId){
    const tb = $('#teacherBody'); tb.innerHTML = '';
    if (!areas || areas.length === 0){
      tb.innerHTML = '<tr><td colspan="4" class="muted">尚無「學習」地區，請先到地區表新增。</td></tr>';
      add.disabled = true;
      return;
    }
    add.disabled = false;

    const { data, error } = await adminClient
      .from('teacher_texts')
      .select('*')
      .eq('area_id', areaId) // ★ 只抓選到的教室
      .order('course_name',{ascending:true});

    if (error){
      tb.innerHTML = `<tr><td colspan="4" class="err">讀取失敗：${error.message}</td></tr>`;
      return;
    }
    if (!data || data.length === 0){
      tb.innerHTML = `<tr><td colspan="4" class="muted">這個教室還沒有任何文本。</td></tr>`;
      return;
    }
    (data||[]).forEach(r=> tb.appendChild(row(r)));
  }

  function row(r){
    const tr = document.createElement('tr');
    const areaName = areaMap.get(r.area_id) || r.area_id;
    const areaSpan = el('span',{text:areaName});
    const course   = el('input',{type:'text', value:r.course_name});
    const text     = el('textarea'); text.value = r.reply_text||''; text.style.minWidth='280px';
    const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
    const del  = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

    tr.append(
      el('td',{},[areaSpan]),
      el('td',{},[course]),
      el('td',{},[text])
    );
    const tbtn = el('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);

    save.addEventListener('click', async ()=>{
      save.disabled = true;
      const body = { course_name: course.value.trim(), reply_text: text.value };
      const { error } = await adminClient.from('teacher_texts').update(body).eq('id', r.id);
      save.disabled = false;
      if (!error){ save.textContent = '已儲存'; setTimeout(()=> save.textContent='儲存', 1000); }
    });

    del.addEventListener('click', async ()=>{
      if (!confirm('確定刪除？')) return;
      const { error } = await adminClient.from('teacher_texts').delete().eq('id', r.id);
      if (!error) tr.remove();
    });

    return tr;
  }

  // 初始載入：預設顯示第一個教室
  if (areas && areas.length){
    f_area.value = areas[0].area_id;
    load(f_area.value);
  }else{
    load(null);
  }
}

// ====== 共用快取：商品 ======
let SHOP_CACHE = [];
const getShopByName = (name) => SHOP_CACHE.find(i => i.item_name === name) || null;

// ===== TAP7：交易 / 商店（含「金流」單欄顯示 + / -）=====
async function renderTab7(root){
  // 先準備學生、商品
  await loadStudentNames();
  let SHOP_ITEMS = await loadShopItems();                         // [{item_name, price_type, price, stock}, ...]
  const itemMap = new Map((SHOP_ITEMS||[]).map(i => [i.item_name, i]));

  // UI：外框
  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'交易 / 商店'}),
    el('span',{class:'chip',text:'transaction_log & student_wallet & shop_items'})
  ]));

  // ===== 表單欄位 =====
  const form = el('div',{class:'grid grid-4'});

  // 學生
  const f_student = makeStudentSelect();

  // 行動（寫進 transaction_log.action；購買預設會用 BUY）
  const f_action  = el('input',{type:'text', placeholder:'行動（例：活動獎勵 / BUY）'});

  // 道具（可空 = 一般交易）
  const f_item = el('select');
  f_item.appendChild(el('option',{value:'', text:'（無道具：一般交易）'}));
  (SHOP_ITEMS||[]).forEach(it=>{
    const label = `${it.item_name}｜${it.price_type} ${it.price}（庫存 ${it.stock}）`;
    f_item.appendChild(el('option',{value:it.item_name, text:label}));
  });

  // 數量（購買才用到）
  const f_qty  = el('input',{type:'number', placeholder:'數量（購買用）', min:1, value:1});

  // 幣別（一般交易用；購買時會自動帶入並鎖定）
  const f_curr = el('select'); CURRENCIES.forEach(v=> f_curr.appendChild(el('option',{value:v, text:v})));

  // 方向 = 加/扣（一般交易用；購買時會自動設為「扣除」並鎖定）
  const f_dir  = el('select');
  f_dir.appendChild(el('option',{value:'credit', text:'增加（+）'}));
  f_dir.appendChild(el('option',{value:'debit',  text:'扣除（-）'}));

  // 金額（一般交易用；購買時 = 單價×數量，並鎖定）
  const f_amount = el('input',{type:'number', placeholder:'金額', min:1});

  // 送出
  const btnGo   = el('button',{class:'btn'},[document.createTextNode('送出交易')]);
  const msg     = el('span',{class:'muted'});

  // 目前餘額
  const walletBox = el('div',{class:'help', text:'餘額：--'});

  form.append(f_student, f_action, f_item, f_qty, f_curr, f_dir, f_amount, btnGo);
  wrap.append(form, walletBox, msg);

  // ===== 交易列表（表頭改成「金流」單欄） =====
  const list = el('div',{class:'table-wrap', style:'margin-top:10px'});
  list.innerHTML = `

    <table>
            <colgroup>
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 25%;">
      <col style="width: 8%;">
      <col style="width: 8%;">
    </colgroup>
      <thead>
        <tr>
          <th>時間</th>
          <th>行動</th>
          <th>幣別</th>
          <th>金流</th>
          <th>道具</th>
        </tr>
      </thead>
      <tbody id="t7TxBody"></tbody>
    </table>`;
  root.append(wrap, list);

  // ===== 行為邏輯 =====

  // 依道具選擇 → 自動帶幣別/金額/方向、鎖定欄位
  function syncByItem(){
    const name = f_item.value;
    const hasItem = !!name;

    // 沒選道具 → 數量無用，鎖為 1；其餘欄位開放手動
    f_qty.disabled = !hasItem;
    if (!hasItem){
      f_qty.value = 1;
      f_curr.disabled = false;
      f_dir.disabled  = false;
      f_amount.disabled = false;
      msg.textContent = '一般交易模式：請手動選幣別、方向與金額。';
      return;
    }

    // 選了道具 → 自動帶入：幣別 / 金額(= 單價 * 數量) / 方向(扣除)
    const it = itemMap.get(name);
    const qty = Math.max(1, Number(f_qty.value||1));
    f_curr.value = it?.price_type || f_curr.value;
    f_amount.value = (it?.price || 0) * qty;
    f_dir.value = 'debit';

    // 鎖定（避免與商品配置衝突）
    f_curr.disabled = true;
    f_dir.disabled  = true;
    f_amount.disabled = true;

    msg.textContent = `購買模式：${name}｜單價 ${it?.price}（${it?.price_type}），數量 ${qty}，總計 ${f_amount.value}`;
  }

  // 切學生 → 讀餘額、交易
  async function refreshWalletAndTx(){
    const stu = f_student.value;
    await Promise.all([loadWallet(stu), loadTx(stu)]);
  }

  // 讀餘額
  async function loadWallet(student){
    const { data } = await adminClient
      .from('student_wallet')
      .select('normal_coin, xer_coin, service_points, updated_at')
      .eq('student_name', student)
      .maybeSingle();
    const n = data?.normal_coin ?? 0;
    const x = data?.xer_coin ?? 0;
    const s = data?.service_points ?? 0;
    walletBox.textContent = `餘額｜一般貨幣：${n}、謝爾夏：${x}、愛校點數：${s}（更新：${fmtTime(data?.updated_at)}）`;
  }

  // 讀最近交易（30 筆）→ 金流單欄（+ / -）
  async function loadTx(student){
    const { data, error } = await adminClient
      .from('transaction_log')
      .select('id, action, type, debit, credit, item, created_at')
      .eq('student_name', student)
      .order('created_at',{descending:true})
      .limit(30);
    const tb = $('#t7TxBody'); tb.innerHTML='';

    if (error){
      tb.innerHTML = `<tr><td colspan=5 class="err">${error.message}</td></tr>`;
      return;
    }

    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');

      const debit  = Number(r.debit || 0);
      const credit = Number(r.credit || 0);

      // 金流顯示規則：以「淨額」為主（入帳-扣款）
      const net  = credit - debit;
      const sign = net >= 0 ? '+' : '-';
      const cls  = net >= 0 ? 'plus' : 'minus';
      const abs  = Math.abs(net);

      tr.innerHTML = `
        <td>${fmtTime(r.created_at)}</td>
        <td>${r.action || '-'}</td>
        <td>${r.type || '-'}</td>
        <td class="mono"><span class="delta ${cls}">${sign}${abs}</span></td>
        <td>${r.item || ''}</td>`;
      tb.appendChild(tr);
    });
  }

  // 重新載入商品（購買後更新庫存/標籤）
  async function reloadItemsAndSelectKeep(){
    const keep = f_item.value;
    SHOP_ITEMS = await loadShopItems();
    itemMap.clear(); (SHOP_ITEMS||[]).forEach(it=> itemMap.set(it.item_name, it));
    // 重建下拉
    f_item.innerHTML = '';
    f_item.appendChild(el('option',{value:'', text:'（無道具：一般交易）'}));
    (SHOP_ITEMS||[]).forEach(it=>{
      const label = `${it.item_name}｜${it.price_type} ${it.price}（庫存 ${it.stock}）`;
      const opt = el('option',{value:it.item_name, text:label});
      if (it.item_name === keep) opt.selected = true;
      f_item.appendChild(opt);
    });
    syncByItem();
  }

  // 送出交易
  btnGo.addEventListener('click', async ()=>{
    btnGo.disabled = true; msg.textContent = '處理中…';
    try{
      const student = f_student.value;
      const action  = (f_action.value||'').trim();
      const item    = f_item.value;
      const qty     = Math.max(1, Number(f_qty.value||1));

      if (!student){ throw new Error('請選擇學生'); }

      // 有選道具 → 走購買流程（RPC）
      if (item){
        const it = itemMap.get(item);
        if (!it) throw new Error('選到不存在的道具（請重整）');

        const { data, error } = await adminClient.rpc('buy_shop_item', {
          p_action: action || 'BUY',
          p_item_name: item,
          p_qty: qty,
          p_student_name: student
        });
        if (error) throw error;

        const row = Array.isArray(data) ? data[0] : data;
        msg.textContent = `購買成功：#${row?.tx_id}｜扣 ${row?.paid_total} ${row?.currency}｜剩餘庫存 ${row?.stock_after}`;
        await Promise.all([reloadItemsAndSelectKeep(), refreshWalletAndTx()]);
      }
      // 無道具 → 一般交易
      else{
        const curr = f_curr.value;
        const dir  = f_dir.value; // credit / debit
        const amt  = Number(f_amount.value||0);
        if (!curr) throw new Error('請選幣別');
        if (!amt || amt <= 0) throw new Error('金額需為正整數');

        const body = {
          student_name: student,
          action: action || 'MANUAL',
          type: curr,
          debit:  dir === 'debit'  ? amt : 0,
          credit: dir === 'credit' ? amt : 0,
          item: null
        };
        const { error } = await adminClient.from('transaction_log').insert(body);
        if (error) throw error;

        msg.textContent = `已新增一般交易：${dir==='debit'?'扣除':'增加'} ${amt}（${curr}）`;
        await refreshWalletAndTx();
      }
    }catch(e){
      console.error(e);
      msg.textContent = '失敗：' + (e.message || e);
    }finally{
      btnGo.disabled = false;
    }
  });

  // 綁定事件
  f_item.addEventListener('change', syncByItem);
  f_qty.addEventListener('input',  syncByItem);
  f_student.addEventListener('change', refreshWalletAndTx);

  // 初始
  // 無道具模式先鎖數量 = 1
  f_qty.disabled = true;
  syncByItem();
  refreshWalletAndTx();
}

// ------------------------
// TAP8：場景介紹（map_locations）
//   欄位建議：id (pk), server_id, category, area_name,
//            dc_channel_id, dc_thread_id, description, image_url, updated_at
// ------------------------
async function renderTab8(root){
  // --- 若沒內建 toast，這裡補一個輕量版 ---
  if (typeof window.toast !== 'function') {
    (function ensureToast(){
      const css = document.createElement('style');
      css.textContent = `
      #toastBox{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:99999}
      .toast{background:#143158;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);opacity:.98}
      .toast.ok{background:#157f3b}.toast.err{background:#b42318}.toast.warn{background:#b54708}`;
      document.head.appendChild(css);
      const box = document.createElement('div'); box.id = 'toastBox'; document.body.appendChild(box);
      window.toast = (msg, kind='ok', ms=1600) => {
        const el = document.createElement('div');
        el.className = `toast ${kind}`; el.textContent = msg;
        box.appendChild(el);
        setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0';
          setTimeout(()=> el.remove(), 280);
        }, ms);
      };
    })();
  }

  // --- 內用圖片彈窗（和其他分頁的圖片彈窗互不干擾） ---
  function openImgModalForMapRow(row, onSaved){
    let mask = document.getElementById('mapImgMask');
    if (!mask){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div id="mapImgMask" class="modal-mask" aria-hidden="true" style="display:none;">
          <div class="modal">
            <div class="close-x" id="mapImgClose">✕</div>
            <h3>場景圖片</h3>
            <div class="field">
              <label>圖片網址</label>
              <input id="mapImgInput" type="text" placeholder="https://…"/>
              <div class="help">貼上可直接存取的圖片網址，下方即時預覽；留空→清除圖片。</div>
            </div>
            <div class="field">
              <div style="border:1px solid #e6eef6;border-radius:8px;padding:8px;background:#f9fbff;text-align:center;">
                <img id="mapImgPreview" alt="預覽" style="max-width:100%;max-height:260px;display:none;" />
                <div id="mapImgEmpty" class="muted">（尚無圖片）</div>
              </div>
            </div>
            <div class="row">
              <span class="msg" id="mapImgMsg"></span>
              <button class="btn secondary" id="mapImgCancel">取消</button>
              <button class="btn" id="mapImgSave">確定</button>
            </div>
          </div>
        </div>
      `.trim();
      document.body.appendChild(wrap.firstElementChild);
    }
    const m = {
      mask: document.getElementById('mapImgMask'),
      input: document.getElementById('mapImgInput'),
      pv: document.getElementById('mapImgPreview'),
      empty: document.getElementById('mapImgEmpty'),
      msg: document.getElementById('mapImgMsg'),
      save: document.getElementById('mapImgSave'),
      cancel: document.getElementById('mapImgCancel'),
      closeX: document.getElementById('mapImgClose'),
      show(){ this.mask.style.display='flex'; this.mask.setAttribute('aria-hidden','false'); setTimeout(()=>this.input.focus(),0); },
      hide(){ this.mask.style.display='none'; this.mask.setAttribute('aria-hidden','true'); this.msg.textContent=''; }
    };
    function setPreview(url){
      if (url){ m.pv.src=url; m.pv.style.display='block'; m.empty.style.display='none'; }
      else { m.pv.removeAttribute('src'); m.pv.style.display='none'; m.empty.style.display='block'; }
    }
    m.pv.onerror = ()=>{ m.msg.textContent='圖片載入失敗，請確認網址。'; m.pv.style.display='none'; m.empty.style.display='block'; };
    m.input.oninput = ()=>{ m.msg.textContent=''; setPreview(m.input.value.trim()); };

    // 初始化
    m.input.value = row.image_url || '';
    setPreview(m.input.value);
    m.msg.textContent = '';

    // 綁定
    const saveHandler = async ()=>{
      m.save.disabled = true; m.msg.textContent = '儲存中…';
      const url = (m.input.value || '').trim() || null;
      const { error } = await adminClient.from('map_locations').update({ image_url: url }).eq('id', row.id);
      m.save.disabled = false;
      if (error){ m.msg.textContent = '儲存失敗：' + (error.message||''); return; }
      row.image_url = url;    // 同步快取
      toast('圖片已更新', 'ok');
      if (onSaved) onSaved(url);
      m.hide();
    };
    const cancelHandler = ()=> m.hide();

    m.save.onclick = saveHandler;
    m.cancel.onclick = cancelHandler;
    m.closeX.onclick = cancelHandler;
    m.show();
  }

  // ===== 容器與工具列 =====
  const wrap = el('div',{class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'場景介紹'}),
    el('span',{class:'chip',text:'map_locations'})
  ]));

  // 伺服器列
  const srvBar = el('div',{class:'toolbar'});
  const srvSel = document.createElement('select');
  const srvReload = el('button',{class:'btn secondary small'},[document.createTextNode('重載伺服器')]);
  const srvInfo = el('span',{class:'muted'});
  srvBar.append(el('strong',{text:'伺服器'}), srvSel, srvReload, srvInfo);

  // 搜尋列（依「地區分類」）
  const qBar = el('div',{class:'toolbar'});
  const qInput = el('input',{type:'text', placeholder:'搜尋「地區分類」…（空白＝全部）', style:'min-width:240px'});
  const qClear = el('button',{class:'btn secondary small'},[document.createTextNode('清除搜尋')]);
  qBar.append(el('strong',{text:'分類篩選'}), qInput, qClear);

  wrap.append(srvBar, qBar);
  root.append(wrap);

  // ===== 新增表單 =====
  const form = el('div',{class:'grid grid-4'});
  const f_cat   = el('input',{type:'text', placeholder:'地區分類（例：教學區 / 行政區）'});
  const f_name  = el('input',{type:'text', placeholder:'地區名稱'});
  const f_chan  = el('input',{type:'text', placeholder:'Discord 頻道 ID（可空）'});
  const f_thread= el('input',{type:'text', placeholder:'Discord 討論串 ID（可空；若填以討論串為主）'});
  const f_desc  = document.createElement('textarea');
  f_desc.placeholder = '文本（多行可伸縮）'; f_desc.style.minHeight='80px'; f_desc.style.resize='vertical';
  const btnAdd  = el('button',{class:'btn'},[document.createTextNode('新增場景')]);

  form.append(f_cat, f_name, f_chan, f_thread, f_desc, btnAdd);
  root.append(form);

  // ===== 列表 =====
  const list = el('div',{class:'table-wrap', style:'margin-top:10px'});
  const table = document.createElement('table');
  table.innerHTML = `
    <colgroup>
      <col style="width: 20%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 15%;">
      <col style="width: 25%;">
      <col style="width: 8%;">
    </colgroup>
    <thead>
      <tr>
        <th>地區分類</th><th>地區名稱</th><th>頻道ID</th><th>討論串ID</th><th>文本</th><th>圖片</th>
      </tr>
    </thead>
    <tbody id="mapBody"></tbody>`;
  list.appendChild(table);
  root.append(list);

  // ===== 內部狀態 =====
  let CUR_SERVER = null;
  let SERVERS = [];
  let ALL_ROWS = [];        // 當前伺服器的所有資料（一次抓，之後本地篩選）
  let CUR_Q = '';           // 目前分類關鍵字（小寫）

  // ===== 載入伺服器 =====
  async function loadServers(){
    const { data, error } = await adminClient
      .from('discord_servers')
      .select('server_id, server_name, is_active')
      .order('server_name',{ascending:true});
    SERVERS = data || [];

    srvSel.innerHTML = '';
    if (!SERVERS.length){
      const opt = document.createElement('option');
      opt.value=''; opt.textContent='（尚無伺服器，請先在 Discord /ping 註冊）';
      srvSel.appendChild(opt);
      CUR_SERVER = null; srvInfo.textContent = '';
      renderRows([]);
      btnAdd.disabled = true;
      return;
    }
    SERVERS.forEach(s=>{
      const o = document.createElement('option');
      o.value = s.server_id;
      o.textContent = `${s.server_name} (${s.server_id})${s.is_active?'':' [停用]'}`;
      srvSel.appendChild(o);
    });
    if (!CUR_SERVER || !SERVERS.find(s=>s.server_id===CUR_SERVER)) CUR_SERVER = SERVERS[0].server_id;
    srvSel.value = CUR_SERVER;
    const cur = SERVERS.find(s=>s.server_id===CUR_SERVER);
    srvInfo.textContent = cur ? `目前伺服器：${cur.server_name}` : '';
    btnAdd.disabled = !CUR_SERVER;
    await loadRows(); // 抓該伺服器資料
  }

  srvSel.addEventListener('change', async ()=>{
    CUR_SERVER = srvSel.value || null;
    const cur = SERVERS.find(s=>s.server_id===CUR_SERVER);
    srvInfo.textContent = cur ? `目前伺服器：${cur.server_name}` : '';
    btnAdd.disabled = !CUR_SERVER;
    await loadRows();
  });
  srvReload.addEventListener('click', loadServers);

  // ===== 讀資料（當前伺服器；一次抓齊，之後本地篩） =====
  async function loadRows(){
    const tb = document.getElementById('mapBody'); tb.innerHTML='';
    if (!CUR_SERVER){ ALL_ROWS=[]; return; }
    const { data, error } = await adminClient
      .from('map_locations')
      .select('*')
      .eq('server_id', CUR_SERVER)
      .order('category',{ascending:true})
      .order('area_name',{ascending:true});
    ALL_ROWS = data || [];
    renderRows(filterRows(ALL_ROWS, CUR_Q));
  }

  // ===== 本地篩選（依分類關鍵字） =====
  function filterRows(rows, q){
    const kw = (q||'').toLowerCase().trim();
    if (!kw) return rows.slice();
    return rows.filter(r => String(r.category||'').toLowerCase().includes(kw));
  }

  // ===== 只渲染給定 rows（不中斷其他狀態） =====
  function renderRows(rows){
    const tb = document.getElementById('mapBody'); tb.innerHTML='';
    rows.forEach(r => tb.appendChild(row(r)));
  }

  // ===== 搜尋框：即時顯示/隱藏，不重抓、不重繪 =====
  function applyFilterDOM(){
    const kw = (CUR_Q||'').toLowerCase().trim();
    const trs = document.querySelectorAll('#mapBody tr');
    trs.forEach(tr => {
      const cat = (tr.dataset.category || '').toLowerCase();
      tr.style.display = !kw || cat.includes(kw) ? '' : 'none';
    });
  }

  qInput.addEventListener('input', ()=>{
    CUR_Q = qInput.value || '';
    applyFilterDOM();
  });
  qClear.addEventListener('click', ()=>{
    qInput.value=''; CUR_Q='';
    applyFilterDOM();
  });

  // ===== 單列構建 =====
  function row(r){
    const tr = document.createElement('tr');
    tr.dataset.id = r.id;
    tr.dataset.category = String(r.category || '');

    const cat   = el('input',{type:'text', value: r.category || ''});
    const name  = el('input',{type:'text', value: r.area_name || ''});
    const chan  = el('input',{type:'text', value: r.dc_channel_id || ''});
    const thrd  = el('input',{type:'text', value: r.dc_thread_id || ''});
    const desc  = document.createElement('textarea');
    desc.value = r.description || '';
    desc.style.minHeight='80px'; desc.style.resize='vertical';

    // 圖片格：預覽 + 「圖片」按鈕
    const imgBox = document.createElement('div');
    const img = document.createElement('img');
    img.style.maxWidth='100%'; img.style.maxHeight='76px'; img.style.display = r.image_url ? 'block' : 'none';
    if (r.image_url) img.src = r.image_url;
    const noImg = el('div',{class:'muted', text:'（尚無圖片）'});
    noImg.style.display = r.image_url ? 'none' : 'block';
    const btnImg = el('button',{class:'btn secondary small', style:'margin-top:6px;'},[document.createTextNode('圖片')]);
    imgBox.append(img, noImg, btnImg);

    const tdCat  = document.createElement('td'); tdCat.appendChild(cat);
    const tdName = document.createElement('td'); tdName.appendChild(name);
    const tdChan = document.createElement('td'); tdChan.appendChild(chan);
    const tdThrd = document.createElement('td'); tdThrd.appendChild(thrd);
    const tdDesc = document.createElement('td'); tdDesc.appendChild(desc);
    const tdImg  = document.createElement('td'); tdImg.appendChild(imgBox);

    tr.append(tdCat, tdName, tdChan, tdThrd, tdDesc, tdImg);

    // 每列下方加操作列（只要儲存/刪除）
    const opTr = document.createElement('tr');
    opTr.innerHTML = `<td colspan="6" style="background:#f9fbff;border-bottom:1px solid #edf3f9;">
      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <span class="muted">最後更新：${fmtTime(r.updated_at)}</span>
        <button class="btn small"  data-act="save">儲存</button>
        <button class="btn secondary small" data-act="del">刪除</button>
      </div>
    </td>`;

    const btnSave = opTr.querySelector('[data-act=save]');
    const btnDel  = opTr.querySelector('[data-act=del]');

    btnSave.addEventListener('click', async ()=>{
      btnSave.disabled = true;
      try{
        const payload = {
          category: (cat.value || '').trim() || null,
          area_name: (name.value || '').trim() || null,
          dc_channel_id: chan.value || null,
          dc_thread_id: thrd.value || null,
          description: desc.value || null
        };
        const { error } = await adminClient.from('map_locations').update(payload).eq('id', r.id);
        if (error) throw error;

        // 同步快取
        Object.assign(r, payload);

        // 更新顯示資訊
        tr.dataset.category = String(r.category || '');

        // 若不再符合目前搜尋 → 隱藏這兩列
        const kw = (CUR_Q||'').toLowerCase().trim();
        const matches = !kw || String(r.category||'').toLowerCase().includes(kw);
        tr.style.display   = matches ? '' : 'none';
        opTr.style.display = matches ? '' : 'none';

        btnSave.textContent = '已儲存';
        toast('儲存成功', 'ok');
        setTimeout(()=> btnSave.textContent='儲存', 900);
      }catch(e){
        toast('儲存失敗：' + (e.message||e), 'err', 2400);
      }finally{
        btnSave.disabled = false;
      }
    });

    btnDel.addEventListener('click', async ()=>{
      if (!confirm(`刪除「${r.area_name || r.id}」？`)) return;
      const { error } = await adminClient.from('map_locations').delete().eq('id', r.id);
      if (!error){
        // 從快取移除
        ALL_ROWS = ALL_ROWS.filter(x => x.id !== r.id);
        tr.remove(); opTr.remove();
        toast('已刪除', 'ok');
      }
    });

    btnImg.addEventListener('click', ()=>{
      openImgModalForMapRow(r, (url)=>{
        if (url){ img.src = url; img.style.display='block'; noImg.style.display='none'; }
        else { img.removeAttribute('src'); img.style.display='none'; noImg.style.display='block'; }
      });
    });

    // 回傳兩列（資料列 + 操作列）
    const frag = document.createDocumentFragment();
    frag.appendChild(tr);
    frag.appendChild(opTr);
    return frag;
  }

  // ===== 新增（不中斷、不整表刷新） =====
  btnAdd.addEventListener('click', async ()=>{
    if (!CUR_SERVER){ alert('請先選擇伺服器'); return; }
    btnAdd.disabled = true;
    try{
      const body = {
        server_id: CUR_SERVER,
        category:  f_cat.value.trim() || null,
        area_name: f_name.value.trim() || null,
        dc_channel_id: f_chan.value || null,
        dc_thread_id:  f_thread.value || null,
        description:   f_desc.value || null,
        image_url: null
      };
      const { data, error } = await adminClient
        .from('map_locations')
        .insert(body)
        .select('*')
        .single();
      if (error) throw error;

      // 更新快取
      ALL_ROWS.push(data);

      // 若符合目前搜尋 → 直接 append；否則靜默新增
      const kw = (CUR_Q||'').toLowerCase().trim();
      const matches = !kw || (String(data.category||'').toLowerCase().includes(kw));
      if (matches){
        document.getElementById('mapBody').appendChild(row(data));
      }

      // 清表單 + 提示
      f_cat.value=''; f_name.value=''; f_chan.value=''; f_thread.value=''; f_desc.value='';
      toast('成功', 'ok');
    }catch(e){
      toast('失敗：' + (e.message||e), 'err', 2400);
    }finally{
      btnAdd.disabled = false;
    }
  });

  // 初始
  await loadServers();
}

    


    // ------------------------
    // 初始化
    // ------------------------
    showUIBySession();
  </script>
</body>
</html>
