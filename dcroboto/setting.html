<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>謝爾夏｜管理後台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap" rel="stylesheet" />
  <style>
    :root{ --name-w:auto; }
    *{ box-sizing:border-box; }
    body{
      font-family:'Noto Sans TC',sans-serif;
      margin:0; padding:2rem;
      background:#f3f7fc;
    }
    .container{
      max-width:1200px; margin:auto; background:#fff;
      border-radius:14px; box-shadow:0 8px 24px #0000000d;
      padding:1.25rem 1.25rem 2rem;
    }
    h1{ margin:0 0 .5rem; color:#143158; text-align:center; }
    .hr{ height:4px; width:80%; margin:.5rem auto 1rem; background:#1767a0; border-radius:2px; }

    .auth-row{ display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-bottom:1rem; }
    .card{
      background:#f7fbff; padding:.75rem; border:1px solid #e6eef6; border-radius:10px; width:100%;
      max-width:560px;
    }
    .card h3{ margin:.2rem 0 .6rem; color:#1767a0; }
    .row{ display:flex; gap:.5rem; margin-bottom:.5rem; }
    .row > input, .row > select{
      flex:1 1 auto; padding:.5rem .6rem; border:1px solid #cfe0f3; border-radius:8px; font-size:.95rem;
    }
    .row > button{
      flex:0 0 auto; padding:.5rem .8rem; border:none; border-radius:8px; cursor:pointer; font-weight:700;
      background:#1767a0; color:#fff;
    }
    .row .ghost{ background:#e9f1f9; color:#143158; }
    .muted{ color:#5b6b7d; font-size:.9rem; }
    .ok{ color:#1f8a50; font-weight:700; }
    .warn{ color:#b65700; font-weight:700; }

    .tabs{ display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin:1rem 0; }
    .tab-btn{ border:none; background:#e9f1f9; color:#143158; padding:.5rem .8rem; border-radius:.6rem; font-weight:700; cursor:pointer; }
    .tab-btn.active{ background:#1767a0; color:#fff; }

    .grid{ display:grid; gap:10px; grid-template-columns: repeat(12, 1fr); }
    .col-12{ grid-column: span 12; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }

    .panel{ border:1px solid #e6eef6; border-radius:10px; padding:.8rem; background:#fbfdff; }
    .panel h4{ margin:.2rem 0 .6rem; color:#1767a0; }

    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid #e6eef6; border-radius:10px; overflow:hidden; }
    thead{ background:#ddebf7; }
    th,td{ padding:.55rem .6rem; border-bottom:1px solid #eef4fb; text-align:left; vertical-align:middle; }
    tbody tr:hover{ background:#f5faff; }
    .actions{ display:flex; gap:.4rem; }
    .btn{ padding:.35rem .6rem; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn.primary{ background:#1767a0; color:#fff; }
    .btn.ghost{ background:#e9f1f9; color:#143158; }
    .btn.danger{ background:#e55353; color:#fff; }
    .input-sm{ width:100%; padding:.35rem .5rem; border:1px solid #cfe0f3; border-radius:6px; font-size:.9rem; }
    .select-sm{ width:100%; padding:.35rem .5rem; border:1px solid #cfe0f3; border-radius:6px; font-size:.9rem; background:#fff; }
    .hint{ color:#5b6b7d; font-size:.9rem; }
    .toolbar{ display:flex; gap:.5rem; align-items:center; margin:.4rem 0 .6rem; flex-wrap:wrap; }
    .toolbar .right{ margin-left:auto; display:flex; gap:.4rem; }
    .pill{ display:inline-block; padding:.2rem .45rem; background:#eff6ff; border:1px solid #dbeafe; border-radius:6px; font-size:.85rem; color:#1e40af; }

    @media (max-width: 900px){
      .col-6{ grid-column: span 12; }
      .col-4{ grid-column: span 12; }
      .col-3{ grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>謝爾夏｜管理後台</h1>
    <div class="hr"></div>

    <!-- 登入區：C（管理專案，本資料庫） -->
    <div class="auth-row">
      <div class="card" id="authC">
        <h3>登入 C（本專案，資料可寫）</h3>
        <div class="row">
          <input id="cEmail" type="email" placeholder="Email (C)" />
          <input id="cPass" type="password" placeholder="密碼 (C)" />
          <button id="btnLoginC">登入</button>
          <button id="btnLogoutC" class="ghost">登出</button>
        </div>
        <div class="muted">狀態：<span id="stateC">未登入</span></div>
      </div>

      <!-- 可選登入：A（拿玩家/角色，僅同步用） -->
      <div class="card" id="authA">
        <h3>登入 A（玩家/角色來源，僅讀+同步）</h3>
        <div class="row">
          <input id="aEmail" type="email" placeholder="Email (A)" />
          <input id="aPass" type="password" placeholder="密碼 (A)" />
          <button id="btnLoginA">登入</button>
          <button id="btnLogoutA" class="ghost">登出</button>
        </div>
        <div class="row">
          <button id="btnSyncPA" class="ghost">從 A 同步 → C（玩家全抓、角色只抓過審）</button>
          <span class="hint">會 upsert 到 <b>player_links</b> / <b>student_cache</b>（保留 DCID / 管理員）</span>
        </div>
        <div class="muted">狀態：<span id="stateA">未登入</span></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="t1">TAP 1：學生快取 / 玩家綁定</button>
      <button class="tab-btn" data-tab="t2">TAP 2：地區表</button>
      <button class="tab-btn" data-tab="t3">TAP 3：時薪設定</button>
      <button class="tab-btn" data-tab="t4">TAP 4：販售道具</button>
      <button class="tab-btn" data-tab="t5">TAP 5：戰鬥攜帶物</button>
      <button class="tab-btn" data-tab="t6">TAP 6：教師文本</button>
    </div>

    <!-- 內容 -->
    <div id="view"></div>
  </div>

<script>
/** ========= Supabase 兩個 client =========
 * C：本專案（你的 DB），需要登入後才能寫
 * A：玩家/角色來源（可選登入，用於同步）
 */
const C_URL  = 'https://pptmmkpipwcgbxbimarp.supabase.co';
const C_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwdG1ta3BpcHdjZ2J4YmltYXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDE5NjQsImV4cCI6MjA3MzUxNzk2NH0.E5ynYRbCKqnsppdhNZFHN4biiS-8hxhBplEG9FeUdcU';

const A_URL  = 'https://wfhwhvodgikpducrhgda.supabase.co';
const A_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8';

const supaC = window.supabase.createClient(C_URL, C_ANON);
const supaA = window.supabase.createClient(A_URL, A_ANON);

/** ========= 共用：登入/狀態 ========= */
const $ = s => document.querySelector(s);
const stateC = $('#stateC');
const stateA = $('#stateA');
function setCStatus(u){
  stateC.innerHTML = u ? `<span class="ok">已登入（${u.email||u.id}）</span>` : `<span class="warn">未登入</span>`;
}
function setAStatus(u){
  stateA.innerHTML = u ? `<span class="ok">已登入（${u.email||u.id}）</span>` : `<span class="warn">未登入</span>`;
}

$('#btnLoginC').onclick = async () => {
  const email = $('#cEmail').value.trim();
  const pass  = $('#cPass').value;
  const { data, error } = await supaC.auth.signInWithPassword({ email, password: pass });
  if(error){ alert('C 登入失敗：'+error.message); return; }
  setCStatus(data.user);
  loadActiveTab();
};
$('#btnLogoutC').onclick = async () => { await supaC.auth.signOut(); setCStatus(null); };

$('#btnLoginA').onclick = async () => {
  const email = $('#aEmail').value.trim();
  const pass  = $('#aPass').value;
  const { data, error } = await supaA.auth.signInWithPassword({ email, password: pass });
  if(error){ alert('A 登入失敗：'+error.message); return; }
  setAStatus(data.user);
};
$('#btnLogoutA').onclick = async () => { await supaA.auth.signOut(); setAStatus(null); };

/** ========= TAP 1：學生快取（只讀）＋ 玩家綁定（編輯 DCID / 管理員） ========= */
async function viewT1(){
  const container = document.createElement('div');
  container.className = 'grid';

  // 左：學生快取（只讀）
  const left = document.createElement('div'); left.className = 'col-6 panel';
  left.innerHTML = `
    <h4>學生快取（只讀）</h4>
    <div class="toolbar">
      <span class="pill">student_cache</span>
      <div class="right">
        <button class="btn ghost" id="btnRefreshStu">重新整理</button>
      </div>
    </div>
    <div style="max-height:420px; overflow:auto;">
      <table>
        <thead><tr><th>student_id</th><th>player_id</th><th>角色名稱</th><th>更新時間</th></tr></thead>
        <tbody id="tStu"></tbody>
      </table>
    </div>
  `;

  // 右：玩家綁定（可改 DCID / 管理員）
  const right = document.createElement('div'); right.className = 'col-6 panel';
  right.innerHTML = `
    <h4>玩家綁定（設定 DCID / 管理員）</h4>
    <div class="toolbar">
      <span class="pill">player_links</span>
      <div class="right">
        <button class="btn ghost" id="btnRefreshPlayer">重新整理</button>
        <button class="btn" id="btnSyncFromA">從 A 同步 → C</button>
        <button class="btn primary" id="btnSavePlayers">儲存修改</button>
      </div>
    </div>
    <div style="max-height:420px; overflow:auto;">
      <table>
        <thead><tr><th>player_id</th><th>玩家名稱</th><th>DCID</th><th>管理員</th></tr></thead>
        <tbody id="tPlayers"></tbody>
      </table>
    </div>
  `;

  container.appendChild(left); container.appendChild(right);

  // 綁事件
  left.querySelector('#btnRefreshStu').onclick = renderStudents;
  right.querySelector('#btnRefreshPlayer').onclick = renderPlayers;
  right.querySelector('#btnSyncFromA').onclick   = syncFromA;
  right.querySelector('#btnSavePlayers').onclick = savePlayers;

  // 初次載入
  await renderStudents();
  await renderPlayers();

  async function renderStudents(){
    const { data, error } = await supaC.from('student_cache')
      .select('*').order('student_name',{ascending:true});
    if(error){ alert('讀取 student_cache 失敗：'+error.message); return; }
    const tb = left.querySelector('#tStu'); tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${r.student_id}</td>
        <td class="muted">${r.player_id||''}</td>
        <td>${r.student_name}</td>
        <td class="muted">${new Date(r.updated_at).toLocaleString('zh-TW')}</td>`;
      tb.appendChild(tr);
    });
  }

  let playerRows = [];
  async function renderPlayers(){
    const { data, error } = await supaC.from('player_links')
      .select('*').order('player_name',{ascending:true});
    if(error){ alert('讀取 player_links 失敗：'+error.message); return; }
    playerRows = data||[];
    const tb = right.querySelector('#tPlayers'); tb.innerHTML='';
    playerRows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${r.player_id}</td>
        <td>${r.player_name||''}</td>
        <td><input class="input-sm" value="${r.discord_user_id||''}" data-i="${i}" data-k="discord_user_id"/></td>
        <td><input type="checkbox" ${r.is_admin?'checked':''} data-i="${i}" data-k="is_admin"/></td>`;
      tb.appendChild(tr);
    });
    // 代理事件
    tb.oninput = (e)=>{
      const el = e.target;
      const i  = +el.dataset.i;
      const k  = el.dataset.k;
      if(k==='discord_user_id'){ playerRows[i].discord_user_id = el.value.trim() || null; }
    };
    tb.onchange = (e)=>{
      const el = e.target;
      const i  = +el.dataset.i;
      const k  = el.dataset.k;
      if(k==='is_admin'){ playerRows[i].is_admin = !!el.checked; }
    };
  }

  async function savePlayers(){
    const { error } = await supaC.from('player_links').upsert(playerRows);
    if(error){ alert('儲存失敗：'+error.message); return; }
    alert('已儲存。');
    renderPlayers();
  }

  async function syncFromA(){
    // 需要 A / C 都登入
    const aSession = (await supaA.auth.getSession()).data.session;
    if(!aSession){ alert('請先登入 A'); return; }
    const cSession = (await supaC.auth.getSession()).data.session;
    if(!cSession){ alert('請先登入 C'); return; }

    // 1) 讀 A 的 players（全抓）
    const { data: players, error: pErr } = await supaA.from('players')
      .select('player_id, username').order('username',{ascending:true});
    if(pErr){ alert('讀取 A.players 失敗：'+pErr.message); return; }

    // 2) 讀 A 的 students（只抓過審：student_code not null）
    const { data: students, error: sErr } = await supaA.from('students')
      .select('student_id, name, student_code, player_id')
      .not('student_code','is',null)
      .order('name',{ascending:true});
    if(sErr){ alert('讀取 A.students 失敗：'+sErr.message); return; }

    // 3) 讀 C 現有 player_links 以保留 DCID / is_admin
    const { data: curLinks } = await supaC.from('player_links').select('*');
    const curMap = new Map((curLinks||[]).map(x=>[x.player_id, x]));

    // 4) 準備 upsert：player_links
    const upsertPlayers = (players||[]).map(p=>{
      const keep = curMap.get(p.player_id);
      return {
        player_id: p.player_id,
        player_name: p.username || '玩家',
        discord_user_id: keep?.discord_user_id ?? null,
        is_admin: keep?.is_admin ?? false
      };
    });

    // 5) 準備 upsert：student_cache（名稱快取）
    const upsertStudents = (students||[]).map(s=>({
      student_id: s.student_id,
      player_id:  s.player_id,
      student_name: s.name,
      updated_at: new Date().toISOString()
    }));

    // 6) 寫入 C
    const { error: u1 } = await supaC.from('player_links').upsert(upsertPlayers);
    if(u1){ alert('寫入 C.player_links 失敗：'+u1.message); return; }
    const { error: u2 } = await supaC.from('student_cache').upsert(upsertStudents);
    if(u2){ alert('寫入 C.student_cache 失敗：'+u2.message); return; }

    alert(`同步完成！玩家 ${upsertPlayers.length} 筆；過審學生 ${upsertStudents.length} 筆。`);
    renderStudents(); renderPlayers();
  }

  return container;
}

/** ========= TAP 2：地區表（新增 + 一覽 + 內嵌編輯） ========= */
async function viewT2(){
  const wrap = document.createElement('div'); wrap.className='panel';

  // 新增表單
  const form = document.createElement('div'); form.className='grid';
  form.innerHTML = `
    <div class="col-12"><h4>新增 / 編輯地區</h4></div>
    <div class="col-4"><input id="area_name" class="input-sm" placeholder="地區顯示名稱"/></div>
    <div class="col-3">
      <select id="area_type" class="select-sm">
        <option value="學習">學習</option>
        <option value="愛校">愛校</option>
        <option value="打工">打工</option>
        <option value="特殊打工">特殊打工</option>
        <option value="遊戲">遊戲</option>
      </select>
    </div>
    <div class="col-5"><input id="webhook_url" class="input-sm" placeholder="webhook_url（可空）"/></div>
    <div class="col-4"><input id="dc_thread_id" class="input-sm" placeholder="dc_thread_id（可空）"/></div>
    <div class="col-3"><input id="daily_limit" class="input-sm" placeholder="愛校每日上限（可空/數字）"/></div>
    <div class="col-5">
      <button class="btn primary" id="btnAddArea">新增</button>
      <span class="hint">排序：地區顯示名稱（不換頁）</span>
    </div>
  `;

  const list = document.createElement('div');
  list.innerHTML = `
    <div class="toolbar">
      <span class="pill">area</span>
      <div class="right"><button class="btn ghost" id="btnReloadArea">重新整理</button></div>
    </div>
    <div style="max-height:520px; overflow:auto;">
      <table>
        <thead><tr><th>area_id</th><th>名稱</th><th>型別</th><th>webhook</th><th>thread</th><th>每日</th><th>操作</th></tr></thead>
        <tbody id="tArea"></tbody>
      </table>
    </div>
  `;

  wrap.appendChild(form); wrap.appendChild(list);

  form.querySelector('#btnAddArea').onclick = async ()=>{
    const area_name = form.querySelector('#area_name').value.trim();
    const area_type = form.querySelector('#area_type').value;
    const webhook_url = form.querySelector('#webhook_url').value.trim()||null;
    const dc_thread_id = form.querySelector('#dc_thread_id').value.trim()||null;
    const daily_limit = form.querySelector('#daily_limit').value.trim();
    if(!area_name){ alert('請輸入地區顯示名稱'); return; }
    const payload = { area_name, area_type, webhook_url, dc_thread_id,
                      daily_limit: daily_limit? parseInt(daily_limit,10): null };
    const { error } = await supaC.from('area').insert(payload);
    if(error){ alert('新增失敗：'+error.message); return; }
    form.querySelectorAll('input').forEach(i=>i.value='');
    await renderArea();
  };
  list.querySelector('#btnReloadArea').onclick = renderArea;

  async function renderArea(){
    const { data, error } = await supaC.from('area').select('*').order('area_name',{ascending:true});
    if(error){ alert('讀取 area 失敗：'+error.message); return; }
    const tb = list.querySelector('#tArea'); tb.innerHTML='';
    (data||[]).forEach((r)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${r.area_id}</td>
        <td><input class="input-sm" value="${r.area_name||''}" data-k="area_name"/></td>
        <td>
          <select class="select-sm" data-k="area_type">
            ${['學習','愛校','打工','特殊打工','遊戲'].map(v=>`<option ${v===r.area_type?'selected':''}>${v}</option>`).join('')}
          </select>
        </td>
        <td><input class="input-sm" value="${r.webhook_url||''}" data-k="webhook_url"/></td>
        <td><input class="input-sm" value="${r.dc_thread_id||''}" data-k="dc_thread_id"/></td>
        <td><input class="input-sm" value="${r.daily_limit??''}" data-k="daily_limit"/></td>
        <td class="actions">
          <button class="btn primary" data-act="save">保存</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>
      `;
      // 綁事件
      tr.onclick = async (e)=>{
        const act = e.target?.dataset?.act;
        if(!act) return;
        if(act==='save'){
          const payload = {
            area_name: tr.querySelector('[data-k="area_name"]').value.trim(),
            area_type: tr.querySelector('[data-k="area_type"]').value,
            webhook_url: tr.querySelector('[data-k="webhook_url"]').value.trim()||null,
            dc_thread_id: tr.querySelector('[data-k="dc_thread_id"]').value.trim()||null,
            daily_limit: (()=>{
              const v = tr.querySelector('[data-k="daily_limit"]').value.trim();
              return v? parseInt(v,10): null;
            })()
          };
          const { error } = await supaC.from('area').update(payload).eq('area_id', r.area_id);
          if(error){ alert('更新失敗：'+error.message); return; }
          alert('已保存');
        }else if(act==='del'){
          if(!confirm('確定刪除此地區？')) return;
          const { error } = await supaC.from('area').delete().eq('area_id', r.area_id);
          if(error){ alert('刪除失敗：'+error.message); return; }
          tr.remove();
        }
      };
      tb.appendChild(tr);
    });
  }

  await renderArea();
  return wrap;
}

/** ========= TAP 3：時薪設定（單筆） ========= */
async function viewT3(){
  const wrap = document.createElement('div'); wrap.className='panel';
  wrap.innerHTML = `
    <h4>時薪設定（wage_config）</h4>
    <div class="grid">
      <div class="col-3"><input id="work_wage_default" class="input-sm" placeholder="一般打工預設時薪"/></div>
      <div class="col-3"><input id="special_wage_default" class="input-sm" placeholder="特殊打工預設時薪"/></div>
      <div class="col-6">
        <button class="btn primary" id="btnSaveWage">保存</button>
        <span class="hint">新建立的打工紀錄才會吃到最新時薪（舊紀錄不回溯）</span>
      </div>
    </div>
  `;
  const work = wrap.querySelector('#work_wage_default');
  const spec = wrap.querySelector('#special_wage_default');

  async function load(){
    const { data, error } = await supaC.from('wage_config').select('*').eq('config_id',1).maybeSingle();
    if(error){ alert('讀取 wage_config 失敗：'+error.message); return; }
    work.value = data?.work_wage_default ?? '';
    spec.value = data?.special_wage_default ?? '';
  }
  wrap.querySelector('#btnSaveWage').onclick = async ()=>{
    const w = parseInt(work.value,10);
    const s = parseInt(spec.value,10);
    const { error } = await supaC.from('wage_config').upsert({
      config_id:1, work_wage_default: isNaN(w)?100:w, special_wage_default: isNaN(s)?5:s, updated_at: new Date().toISOString()
    });
    if(error){ alert('保存失敗：'+error.message); return; }
    alert('已保存');
  };
  await load();
  return wrap;
}

/** ========= TAP 4：販售道具（CRUD） ========= */
async function viewT4(){
  const wrap = document.createElement('div'); wrap.className='panel';
  wrap.innerHTML = `
    <h4>販售道具（shop_items）</h4>
    <div class="grid">
      <div class="col-3"><input id="si_name" class="input-sm" placeholder="道具名稱"/></div>
      <div class="col-2">
        <select id="si_type" class="select-sm">
          <option>一般貨幣</option><option>謝爾夏貨幣</option><option>愛校點數</option>
        </select>
      </div>
      <div class="col-2"><input id="si_price" class="input-sm" placeholder="售價（數字）"/></div>
      <div class="col-2"><input id="si_stock" class="input-sm" placeholder="庫存（數字）"/></div>
      <div class="col-3"><input id="si_max" class="input-sm" placeholder="可用次數（空=永久）"/></div>
      <div class="col-9"><input id="si_desc" class="input-sm" placeholder="商品簡介"/></div>
      <div class="col-3"><button class="btn primary" id="btnAddItem">新增</button></div>
    </div>
    <div class="toolbar"><span class="pill">shop_items</span>
      <div class="right"><button class="btn ghost" id="btnReloadSI">重新整理</button></div>
    </div>
    <div style="max-height:520px; overflow:auto;">
      <table>
        <thead><tr><th>名稱</th><th>類型</th><th>售價</th><th>庫存</th><th>可用次數</th><th>簡介</th><th>操作</th></tr></thead>
        <tbody id="tSI"></tbody>
      </table>
    </div>
  `;

  wrap.querySelector('#btnAddItem').onclick = async ()=>{
    const name = wrap.querySelector('#si_name').value.trim();
    if(!name){ alert('請填道具名稱'); return; }
    const payload = {
      item_name: name,
      price_type: wrap.querySelector('#si_type').value,
      price: parseInt(wrap.querySelector('#si_price').value||'0',10),
      stock: parseInt(wrap.querySelector('#si_stock').value||'0',10),
      max_uses: (()=>{
        const v = wrap.querySelector('#si_max').value.trim();
        return v? parseInt(v,10): null;
      })(),
      shop_desc: wrap.querySelector('#si_desc').value.trim()||null
    };
    const { error } = await supaC.from('shop_items').insert(payload);
    if(error){ alert('新增失敗：'+error.message); return; }
    ['#si_name','#si_price','#si_stock','#si_max','#si_desc'].forEach(sel=>wrap.querySelector(sel).value='');
    render();
  };

  wrap.querySelector('#btnReloadSI').onclick = render;

  async function render(){
    const { data, error } = await supaC.from('shop_items').select('*').order('item_name',{ascending:true});
    if(error){ alert('讀取失敗：'+error.message); return; }
    const tb = wrap.querySelector('#tSI'); tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input-sm" value="${r.item_name}" data-k="item_name"/></td>
        <td>
          <select class="select-sm" data-k="price_type">
            ${['一般貨幣','謝爾夏貨幣','愛校點數'].map(v=>`<option ${v===r.price_type?'selected':''}>${v}</option>`).join('')}
          </select>
        </td>
        <td><input class="input-sm" value="${r.price}" data-k="price"/></td>
        <td><input class="input-sm" value="${r.stock}" data-k="stock"/></td>
        <td><input class="input-sm" value="${r.max_uses??''}" data-k="max_uses"/></td>
        <td><input class="input-sm" value="${r.shop_desc??''}" data-k="shop_desc"/></td>
        <td class="actions">
          <button class="btn primary" data-act="save">保存</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>
      `;
      tr.onclick = async (e)=>{
        const act = e.target?.dataset?.act;
        if(!act) return;
        if(act==='save'){
          const payload = {
            item_name: tr.querySelector('[data-k="item_name"]').value.trim(),
            price_type: tr.querySelector('[data-k="price_type"]').value,
            price: parseInt(tr.querySelector('[data-k="price"]').value||'0',10),
            stock: parseInt(tr.querySelector('[data-k="stock"]').value||'0',10),
            max_uses: (()=>{
              const v = tr.querySelector('[data-k="max_uses"]').value.trim();
              return v? parseInt(v,10): null;
            })(),
            shop_desc: tr.querySelector('[data-k="shop_desc"]').value.trim()||null
          };
          const { error } = await supaC.from('shop_items').update(payload).eq('id', r.id);
          if(error){ alert('更新失敗：'+error.message); return; }
          alert('已保存');
        }else if(act==='del'){
          if(!confirm('確定刪除此商品？')) return;
          const { error } = await supaC.from('shop_items').delete().eq('id', r.id);
          if(error){ alert('刪除失敗：'+error.message); return; }
          tr.remove();
        }
      };
      tb.appendChild(tr);
    });
  }

  await render();
  return wrap;
}

/** ========= TAP 5：戰鬥攜帶物（新增 + 一覽 + 內嵌編輯） ========= */
async function viewT5(){
  const wrap = document.createElement('div'); wrap.className='panel';
  wrap.innerHTML = `
    <h4>戰鬥攜帶物（battle_items）</h4>
    <div class="grid">
      <div class="col-3"><input id="bi_student" class="input-sm" placeholder="角色名稱"/></div>
      <div class="col-2"><input id="bi_slot" class="input-sm" placeholder="欄位(1-4)"/></div>
      <div class="col-3"><input id="bi_item" class="input-sm" placeholder="裝備名稱"/></div>
      <div class="col-2"><input id="bi_uses" class="input-sm" placeholder="剩餘次數（空=永久）"/></div>
      <div class="col-2">
        <select id="bi_lock" class="select-sm">
          <option value="false">可回背包</option>
          <option value="true">壞掉前鎖定</option>
        </select>
      </div>
      <div class="col-12">
        <button class="btn primary" id="btnAddBI">新增</button>
      </div>
    </div>
    <div class="toolbar"><span class="pill">battle_items</span>
      <div class="right"><button class="btn ghost" id="btnReloadBI">重新整理</button></div>
    </div>
    <div style="max-height:520px; overflow:auto;">
      <table>
        <thead><tr><th>角色</th><th>槽位</th><th>裝備</th><th>剩餘次數</th><th>鎖定</th><th>操作</th></tr></thead>
        <tbody id="tBI"></tbody>
      </table>
    </div>
  `;
  wrap.querySelector('#btnAddBI').onclick = async ()=>{
    const payload = {
      student_name: wrap.querySelector('#bi_student').value.trim(),
      slot: parseInt(wrap.querySelector('#bi_slot').value||'0',10),
      item_name: wrap.querySelector('#bi_item').value.trim(),
      uses_left: (()=>{
        const v = wrap.querySelector('#bi_uses').value.trim();
        return v? parseInt(v,10): null;
      })(),
      locked_until_broken: wrap.querySelector('#bi_lock').value==='true'
    };
    if(!payload.student_name || !payload.item_name || !payload.slot){ alert('請完整填寫'); return; }
    const { error } = await supaC.from('battle_items').insert(payload);
    if(error){ alert('新增失敗：'+error.message); return; }
    ['#bi_student','#bi_slot','#bi_item','#bi_uses'].forEach(sel=>wrap.querySelector(sel).value='');
    await render();
  };
  wrap.querySelector('#btnReloadBI').onclick = render;

  async function render(){
    const { data, error } = await supaC.from('battle_items').select('*').order('student_name',{ascending:true}).order('slot');
    if(error){ alert('讀取失敗：'+error.message); return; }
    const tb = wrap.querySelector('#tBI'); tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input-sm" value="${r.student_name}" data-k="student_name"/></td>
        <td><input class="input-sm" value="${r.slot}" data-k="slot"/></td>
        <td><input class="input-sm" value="${r.item_name}" data-k="item_name"/></td>
        <td><input class="input-sm" value="${r.uses_left??''}" data-k="uses_left"/></td>
        <td>
          <select class="select-sm" data-k="locked_until_broken">
            <option value="false" ${!r.locked_until_broken?'selected':''}>可回背包</option>
            <option value="true" ${r.locked_until_broken?'selected':''}>壞掉前鎖定</option>
          </select>
        </td>
        <td class="actions">
          <button class="btn primary" data-act="save">保存</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>
      `;
      tr.onclick = async (e)=>{
        const act = e.target?.dataset?.act;
        if(!act) return;
        if(act==='save'){
          const payload = {
            student_name: tr.querySelector('[data-k="student_name"]').value.trim(),
            slot: parseInt(tr.querySelector('[data-k="slot"]').value||'0',10),
            item_name: tr.querySelector('[data-k="item_name"]').value.trim(),
            uses_left: (()=>{
              const v = tr.querySelector('[data-k="uses_left"]').value.trim();
              return v? parseInt(v,10): null;
            })(),
            locked_until_broken: tr.querySelector('[data-k="locked_until_broken"]').value==='true'
          };
          const { error } = await supaC.from('battle_items').update(payload).eq('id', r.id);
          if(error){ alert('更新失敗：'+error.message); return; }
          alert('已保存');
        }else if(act==='del'){
          if(!confirm('確定刪除？')) return;
          const { error } = await supaC.from('battle_items').delete().eq('id', r.id);
          if(error){ alert('刪除失敗：'+error.message); return; }
          tr.remove();
        }
      };
      tb.appendChild(tr);
    });
  }

  await render();
  return wrap;
}

/** ========= TAP 6：教師文本（地區=學習 下拉 + 新增 + 一覽） ========= */
async function viewT6(){
  const wrap = document.createElement('div'); wrap.className='panel';
  wrap.innerHTML = `
    <h4>教師文本（teacher_texts）</h4>
    <div class="grid">
      <div class="col-4">
        <select id="tt_area" class="select-sm"></select>
      </div>
      <div class="col-4"><input id="tt_course" class="input-sm" placeholder="課程名稱"/></div>
      <div class="col-12"><input id="tt_text" class="input-sm" placeholder="老師台詞"/></div>
      <div class="col-12">
        <button class="btn primary" id="btnAddTT">新增台詞</button>
        <span class="hint">一覽依地區顯示名稱排序；下拉僅列「學習」型別</span>
      </div>
    </div>
    <div class="toolbar"><span class="pill">teacher_texts</span>
      <div class="right"><button class="btn ghost" id="btnReloadTT">重新整理</button></div>
    </div>
    <div style="max-height:520px; overflow:auto;">
      <table>
        <thead><tr><th>地區</th><th>課程</th><th>台詞</th><th>建立時間</th><th>操作</th></tr></thead>
        <tbody id="tTT"></tbody>
      </table>
    </div>
  `;

  const sel = wrap.querySelector('#tt_area');
  async function loadAreas(){
    const { data, error } = await supaC.from('area')
      .select('area_id, area_name').eq('area_type','學習').order('area_name',{ascending:true});
    if(error){ alert('讀取 area 失敗：'+error.message); return; }
    sel.innerHTML = (data||[]).map(a=>`<option value="${a.area_id}">${a.area_name}</option>`).join('');
  }

  wrap.querySelector('#btnAddTT').onclick = async ()=>{
    const area_id = sel.value;
    const course_name = wrap.querySelector('#tt_course').value.trim();
    const reply_text  = wrap.querySelector('#tt_text').value.trim();
    if(!area_id || !course_name || !reply_text){ alert('請完整填寫'); return; }
    const { error } = await supaC.from('teacher_texts').insert({ area_id, course_name, reply_text });
    if(error){ alert('新增失敗：'+error.message); return; }
    wrap.querySelector('#tt_text').value='';
    await renderTT();
  };
  wrap.querySelector('#btnReloadTT').onclick = renderTT;

  async function renderTT(){
    // 為了以「地區顯示名稱」排序，直接 join 一次（兩段查也可以）
    const { data, error } = await supaC.rpc('get_teacher_texts_with_area', {}) // 若沒有這個 RPC，就用下列方案
    .catch(()=>({data:null,error:{message:'no-rpc'}}));

    let rows = null;
    if(!error && Array.isArray(data)){ rows = data; }
    else{
      // 無 RPC 改本機組合
      const { data: t } = await supaC.from('teacher_texts').select('*');
      const { data: a } = await supaC.from('area').select('area_id, area_name');
      const map = new Map((a||[]).map(x=>[x.area_id,x.area_name]));
      rows = (t||[]).map(x=>({ ...x, area_name: map.get(x.area_id)||'(已刪除)' }));
      rows.sort((x,y)=> String(x.area_name||'').localeCompare(String(y.area_name||''), 'zh-Hant', {numeric:true}) );
    }

    const tb = wrap.querySelector('#tTT'); tb.innerHTML='';
    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.area_name || '(未知)'}</td>
        <td><input class="input-sm" value="${r.course_name}" data-k="course_name"/></td>
        <td><input class="input-sm" value="${r.reply_text}" data-k="reply_text"/></td>
        <td class="muted">${new Date(r.created_at).toLocaleString('zh-TW')}</td>
        <td class="actions">
          <button class="btn primary" data-act="save">保存</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>
      `;
      tr.onclick = async (e)=>{
        const act = e.target?.dataset?.act;
        if(!act) return;
        if(act==='save'){
          const payload = {
            course_name: tr.querySelector('[data-k="course_name"]').value.trim(),
            reply_text: tr.querySelector('[data-k="reply_text"]').value.trim()
          };
          const { error } = await supaC.from('teacher_texts').update(payload).eq('id', r.id);
          if(error){ alert('更新失敗：'+error.message); return; }
          alert('已保存');
        }else if(act==='del'){
          if(!confirm('確定刪除？')) return;
          const { error } = await supaC.from('teacher_texts').delete().eq('id', r.id);
          if(error){ alert('刪除失敗：'+error.message); return; }
          tr.remove();
        }
      };
      tb.appendChild(tr);
    });
  }

  await loadAreas();
  await renderTT();
  return wrap;
}

/** ========= Tab 切換 ========= */
const view = $('#view');
const tabs = $('#tabs');
tabs.onclick = async (e)=>{
  const btn = e.target.closest('.tab-btn'); if(!btn) return;
  tabs.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  await loadActiveTab();
};
async function loadActiveTab(){
  const active = tabs.querySelector('.tab-btn.active')?.dataset.tab || 't1';
  view.innerHTML = '';
  // 檢查 C 是否已登入（未登入仍可看「只讀」資料，但為了安全，整體設計為：需登入 C 才進管理頁）
  const cSession = (await supaC.auth.getSession()).data.session;
  if(!cSession){
    view.innerHTML = `<div class="panel"><b class="warn">請先登入 C 專案後再使用管理功能。</b></div>`;
    return;
  }
  if(active==='t1') view.appendChild(await viewT1());
  if(active==='t2') view.appendChild(await viewT2());
  if(active==='t3') view.appendChild(await viewT3());
  if(active==='t4') view.appendChild(await viewT4());
  if(active==='t5') view.appendChild(await viewT5());
  if(active==='t6') view.appendChild(await viewT6());
}

/** ========= 初始化：顯示登入狀態 ========= */
(async function init(){
  setCStatus((await supaC.auth.getUser()).data.user);
  setAStatus((await supaA.auth.getUser()).data.user);
  loadActiveTab();
})();
</script>
</body>
</html>
