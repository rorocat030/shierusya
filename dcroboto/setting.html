<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>謝爾夏｜管理後台</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap" rel="stylesheet" />
  <style>
    :root { --name-w: auto; }
    * { box-sizing: border-box; }
    body { font-family: 'Noto Sans TC', sans-serif; background:#f3f7fb; margin:0; min-height:100vh; color:#143158; }
    a { color:#1767a0; text-decoration:none; }
    .container { max-width: 1200px; margin: 32px auto; background: #fff; padding: 18px; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { margin: 0 0 6px 0; font-size: 22px; letter-spacing: .5px; }
    .hr-blue { width: 92%; height: 4px; background: #1767a0; margin: 8px auto 18px auto; border-radius: 2px; opacity: .85; }

    .row { display:flex; gap:12px; align-items:center; flex-direction: column; }
    .grow { flex:1; }
    .muted { color:#5a728f; }
    .warn { color:#b54708; }
    .ok { color:#157f3b; }
    .err { color:#b42318; }

    .card { background:#f7fbff; border:1px solid #e6eef6; border-radius:12px; padding:12px; margin:10px 0; }

    /* Auth */
    .auth-wrap { max-width:420px; margin:40px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .auth-title { text-align:center; font-weight:700; margin-bottom:10px; }
    .field { display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    input[type=text], input[type=password], input[type=number], select, textarea { padding:8px 6px; border:1px solid #d7e3ef; border-radius:8px; background:#fff; font-size:14px; color:#143158; }
    textarea { min-height:80px; }
    .btn { border:none; background:#1767a0; color:#fff; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; box-shadow:0 1px 4px #0001; }
    .btn.secondary { background:#e9f1f9; color:#143158; }
    .btn.ghost { background:transparent; color:#1767a0; border:1px solid #1767a0; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .right { margin-left:auto; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px; }
    .tab-btn { border:none; background:#e9f1f9; color:#143158; padding:7px 10px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 1px 4px #0001; }
    .tab-btn.active { background:#1767a0; color:#fff; }

    /* Tables */
    .table-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fbfdff; border:1px solid #e6eef6; border-radius:8px; overflow:hidden; table-layout: fixed; }
    thead { background:#ddebf7; }
    th, td { padding:8px 10px; border-bottom:1px solid #edf3f9; text-align:left; vertical-align:middle; }
    tbody tr:hover { background:#eef6ff; }
    td input, td select, td textarea { width:100%; box-sizing: border-box; }

    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 8px 0; flex-direction: row-reverse; }
    .pill { font-size:12px; background:#143158; color:#fff; border-radius:6px; padding:4px 8px; }
    .chip { font-size:12px; background:#eef6ff; color:#143158; border-radius:999px; padding:2px 8px; }
    .spacer { flex:1; }
    .grid { display:grid; gap:8px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 860px){ .grid-3, .grid-4 { grid-template-columns: repeat(1,minmax(0,1fr)); } }

    .help { font-size:12px; color:#5a728f; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .center { text-align:center; }

    /* ===== A 專案登入彈窗 ===== */
    .modal-mask {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal {
      width: min(420px, 92vw);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,.2);
      position: relative;
    }
    .modal h3 { margin: 0 0 8px 0; font-size: 18px; }
    .modal .field { margin: 8px 0; }
    .modal .row { flex-direction: row; justify-content: flex-end; }
    .modal .msg { font-size: 12px; color:#5a728f; min-height: 1.2em; }
    .modal .close-x { position:absolute; right:12px; top:8px; cursor:pointer; color:#5a728f; }
    .delta.plus { color:#157f3b; font-weight:700; }
    .delta.minus { color:#b42318; font-weight:700; }
    #info {
  white-space: pre-line;
}
  </style>
</head>
<body>
  <div class="container" id="app" hidden>
    <div class="row">
      <h1>謝爾夏｜管理後台</h1>
      <span class="pill">C 專案（資料庫）</span>
      <span class="chip" id="whoami"></span>
      <button class="btn ghost right" id="signoutBtn">登出</button>
    </div>
    <div class="hr-blue"></div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="t1">學生快取 / 玩家綁定</button>
      <button class="tab-btn" data-tab="t2">地區表</button>
      <button class="tab-btn" data-tab="t3">時薪/點數設定</button>
      <button class="tab-btn" data-tab="t4">販售道具</button>
      <button class="tab-btn" data-tab="t5">戰鬥攜帶物</button>
      <button class="tab-btn" data-tab="t6">教師文本</button>
      <!-- ✅ 新增 -->
      <button class="tab-btn" data-tab="t7">交易紀錄</button>
    </div>

    <div id="content"></div>
  </div>

  <!-- Auth Screen (C 專案) -->
  <div id="auth" class="auth-wrap" hidden>
    <div class="auth-title">登入管理後台（C 專案）</div>
    <div class="field">
      <label>電子郵件</label>
      <input id="email" type="text" />
    </div>
    <div class="field">
      <label>密碼</label>
      <input id="password" type="password" placeholder="••••••••" />
    </div>
    <div class="row">
      <button class="btn" id="signinBtn">登入</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </div>

  <!-- 你原本的 A 專案登入彈窗（保留可用），沒有 msg 節點也沒關係 -->
  <div id="aLoginMask" class="modal-mask" aria-hidden="true">
    <div class="modal">
      <div class="close-x" id="aLoginClose">✕</div>
      <h3>登入 A 專案</h3>
      <div class="field">
        <label>電子郵件</label>
        <input id="aEmail" type="text"/>
      </div>
      <div class="field">
        <label>密碼</label>
        <input id="aPassword" type="password" placeholder="••••••••" />
      </div>
      <div class="row">
        <button class="btn secondary" id="aLoginCancel">取消</button>
        <button class="btn" id="aLoginDo">登入</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // Supabase 客戶端（C：本庫 / A：玩家&角色）
    // ------------------------
    const C_URL = 'https://pptmmkpipwcgbxbimarp.supabase.co';
    const C_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwdG1ta3BpcHdjZ2J4YmltYXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDE5NjQsImV4cCI6MjA3MzUxNzk2NH0.E5ynYRbCKqnsppdhNZFHN4biiS-8hxhBplEG9FeUdcU';

    const A_URL = 'https://wfhwhvodgikpducrhgda.supabase.co';
    const A_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8';

    const adminClient = window.supabase.createClient(C_URL, C_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    });
    const aClient = window.supabase.createClient(A_URL, A_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // Enums（前端固定選單）
    const AREA_TYPES = ['學習','愛校','打工','特殊打工','遊戲','特製'];
    const CURRENCIES = ['一般貨幣','謝爾夏貨幣','愛校點數'];
    const isGameLike = (t) => t === '遊戲' || t === '特製';

    // 小工具
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs={}, children=[]) => {
      const n=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') n.className=v;
        else if(k==='text') n.textContent=v;
        else n.setAttribute(k,v);
      });
      children.forEach(c=>n.appendChild(c));
      return n;
    };
    const fmtTime = (s)=> s? new Date(s).toLocaleString('zh-TW', { timeZone:'Asia/Taipei' }) : '-';

    // ===== 學生下拉快取 =====
    let STUDENT_OPTIONS = [];
    async function loadStudentNames() {
      const { data, error } = await adminClient
        .from('student_cache')
        .select('student_name')
        .order('student_name', { ascending: true });
      if (error) { console.warn('[loadStudentNames]', error); return []; }
      STUDENT_OPTIONS = (data || []).map(r => r.student_name);
      return STUDENT_OPTIONS;
    }
    function makeStudentSelect(currentValue) {
      const sel = document.createElement('select');
      sel.innerHTML = '';
      if (currentValue && !STUDENT_OPTIONS.includes(currentValue)) {
        const o = document.createElement('option');
        o.value = currentValue; o.textContent = currentValue + '（未在快取清單）';
        sel.appendChild(o);
      }
      STUDENT_OPTIONS.forEach(name => {
        const o = document.createElement('option');
        o.value = name; o.textContent = name;
        if (name === currentValue) o.selected = true;
        sel.appendChild(o);
      });
      if (!currentValue && sel.options.length > 0) sel.selectedIndex = 0;
      return sel;
    }
    function makeStudentFilterSelect(currentValue='') {
      const sel = document.createElement('select');
      const all = document.createElement('option'); all.value=''; all.textContent='（全部學生）';
      sel.appendChild(all);
      STUDENT_OPTIONS.forEach(name=>{
        const o=document.createElement('option'); o.value=name; o.textContent=name;
        if (name===currentValue) o.selected=true;
        sel.appendChild(o);
      });
      return sel;
    }

    // ===== A 登入彈窗（動態保險版） =====
    function ensureALoginDOM() {
      if (document.getElementById('aLoginMask')) {
        // 綁定現有 DOM 的按鈕（若存在）
        const closeX = document.getElementById('aLoginClose'); if (closeX) closeX.addEventListener('click', closeALoginModal);
        const cancel = document.getElementById('aLoginCancel'); if (cancel) cancel.addEventListener('click', closeALoginModal);
        const doBtn  = document.getElementById('aLoginDo');    if (doBtn)  doBtn.addEventListener('click', doALogin);
        return;
      }
      // 動態建立一份（含 msg）
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div id="aLoginMask" class="modal-mask" aria-hidden="false">
          <div class="modal">
            <div class="close-x" id="aLoginClose">✕</div>
            <h3>登入 A 專案（wfhwhvodgikpducrhgda）</h3>
            <div class="field">
              <label>電子郵件</label>
              <input id="aEmail" type="text" placeholder="you@example.com" />
            </div>
            <div class="field">
              <label>密碼</label>
              <input id="aPassword" type="password" placeholder="••••••••" />
            </div>
            <div class="row">
              <span class="msg" id="aLoginMsg"></span>
              <button class="btn secondary" id="aLoginCancel">取消</button>
              <button class="btn" id="aLoginDo">登入</button>
            </div>
          </div>
        </div>
      `.trim();
      document.body.appendChild(wrap.firstElementChild);
      document.getElementById('aLoginClose').addEventListener('click', closeALoginModal);
      document.getElementById('aLoginCancel').addEventListener('click', closeALoginModal);
      document.getElementById('aLoginDo').addEventListener('click', doALogin);
    }
    function openALoginModal() {
      ensureALoginDOM();
      const mask = document.getElementById('aLoginMask');
      const msg  = document.getElementById('aLoginMsg');
      const mail = document.getElementById('aEmail');
      const pwd  = document.getElementById('aPassword');
      if (msg)  msg.textContent = '';
      if (mail) mail.value = '';
      if (pwd)  pwd.value = '';
      if (mask) { mask.style.display = 'flex'; mask.setAttribute('aria-hidden', 'false'); }
      setTimeout(() => mail && mail.focus(), 0);
    }
    function closeALoginModal() {
      const mask = document.getElementById('aLoginMask');
      if (mask) { mask.style.display = 'none'; mask.setAttribute('aria-hidden', 'true'); }
    }
    async function doALogin(){
      const msg = document.getElementById('aLoginMsg');
      const email = (document.getElementById('aEmail')?.value || '').trim();
      const password = document.getElementById('aPassword')?.value || '';
      if (msg) msg.textContent = '登入中…';
      const { error } = await aClient.auth.signInWithPassword({ email, password });
      if (error) { if (msg) msg.textContent = '登入失敗：' + (error.message || ''); return; }
      if (msg) msg.textContent = '登入成功';
      setTimeout(() => {
        closeALoginModal();
        if (window.__afterALogin) { try { window.__afterALogin(); } catch(_){} }
      }, 400);
    }
    function ensureALogin() {
      return new Promise(async (resolve) => {
        const u = await aClient.auth.getUser();
        if (u?.data?.user) return resolve(true);
        openALoginModal();
        window.__afterALogin = () => resolve(true);
        const onCancel = () => resolve(false);
        // 綁一次取消/關閉
        setTimeout(()=>{
          const cancel = document.getElementById('aLoginCancel');
          const closeX = document.getElementById('aLoginClose');
          if (cancel) cancel.addEventListener('click', onCancel, { once:true });
          if (closeX) closeX.addEventListener('click', onCancel, { once:true });
        },0);
      });
    }

    // ------------------------
    // Auth (C 專案)
    // ------------------------
    async function showUIBySession(){
      const { data } = await adminClient.auth.getSession();
      if (data?.session) {
        $('#auth').hidden = true; $('#app').hidden = false;
        const who = data.session.user?.email || data.session.user?.id;
        $('#whoami').textContent = `已登入：${who}`;
        renderTab('t1');
      } else {
        $('#app').hidden = true; $('#auth').hidden = false;
      }
    }

    $('#signinBtn').addEventListener('click', async () => {
      $('#signinBtn').disabled = true; $('#authMsg').textContent = '登入中…';
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const { error } = await adminClient.auth.signInWithPassword({ email, password });
      if (error) { $('#authMsg').textContent = '登入失敗：' + (error.message || ''); } else { $('#authMsg').textContent = '登入成功'; }
      $('#signinBtn').disabled = false; showUIBySession();
    });

    $('#signoutBtn').addEventListener('click', async () => {
      await adminClient.auth.signOut();
      showUIBySession();
    });

    // ------------------------
    // Tabs 容器
    // ------------------------
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderTab(btn.dataset.tab);
      });
    });

    async function renderTab(key){
      const c = $('#content'); c.innerHTML = '';
      if (key==='t1') return renderTab1(c);
      if (key==='t2') return renderTab2(c);
      if (key==='t3') return renderTab3(c);
      if (key==='t4') return renderTab4(c);
      if (key==='t5') return renderTab5(c);
      if (key==='t6') return renderTab6(c);
      if (key==='t7') return renderTab7(c); // ✅ 新增
    }

    // ------------------------
    // TAP1：學生快取（僅瀏覽）+ 玩家綁定（設定 DCID/is_admin）
    // ------------------------
    async function renderTab1(root){
      const bar = el('div', {class:'toolbar'});
      const syncBtn = el('button', {class:'btn'}, [document.createTextNode('↻ 從 A 專案同步：玩家 + 過審角色')]);
      const msg = el('span', {class:'muted'});
      bar.append(syncBtn, msg);

      // 左：學生快取
      const left = el('div', {class:'card grow'});
      left.append(el('div', {class:'row'}, [el('strong', {text:'學生快取（只讀）'}), el('span', {class:'chip', text:'student_cache'})] ));
      const leftTableWrap = el('div', {class:'table-wrap'});
      const leftTable = el('table');
      leftTable.innerHTML = `
        <thead><tr>
          <th>student_id</th><th>student_name</th><th>player_id</th><th>更新時間</th>
        </tr></thead><tbody id="t1-students"></tbody>`;
      leftTableWrap.append(leftTable); left.append(leftTableWrap);

      // 右：玩家綁定
      const right = el('div', {class:'card grow'});
      right.append(el('div', {class:'row'}, [el('strong', {text:'玩家綁定（DCID / 管理員）'}), el('span', {class:'chip', text:'player_links'})] ));
      const filter = el('input', {type:'text', placeholder:'搜尋玩家名稱/ID…', style:'min-width:200px'});
      const listBtn = el('button', {class:'btn secondary small'}, [document.createTextNode('重新載入')]);
      const rightBar = el('div', {class:'toolbar'}); rightBar.append(filter, listBtn);
      const rightTableWrap = el('div', {class:'table-wrap'});
      const rightTable = el('table');
      rightTable.innerHTML = `
        <thead><tr>
          <th>player_id</th><th>玩家名稱</th><th>DCID</th><th>管理員</th><th></th>
        </tr></thead><tbody id="t1-players"></tbody>`;
      rightTableWrap.append(rightTable); right.append(rightBar, rightTableWrap);

      const rowWrap = el('div', {class:'row'}); rowWrap.append(left, right);
      root.append(bar, rowWrap);

      // 同步：先確保 A 已登入
      syncBtn.addEventListener('click', async () => {
        syncBtn.disabled = true; msg.textContent = '檢查 A 專案登入狀態…';
        const ok = await ensureALogin();
        if (!ok) { msg.textContent = '已取消（未登入 A 專案）'; syncBtn.disabled = false; return; }

        msg.textContent = '同步中（讀 A → 寫 C）…';
        try {
          const players = await fetchAllPlayersFromA();
          const students = await fetchApprovedStudentsFromA();
          await upsertPlayersToC(players);
          await upsertStudentsToC(students);
          msg.textContent = `同步完成：玩家 ${players.length} 筆、過審角色 ${students.length} 筆。`;
          loadT1();
        } catch(e){ console.error(e); msg.textContent = '同步失敗：'+(e.message||e); }
        finally { syncBtn.disabled = false; }
      });

      listBtn.addEventListener('click', loadT1);
      filter.addEventListener('input', () => renderPlayersT1(window.__T1_PLAYERS || [], filter.value));

      async function loadT1(){
        await Promise.all([loadStudents(), loadPlayers()]);
      }
      async function loadStudents(){
        const { data, error } = await adminClient.from('student_cache').select('*').order('student_name', {ascending:true});
        const tb = $('#t1-students'); tb.innerHTML = '';
        if (error) { tb.innerHTML = `<tr><td colspan=4 class="err">讀取錯誤：${error.message}</td></tr>`; return; }
        (data||[]).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="mono">${r.student_id}</td><td>${r.student_name}</td><td class="mono">${r.player_id}</td><td>${fmtTime(r.updated_at)}</td>`;
          tb.appendChild(tr);
        });
      }
      async function loadPlayers(){
        const { data, error } = await adminClient.from('player_links').select('*').order('player_name',{ascending:true});
        if (error) { renderPlayersT1([], ''); return; }
        window.__T1_PLAYERS = data||[]; renderPlayersT1(window.__T1_PLAYERS, filter.value);
      }
      function renderPlayersT1(rows, q){
        const tb = $('#t1-players'); tb.innerHTML = '';
        const kw = (q||'').toLowerCase();
        rows.filter(r => !kw || (String(r.player_name||'').toLowerCase().includes(kw) || String(r.player_id||'').toLowerCase().includes(kw)))
            .forEach(r => tb.appendChild(playerRow(r)));
      }
      function playerRow(r){
        const tr = document.createElement('tr');
        const dc = el('input', {type:'text', value: r.discord_user_id || '', placeholder:'DCID'});
        const admin = el('input', {type:'checkbox'}); admin.checked = !!r.is_admin;
        const save = el('button', {class:'btn small'}, [document.createTextNode('儲存')]);
        const del = el('button', {class:'btn secondary small'}, [document.createTextNode('清空 DCID')]);
        tr.appendChild(el('td', {class:'mono', text:r.player_id}));
        tr.appendChild(el('td', {text:r.player_name||'-'}));
        const tdc = document.createElement('td'); tdc.appendChild(dc); tr.appendChild(tdc);
        const tadmin = document.createElement('td'); tadmin.appendChild(admin); tr.appendChild(tadmin);
        const tbtn = document.createElement('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);
        save.addEventListener('click', async () => {
          save.disabled = true;
          const { error } = await adminClient.from('player_links').update({ discord_user_id: dc.value||null, is_admin: admin.checked }).eq('player_id', r.player_id);
          save.disabled = false; if (!error) save.textContent='已儲存'; else save.textContent='失敗'; setTimeout(()=>save.textContent='儲存', 1200);
        });
        del.addEventListener('click', async () => {
          dc.value=''; await adminClient.from('player_links').update({ discord_user_id:null }).eq('player_id', r.player_id);
        });
        return tr;
      }

      // A 專案：抓全部玩家/過審角色
      async function fetchAllPlayersFromA(){
        const out=[]; let from=0, step=1000; while(true){
          const { data, error } = await aClient.from('players').select('player_id, username').range(from, from+step-1);
          if (error) throw error; if (!data || data.length===0) break; out.push(...data); if (data.length<step) break; from+=step;
        } return out;
      }
      async function fetchApprovedStudentsFromA(){
        const out=[]; let from=0, step=1000; while(true){
          const { data, error } = await aClient.from('students').select('student_id, name, player_id, student_code').not('student_code','is',null).order('name',{ascending:true}).range(from, from+step-1);
          if (error) throw error; if (!data || data.length===0) break; out.push(...data); if (data.length<step) break; from+=step;
        } return out;
      }
      async function upsertPlayersToC(rows){
        if (!rows.length) return; const payload = rows.map(x=>({ player_id: x.player_id, player_name: x.username }));
        const { error } = await adminClient.from('player_links').upsert(payload, { onConflict:'player_id' }); if (error) throw error;
      }
      async function upsertStudentsToC(rows){
        if (!rows.length) return; const payload = rows.map(x=>({ student_id: x.student_id, student_name: x.name, player_id: x.player_id }));
        const { error } = await adminClient.from('student_cache').upsert(payload, { onConflict:'student_id' }); if (error) throw error;
      }

      loadT1();
    }

    // ------------------------
    // TAP2：地區表 CRUD（含 遊戲/特製 機制欄位）
    // ------------------------
    async function renderTab2(root){
      const wrap = el('div', {class:'card'});

      // 新增區塊
      const form = el('div', {class:'grid grid-4'});
      const f_name = el('input', {type:'text', placeholder:'地區顯示名稱'});
      const f_type = el('select'); AREA_TYPES.forEach(v=>f_type.appendChild(el('option',{value:v,text:v})));
      const f_thread = el('input', {type:'text', placeholder:'Discord Thread ID（可空）'});
      const f_hook = el('input', {type:'text', placeholder:'Webhook URL（可空）'});
      const f_limit = el('input', {type:'number', placeholder:'每日上限（愛校用，可空）'});

      // 機制欄位（遊戲/特製才用）
      const f_mech_label = el('input', {type:'text', placeholder:'機制名稱（遊戲/特製才需要）'});
      const f_mech_code  = el('input', {type:'text', placeholder:'機制代碼（遊戲/特製才需要）'});
      const mechHint = el('div', {class:'help', text:'只有型別為「遊戲」或「特製」時才會使用這兩個欄位'});
      const addBtn = el('button',{class:'btn'},[document.createTextNode('新增地區')]);

      function toggleCreateMechanicFields(){
        const on = isGameLike(f_type.value);
        f_mech_label.style.display = on ? '' : 'none';
        f_mech_code.style.display  = on ? '' : 'none';
        mechHint.style.display     = on ? 'block' : 'none';
      }

      form.append(f_name, f_type, f_thread, f_hook, f_limit, f_mech_label, f_mech_code, addBtn);
      wrap.append(el('div',{class:'row'},[el('strong',{text:'地區管理'}), el('span',{class:'chip',text:'area'})]));
      wrap.append(form, mechHint);

      // 一覽表
      const list = el('div', {class:'table-wrap', style:'margin-top:10px'});
      list.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>名稱</th><th>型別</th><th>Thread</th><th>Webhook</th><th>上限</th>
              <th>機制名稱（遊戲/特製）</th><th>機制代碼（遊戲/特製）</th><th></th>
            </tr>
          </thead>
          <tbody id="areasBody"></tbody>
        </table>`;
      root.append(wrap, list);

      toggleCreateMechanicFields();
      f_type.addEventListener('change', toggleCreateMechanicFields);

      addBtn.addEventListener('click', async () => {
        addBtn.disabled = true;
        const body = {
          area_name: f_name.value.trim(),
          area_type: f_type.value,
          dc_thread_id: f_thread.value || null,
          webhook_url: f_hook.value || null,
          daily_limit: f_limit.value? Number(f_limit.value): null
        };
        if (isGameLike(f_type.value)) {
          body.mechanic_label = (f_mech_label.value || null);
          body.mechanic_code  = (f_mech_code.value  || null);
        }
        const { error } = await adminClient.from('area').insert(body);
        addBtn.disabled = false;
        if (!error){
          f_name.value=''; f_thread.value=''; f_hook.value=''; f_limit.value='';
          f_mech_label.value=''; f_mech_code.value='';
          loadAreas();
        }
      });

      async function loadAreas(){
        const { data } = await adminClient.from('area').select('*').order('area_name',{ascending:true});
        const tb = $('#areasBody'); tb.innerHTML='';
        (data||[]).forEach(r=>tb.appendChild(areaRow(r)));
      }

      function areaRow(r){
        const tr = document.createElement('tr');
        const name = el('input',{type:'text', value:r.area_name});
        const type = el('select'); AREA_TYPES.forEach(v=>{ const o=el('option',{value:v,text:v}); if(v===r.area_type) o.selected=true; type.appendChild(o); });
        const t = el('input',{type:'text', value:r.dc_thread_id||''});
        const w = el('input',{type:'text', value:r.webhook_url||''});
        const lim = el('input',{type:'number', value: r.daily_limit==null?'':r.daily_limit});

        const mechLabel = el('input',{type:'text', value: r.mechanic_label || ''});
        const mechCode  = el('input',{type:'text', value: r.mechanic_code  || ''});

        const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
        const del = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);

        const tdName = el('td',{},[name]);
        const tdType = el('td',{},[type]);
        const tdT = el('td',{},[t]);
        const tdW = el('td',{},[w]);
        const tdLim = el('td',{},[lim]);
        const tdMechLabel = el('td',{},[mechLabel]);
        const tdMechCode  = el('td',{},[mechCode]);
        const tbtn = el('td'); tbtn.append(save,' ',del);

        tr.append(tdName, tdType, tdT, tdW, tdLim, tdMechLabel, tdMechCode, tbtn);

        const toggleRowMechanic = ()=>{
          const on = isGameLike(type.value);
          tdMechLabel.style.display = on ? '' : 'none';
          tdMechCode.style.display  = on ? '' : 'none';
        };
        toggleRowMechanic();
        type.addEventListener('change', toggleRowMechanic);

        save.addEventListener('click', async ()=>{
          save.disabled=true;
          const body = {
            area_name: name.value.trim(),
            area_type: type.value,
            dc_thread_id: t.value || null,
            webhook_url: w.value || null,
            daily_limit: lim.value ? Number(lim.value) : null,
            mechanic_label: null,
            mechanic_code: null
          };
          if (isGameLike(type.value)) {
            body.mechanic_label = mechLabel.value || null;
            body.mechanic_code  = mechCode.value  || null;
          }
          const { error } = await adminClient.from('area').update(body).eq('area_id', r.area_id);
          save.disabled=false; if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
        });

        del.addEventListener('click', async ()=>{
          if (!confirm('確定刪除？')) return;
          const { error } = await adminClient.from('area').delete().eq('area_id', r.area_id);
          if (!error) tr.remove();
        });

        return tr;
      }

      loadAreas();
    }

// ------------------------
// TAP3：倍率管理（改用 earn_current_rate）
// 表結構：earn_current_rate(kind PRIMARY KEY, rate int, currency enum, updated_at)
// 三組：一般打工→一般貨幣；特殊打工→謝爾夏貨幣；愛校服務→愛校點數
// ------------------------
async function renderTab3(root){
  const wrap = el('div',{class:'card'});

  // 三個輸入框
  const f_work = el('input',{type:'number', min:0, placeholder:'一般打工｜每小時 → 一般貨幣（例：100）'});
  const f_spec = el('input',{type:'number', min:0, placeholder:'特殊打工｜每小時 → 謝爾夏貨幣（例：5）'});
  const f_svc  = el('input',{type:'number', min:0, placeholder:'愛校服務｜每次 → 愛校點數（例：1）'});

  const save = el('button',{class:'btn'},[document.createTextNode('儲存倍率')]);
  const reload = el('button',{class:'btn secondary'},[document.createTextNode('重新載入')]);
  const info = el('span',{class:'muted'});

  wrap.append(
    el('div',{class:'row'},[
      el('strong',{text:'倍率管理'}),
      el('span',{class:'chip',text:'earn_current_rate（每種 kind 一行）'})
    ])
  );

  const grid = el('div',{class:'grid grid-4'});
  grid.append(f_work, f_spec, f_svc, save, reload);
  wrap.append(grid);

  const help = el('div',{class:'help'});
  help.innerHTML = `
    <ul style="margin:8px 0 0 18px;">
      <li>一般打工：每小時給 <b>一般貨幣</b>；</li>
      <li>特殊打工：每小時給 <b>謝爾夏貨幣</b>；</li>
      <li>愛校服務：每次給 <b>愛校點數</b>。</li>
    </ul>
  `;
  wrap.append(help, info);
  root.append(wrap);

  // 幣別文字（要跟資料庫 enum 對得上）
  const CUR = {
    work:   '一般貨幣',
    special:'謝爾夏貨幣',
    service:'愛校點數'
  };

 // 讀到的現有 kind（避免你 enum 寫法不同而 upsert 失敗）
  const existingKind = { work:null, special:null, service:null };

  function renderPreviewText(){
    const w = Number(f_work.value||0),
          s = Number(f_spec.value||0),
          p = Number(f_svc.value||0);
info.textContent =
  `一般打工：+${w} ${CUR.work}／h；\n` +
  `特殊打工：+${s} ${CUR.special}／h；\n` +
  `愛校服務：+${p} ${CUR.service}／次`;
  }
  async function load(){
    // 讀整張表，嘗試配對到三組
    const { data, error } = await adminClient
      .from('earn_current_rate')
      .select('kind, rate, currency, updated_at');

    if (error) {
      info.textContent = '讀取失敗：' + (error.message || '');
      return;
    }

    // 先清空
    f_work.value = ''; f_spec.value=''; f_svc.value=''; 
    existingKind.work = existingKind.special = existingKind.service = null;

    // 嘗試用 kind 或 currency 對應到三組
    (data||[]).forEach(r => {
      const k = String(r.kind || '').toLowerCase();
      const cur = String(r.currency || '');
      if (k === 'work' || cur === CUR.work) {
        f_work.value = r.rate;
        existingKind.work = r.kind; // 保留原樣
      } else if (k === 'special' || cur === CUR.special) {
        f_spec.value = r.rate;
        existingKind.special = r.kind;
      } else if (k === 'service' || cur === CUR.service) {
        f_svc.value = r.rate;
        existingKind.service = r.kind;
      }
    });

    // 若表本來是空的，就給個預設顯示 0，存檔時會 upsert 三行
    if (f_work.value === '') f_work.value = 0;
    if (f_spec.value === '') f_spec.value = 0;
    if (f_svc.value  === '') f_svc.value  = 0;

    renderPreviewText();
  }

  f_work.addEventListener('input', renderPreviewText);
  f_spec.addEventListener('input', renderPreviewText);
  f_svc.addEventListener('input',  renderPreviewText);

  // 儲存：沿用既有 kind 值；如果不存在，預設使用 'work'/'special'/'service'
  save.addEventListener('click', async ()=>{
    save.disabled = true;

    const rows = [
      { kind: existingKind.work    || 'work',    rate: Number(f_work.value||0), currency: CUR.work    },
      { kind: existingKind.special || 'special', rate: Number(f_spec.value||0), currency: CUR.special },
      { kind: existingKind.service || 'service', rate: Number(f_svc.value ||0), currency: CUR.service }
    ];

    const { error } = await adminClient
      .from('earn_current_rate')
      .upsert(rows, { onConflict: 'kind' });

    save.disabled = false;

    if (error) {
      // 如果是 enum 不相容，直接把錯誤顯示出來，方便你調 enum
      info.textContent = '儲存失敗（可能是 enum 不相容）：' + (error.message || '');
      return;
    }

    info.textContent = '已儲存：' + new Date().toLocaleString('zh-TW', { timeZone:'Asia/Taipei' });
    // 重新抓一次，更新 existingKind 與畫面
    load();
  });

  reload.addEventListener('click', load);
  load();
}


    // ------------------------
    // TAP4：販售道具（含簡介欄）
    // ------------------------
    async function renderTab4(root){
      const wrap = el('div',{class:'card'});
      wrap.append(el('div',{class:'row'},[el('strong',{text:'販售道具'}), el('span',{class:'chip',text:'shop_items'})]));
      const f = el('div',{class:'grid grid-4'});
      const f_name = el('input',{type:'text', placeholder:'道具名稱'});
      const f_desc = el('input',{type:'text', placeholder:'商家/商品簡介'});
      const f_type = el('select'); CURRENCIES.forEach(v=>f_type.appendChild(el('option',{value:v,text:v})));
      const f_price = el('input',{type:'number', placeholder:'售價'});
      const f_stock = el('input',{type:'number', placeholder:'庫存'});
      const f_effect = el('input',{type:'text', placeholder:'效果文字（可空）'});
      const f_code = el('input',{type:'text', placeholder:'effect_code（可空）'});
      const f_uses = el('input',{type:'number', placeholder:'可用次數（空=永久）'});
      const add = el('button',{class:'btn'},[document.createTextNode('新增')]);
      f.append(f_name,f_desc,f_type,f_price,f_stock,f_effect,f_code,f_uses,add);

      const list = el('div',{class:'table-wrap', style:'margin-top:10px'});
      list.innerHTML = `<table><thead><tr><th>名稱</th><th>簡介</th><th>幣別</th><th>售價</th><th>庫存</th><th>效果</th><th>程式碼</th><th>可用次數</th><th></th></tr></thead><tbody id="shopBody"></tbody></table>`;
      wrap.append(f, list); root.append(wrap);

      add.addEventListener('click', async ()=>{
        add.disabled=true;
        const body={ item_name:f_name.value.trim(), shop_desc:f_desc.value||null, price_type:f_type.value, price:Number(f_price.value||0), stock:Number(f_stock.value||0), item_effect:f_effect.value||null, effect_code:f_code.value||null, max_uses: f_uses.value? Number(f_uses.value): null };
        const { error } = await adminClient.from('shop_items').insert(body);
        add.disabled=false; if(!error){ f_name.value=f_desc.value=f_effect.value=f_code.value=''; f_price.value=f_stock.value=f_uses.value=''; load(); }
      });

      async function load(){
        const { data } = await adminClient.from('shop_items').select('*').order('item_name',{ascending:true});
        const tb = $('#shopBody'); tb.innerHTML=''; (data||[]).forEach(r=>tb.appendChild(row(r)));
      }
      function row(r){
        const tr = document.createElement('tr');
        const name = el('input',{type:'text', value:r.item_name});
        const desc = el('input',{type:'text', value:r.shop_desc||''});
        const type = el('select'); CURRENCIES.forEach(v=>{ const o=el('option',{value:v,text:v}); if(v===r.price_type) o.selected=true; type.appendChild(o);});
        const price = el('input',{type:'number', value:r.price});
        const stock = el('input',{type:'number', value:r.stock});
        const eff = el('input',{type:'text', value:r.item_effect||''});
        const code = el('input',{type:'text', value:r.effect_code||''});
        const uses = el('input',{type:'number', value: r.max_uses==null?'':r.max_uses});
        const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
        const del = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);
        tr.append(el('td',{},[name]), el('td',{},[desc]), el('td',{},[type]), el('td',{},[price]), el('td',{},[stock]), el('td',{},[eff]), el('td',{},[code]), el('td',{},[uses]));
        const tbtn = el('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);
        save.addEventListener('click', async()=>{
          save.disabled=true;
          const body={ item_name:name.value.trim(), shop_desc:desc.value||null, price_type:type.value, price:Number(price.value||0), stock:Number(stock.value||0), item_effect:eff.value||null, effect_code:code.value||null, max_uses: uses.value? Number(uses.value): null };
          const { error } = await adminClient.from('shop_items').update(body).eq('id', r.id);
          save.disabled=false;
          if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
        });
        del.addEventListener('click', async()=>{ if(!confirm('確定刪除？')) return; const { error } = await adminClient.from('shop_items').delete().eq('id', r.id); if(!error) tr.remove(); });
        return tr;
      }
      load();
    }

    // ------------------------
    // TAP5：戰鬥攜帶物（學生名稱下拉）
    // ------------------------
    async function renderTab5(root){
      await loadStudentNames();
      const wrap = el('div',{class:'card'});
      wrap.append(el('div',{class:'row'},[el('strong',{text:'戰鬥攜帶物'}), el('span',{class:'chip',text:'battle_items'})]));
      const f = el('div',{class:'grid grid-4'});
      const f_student = makeStudentSelect();
      const f_slot = el('input',{type:'number', placeholder:'欄位 1-4', min:1, max:4});
      const f_name = el('input',{type:'text', placeholder:'裝備名稱'});
      const f_effect = el('input',{type:'text', placeholder:'效果文字（可空）'});
      const f_uses = el('input',{type:'number', placeholder:'剩餘可用次數（空=永久）'});
      const f_lock = el('select'); ['false','true'].forEach(v=>f_lock.appendChild(el('option',{value:v,text: v==='true'?'裝備後鎖定':'可回收'})));
      const add = el('button',{class:'btn'},[document.createTextNode('新增')]);
      f.append(f_student,f_slot,f_name,f_effect,f_uses,f_lock,add);

      const list = el('div',{class:'table-wrap',style:'margin-top:10px'});
      list.innerHTML = `<table><thead><tr><th>角色</th><th>欄位</th><th>裝備</th><th>效果</th><th>可用次數</th><th>鎖定</th><th></th></tr></thead><tbody id="battleBody"></tbody></table>`;
      wrap.append(f,list); root.append(wrap);

      add.addEventListener('click', async ()=>{
        add.disabled=true;
        const body={
          student_name: f_student.value,
          slot:Number(f_slot.value||0),
          item_name:f_name.value.trim(),
          item_effect:f_effect.value||null,
          uses_left: f_uses.value? Number(f_uses.value): null,
          locked_until_broken: f_lock.value==='true'
        };
        const { error } = await adminClient.from('battle_items').insert(body);
        add.disabled=false; if(!error){ f_slot.value=f_name.value=f_effect.value=f_uses.value=''; load(); }
      });

      async function load(){
        const { data } = await adminClient.from('battle_items').select('*').order('student_name',{ascending:true}).order('slot',{ascending:true});
        const tb=$('#battleBody'); tb.innerHTML='';
        (data||[]).forEach(r=>tb.appendChild(row(r)));
      }
      function row(r){
        const tr = document.createElement('tr');
        const stu = makeStudentSelect(r.student_name);
        const slot = el('input',{type:'number', value:r.slot, min:1, max:4});
        const name = el('input',{type:'text', value:r.item_name});
        const eff = el('input',{type:'text', value:r.item_effect||''});
        const uses = el('input',{type:'number', value: r.uses_left==null?'':r.uses_left});
        const lock = el('select'); ['false','true'].forEach(v=>{ const o=el('option',{value:v,text: v==='true'?'鎖定':'可回收'}); if(String(r.locked_until_broken)===v) o.selected=true; lock.appendChild(o);});
        const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
        const del = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);
        tr.append(el('td',{},[stu]), el('td',{},[slot]), el('td',{},[name]), el('td',{},[eff]), el('td',{},[uses]), el('td',{},[lock]));
        const tbtn=el('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);
        save.addEventListener('click', async()=>{
          save.disabled=true;
          const body={
            student_name: stu.value,
            slot:Number(slot.value||0),
            item_name:name.value.trim(),
            item_effect:eff.value||null,
            uses_left: uses.value? Number(uses.value): null,
            locked_until_broken: lock.value==='true'
          };
          const { error } = await adminClient.from('battle_items').update(body).eq('id', r.id);
          save.disabled=false; if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
        });
        del.addEventListener('click', async()=>{ if(!confirm('確定刪除？')) return; const { error } = await adminClient.from('battle_items').delete().eq('id', r.id); if(!error) tr.remove(); });
        return tr;
      }
      load();
    }

    // ------------------------
    // TAP6：教師文本（僅學習地區）
    // ------------------------
    async function renderTab6(root){
      const wrap = el('div',{class:'card'});
      wrap.append(el('div',{class:'row'},[el('strong',{text:'教師文本'}), el('span',{class:'chip',text:'teacher_texts'})]));

      // 先抓【學習】地區
      const { data: areas } = await adminClient.from('area').select('area_id, area_name').eq('area_type','學習').order('area_name',{ascending:true});
      const areaMap = new Map((areas||[]).map(a=>[a.area_id, a.area_name]));

      const f = el('div',{class:'grid grid-4'});
      const f_area = el('select'); (areas||[]).forEach(a=> f_area.appendChild(el('option',{value:a.area_id, text:a.area_name})) );
      const f_course = el('input',{type:'text', placeholder:'課程名稱'});
      const f_text = el('textarea',{placeholder:'老師回應內容（台詞）'});
      const add = el('button',{class:'btn'},[document.createTextNode('新增')]);
      f.append(f_area,f_course,f_text,add);

      const list = el('div',{class:'table-wrap',style:'margin-top:10px'});
      list.innerHTML = `<table><thead><tr><th>地區</th><th>課程</th><th>台詞</th><th></th></tr></thead><tbody id="teacherBody"></tbody></table>`;
      wrap.append(f, list); root.append(wrap);

      add.addEventListener('click', async ()=>{
        add.disabled=true; const body={ area_id:f_area.value, course_name:f_course.value.trim(), reply_text:f_text.value };
        const { error } = await adminClient.from('teacher_texts').insert(body); add.disabled=false; if(!error){ f_text.value=f_course.value=''; load(); }
      });

      async function load(){
        const { data } = await adminClient.from('teacher_texts').select('*').order('area_id',{ascending:true}).order('course_name',{ascending:true});
        const tb = $('#teacherBody'); tb.innerHTML=''; (data||[]).forEach(r=>tb.appendChild(row(r)));
      }
      function row(r){
        const tr = document.createElement('tr');
        const areaName = areaMap.get(r.area_id) || r.area_id;
        const areaSpan = el('span',{text:areaName});
        const course = el('input',{type:'text', value:r.course_name});
        const text = el('textarea'); text.value = r.reply_text||''; text.style.minWidth='280px';
        const save = el('button',{class:'btn small'},[document.createTextNode('儲存')]);
        const del = el('button',{class:'btn secondary small'},[document.createTextNode('刪除')]);
        tr.append(el('td',{},[areaSpan]), el('td',{},[course]), el('td',{},[text]));
        const tbtn=el('td'); tbtn.append(save,' ',del); tr.appendChild(tbtn);
        save.addEventListener('click', async()=>{
          save.disabled=true; const body={ course_name:course.value.trim(), reply_text:text.value };
          const { error } = await adminClient.from('teacher_texts').update(body).eq('id', r.id); save.disabled=false; if(!error){ save.textContent='已儲存'; setTimeout(()=>save.textContent='儲存',1000); }
        });
        del.addEventListener('click', async()=>{ if(!confirm('確定刪除？')) return; const { error } = await adminClient.from('teacher_texts').delete().eq('id', r.id); if(!error) tr.remove(); });
        return tr;
      }
      load();
    }

// ------------------------
// TAP7：交易紀錄（活動獎勵 / 折扣 / 購買）
// item = shop_items.item_name 或 NULL
// 插入 transaction_log 後，DB Trigger 會：若 item != NULL → shop_items.stock -1、inventory +1
// ------------------------
async function renderTab7(root){
  await loadStudentNames(); // 取學生下拉

  // 取可選道具（只顯示庫存 > 0 比較直覺，你也可改成全部顯示）
  const { data: items } = await adminClient
    .from('shop_items')
    .select('item_name, stock')
    .order('item_name', { ascending:true });

  const wrap = el('div', {class:'card'});
  wrap.append(el('div',{class:'row'},[
    el('strong',{text:'交易紀錄'}),
    el('span',{class:'chip',text:'transaction_log'})
  ]));

  // 表單欄位
  const f_student  = makeStudentSelect(); // 學生
  const f_action   = el('input', {type:'text', placeholder:'動作說明（例：活動獎勵／購買商品）'});
  const f_currency = el('select'); CURRENCIES.forEach(v => f_currency.appendChild(el('option',{value:v,text:v})));
  const f_sign     = el('select'); [{v:'credit',t:'增加(入帳)'},{v:'debit',t:'扣除(出帳)'}].forEach(o=>f_sign.appendChild(el('option',{value:o.v,text:o.t})));
  const f_amount   = el('input', {type:'number', min:0, placeholder:'金額'});

  const f_item     = el('select');
  // 第一個選項：無道具（= NULL）
  f_item.appendChild(el('option',{value:'',text:'（無道具）'}));
  (items||[]).forEach(it=>{
    // 你若只想列出有庫存的，可加條件 (it.stock > 0)
    f_item.appendChild(el('option',{value:it.item_name, text:`${it.item_name}${(it.stock!=null?`（庫存${it.stock}）`:'')}`}));
  });

  const btn = el('button',{class:'btn'},[document.createTextNode('新增交易')]);
  const msg = el('span',{class:'muted'});

  const form = el('div',{class:'grid grid-4'});
  form.append(f_student, f_action, f_currency, f_sign, f_amount, f_item, btn);
  wrap.append(form, el('div',{class:'help',text:'選了道具後：會自動扣 shop_items 庫存 1 並把道具加到該學生的背包'}), msg);
  root.append(wrap);

  // 一覽（最近 50 筆）
  const list = el('div',{class:'table-wrap',style:'margin-top:10px'});
  list.innerHTML = `
    <table>
      <thead><tr>
        <th>時間</th><th>學生</th><th>幣別</th><th>＋入帳</th><th>－出帳</th><th>道具</th><th>說明</th>
      </tr></thead>
      <tbody id="txBody"></tbody>
    </table>`;
  root.append(list);

  btn.addEventListener('click', async ()=>{
    const amount = Number(f_amount.value||0);
    if (!amount || amount < 0) { msg.textContent = '請輸入正確金額'; return; }

    const body = {
      student_name: f_student.value,
      action: (f_action.value||'').trim() || '手動交易',
      type: f_currency.value,              // enum：一般貨幣／謝爾夏貨幣／愛校點數
      debit:  (f_sign.value==='debit')  ? amount : 0,
      credit: (f_sign.value==='credit') ? amount : 0,
      item: f_item.value || null          // '' → NULL
    };

    btn.disabled = true; msg.textContent = '寫入中…';
    const { error } = await adminClient.from('transaction_log').insert(body).select('id').single();
    btn.disabled = false;

    if (error) {
      msg.textContent = '失敗：' + (error.message || '');
    } else {
      msg.textContent = '完成！(已寫入交易；如有道具會自動扣庫存與加背包)';
      f_action.value=''; f_amount.value='';
      await loadList(); // 重新載入下方一覽
    }
  });

  async function loadList(){
    const { data, error } = await adminClient
      .from('transaction_log')
      .select('created_at, student_name, type, debit, credit, item, action')
      .order('created_at', { ascending:false })
      .limit(50);
    const tb = document.getElementById('txBody'); tb.innerHTML='';
    if (error) { tb.innerHTML = `<tr><td colspan="7" class="err">讀取失敗：${error.message}</td></tr>`; return; }
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtTime(r.created_at)}</td>
        <td>${r.student_name}</td>
        <td>${r.type}</td>
        <td>${r.credit||0}</td>
        <td>${r.debit||0}</td>
        <td>${r.item || '-'}</td>
        <td>${r.action || '-'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  loadList();
}



    // ------------------------
    // 初始化
    // ------------------------
    showUIBySession();
  </script>
</body>
</html>
