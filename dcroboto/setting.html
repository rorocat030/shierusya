<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>謝爾夏｜管理面板</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC:400,700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --name-w: auto; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #f2f6fb;
      margin: 0; padding: 0;
    }
    header {
      background: #143158; color:#fff; padding: 14px 18px; box-shadow: 0 2px 8px #0003;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: .5px; }
    .container { max-width: 1200px; margin: 20px auto 60px auto; padding: 16px; }
    .card {
      background: #fff; border-radius: 12px; box-shadow: 0 2px 16px #0001; padding: 16px;
      margin-bottom: 16px;
    }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    .tab-btn{ border:none; background:#e9f1f9; color:#143158; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .tab-btn.active{ background:#1767a0; color:#fff; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > .field { display:flex; flex-direction:column; gap:4px; }
    label { font-size:12px; color:#3a4b5f; }
    input, select, textarea { padding:8px 10px; border:1px solid #d6e1ee; border-radius:8px; outline:none; }
    textarea { min-height: 80px; }
    .btn { border:none; background:#1767a0; color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.secondary { background:#143158; }
    .btn.ghost { background:#e9f1f9; color:#143158; }
    .btn.danger { background:#b42318; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    table { width:100%; border-collapse:collapse; border:1px solid #e6eef6; border-radius:10px; overflow:hidden; }
    thead { background:#ddebf7; }
    th, td { padding:10px; text-align:left; border-bottom:1px solid #eef3f9; vertical-align: middle; }
    tbody tr:hover { background:#f6fbff; }
    .right { text-align:right; }
    .muted { color:#667; font-size:12px; }

    .login { max-width: 420px; margin: 60px auto; }
    .hidden { display:none !important; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; font-size:12px; background:#eef4ff; color:#143158; }
    .status-ok { color:#0a7d34; }
    .status-bad { color:#b42318; }

    .divider { height:1px; background:#eef3f9; margin:10px 0; }
    .grow { flex: 1 1 auto; }

    .table-scroll { max-height: 480px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <h1>謝爾夏｜管理面板</h1>
    <div id="authBox" class="muted"></div>
  </header>
  <div class="container">

    <!-- 登入 -->
    <div id="loginView" class="card login">
      <h3>登入</h3>
      <div class="row">
        <div class="field grow">
          <label>電子郵件</label>
          <input id="email" placeholder="you@example.com" />
        </div>
        <div class="field grow">
          <label>密碼</label>
          <input id="password" type="password" placeholder="你的密碼" />
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px;">
        <button id="btnLogin" class="btn">登入</button>
        <span class="muted">僅顯示已登入者管理畫面</span>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- 管理畫面 -->
    <div id="adminView" class="hidden">
      <div class="card">
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab1">玩家/學生</button>
          <button class="tab-btn" data-tab="tab2">地區</button>
          <button class="tab-btn" data-tab="tab3">時薪設定</button>
          <button class="tab-btn" data-tab="tab4">販售道具</button>
          <button class="tab-btn" data-tab="tab5">戰鬥攜帶物</button>
          <button class="tab-btn" data-tab="tab6">教師文本</button>
        </div>
      </div>

      <!-- TAB 1: 玩家/學生 -->
      <div id="tab1" class="card">
        <div class="toolbar">
          <div class="grow"><strong>學生快取／玩家綁定</strong></div>
          <button id="btnSyncApproved" class="btn secondary">從 A 專案同步</button>
          <span id="syncStatus" class="muted"></span>
        </div>
        <div class="divider"></div>
        <div class="row">
          <div class="field grow">
            <label>搜尋（玩家名稱 / 角色名稱 / DCID）</label>
            <input id="searchTab1" placeholder="輸入關鍵字" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="btnRefreshTab1" class="btn ghost">重新整理</button>
          </div>
        </div>
        <div class="row">
          <div class="field grow">
            <h4>玩家綁定（player_links）</h4>
            <div class="table-scroll">
              <table id="tablePlayerLinks">
                <thead><tr>
                  <th>玩家ID</th>
                  <th>玩家名稱</th>
                  <th>DCID</th>
                  <th>管理員</th>
                  <th class="right">操作</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <div class="field grow">
            <h4>學生快取（student_cache）</h4>
            <div class="table-scroll">
              <table id="tableStudentCache">
                <thead><tr>
                  <th>學生ID</th>
                  <th>學生名稱</th>
                  <th>玩家ID</th>
                </tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: 地區表 -->
      <div id="tab2" class="card hidden">
        <div class="toolbar"><div class="grow"><strong>地區表</strong></div><button id="btnRefreshTab2" class="btn ghost">重新整理</button></div>
        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label>地區顯示名稱</label>
            <input id="areaName" />
          </div>
          <div class="field">
            <label>型別</label>
            <select id="areaType">
              <option value="學習">學習</option>
              <option value="愛校">愛校</option>
              <option value="打工">打工</option>
              <option value="特殊打工">特殊打工</option>
              <option value="遊戲">遊戲</option>
            </select>
          </div>
          <div class="field">
            <label>Discord 討論串 ID</label>
            <input id="areaThread" />
          </div>
          <div class="field">
            <label>Webhook URL</label>
            <input id="areaWebhook" />
          </div>
          <div class="field">
            <label>每日上限（愛校）</label>
            <input id="areaDailyLimit" type="number" />
          </div>
          <div class="field" style="align-self:flex-end;">
            <button id="btnAddArea" class="btn">新增地區</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="table-scroll">
          <table id="tableArea">
            <thead><tr>
              <th>地區名稱</th>
              <th>型別</th>
              <th>Thread</th>
              <th>Webhook</th>
              <th>每日上限</th>
              <th class="right">操作</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- TAB 3: 時薪設定 -->
      <div id="tab3" class="card hidden">
        <div class="toolbar"><div class="grow"><strong>時薪設定（config_id=1）</strong></div><button id="btnRefreshTab3" class="btn ghost">重新整理</button></div>
        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label>一般打工時薪</label>
            <input id="wageWork" type="number" />
          </div>
          <div class="field">
            <label>特殊打工時薪</label>
            <input id="wageSpecial" type="number" />
          </div>
          <div class="field" style="align-self:flex-end;">
            <button id="btnSaveWage" class="btn">儲存</button>
          </div>
        </div>
        <div id="wageInfo" class="muted" style="margin-top:8px;"></div>
      </div>

      <!-- TAB 4: 販售道具 -->
      <div id="tab4" class="card hidden">
        <div class="toolbar"><div class="grow"><strong>販售道具</strong></div><button id="btnRefreshTab4" class="btn ghost">重新整理</button></div>
        <div class="row" style="margin-top:8px;">
          <div class="field"><label>道具名稱</label><input id="shopItemName" /></div>
          <div class="field"><label>貨幣類型</label>
            <select id="shopPriceType">
              <option value="一般貨幣">一般貨幣</option>
              <option value="謝爾夏貨幣">謝爾夏貨幣</option>
              <option value="愛校點數">愛校點數</option>
            </select>
          </div>
          <div class="field"><label>售價</label><input id="shopPrice" type="number" /></div>
          <div class="field"><label>庫存</label><input id="shopStock" type="number" value="0" /></div>
          <div class="field grow"><label>效果文案</label><input id="shopEffect" /></div>
          <div class="field"><label>效果程式碼</label><input id="shopEffectCode" /></div>
          <div class="field"><label>可用次數</label><input id="shopMaxUses" type="number" /></div>
          <div class="field" style="align-self:flex-end;"><button id="btnAddShopItem" class="btn">新增</button></div>
        </div>
        <div class="divider"></div>
        <div class="table-scroll">
          <table id="tableShop">
            <thead><tr>
              <th>名稱</th><th>貨幣</th><th>價</th><th>庫存</th><th>效果</th><th>代碼</th><th>次數</th><th class="right">操作</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- TAB 5: 戰鬥攜帶物 -->
      <div id="tab5" class="card hidden">
        <div class="toolbar"><div class="grow"><strong>戰鬥攜帶物</strong></div><button id="btnRefreshTab5" class="btn ghost">重新整理</button></div>
        <div class="row" style="margin-top:8px;">
          <div class="field"><label>學生名稱</label><input id="battleStudent" /></div>
          <div class="field"><label>欄位(1–4)</label><input id="battleSlot" type="number" min="1" max="4" /></div>
          <div class="field"><label>裝備名稱</label><input id="battleItemName" /></div>
          <div class="field"><label>剩餘次數</label><input id="battleUses" type="number" /></div>
          <div class="field"><label>裝備文案</label><input id="battleEffect" /></div>
          <div class="field"><label>裝備鎖定</label>
            <select id="battleLocked">
              <option value="false">否</option>
              <option value="true">是</option>
            </select>
          </div>
          <div class="field" style="align-self:flex-end;"><button id="btnAddBattleItem" class="btn">新增</button></div>
        </div>
        <div class="divider"></div>
        <div class="table-scroll">
          <table id="tableBattle">
            <thead><tr>
              <th>學生</th><th>欄位</th><th>名稱</th><th>次數</th><th>文案</th><th>鎖定</th><th class="right">操作</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- TAB 6: 教師文本 -->
      <div id="tab6" class="card hidden">
        <div class="toolbar"><div class="grow"><strong>教師文本</strong></div><button id="btnRefreshTab6" class="btn ghost">重新整理</button></div>
        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label>地區（僅顯示「學習」型別）</label>
            <select id="teacherArea"></select>
          </div>
          <div class="field"><label>課程名稱</label><input id="teacherCourse" /></div>
          <div class="field grow"><label>老師回應內容（台詞）</label><input id="teacherText" /></div>
          <div class="field" style="align-self:flex-end;"><button id="btnAddTeacherText" class="btn">新增台詞</button></div>
        </div>
        <div class="divider"></div>
        <div class="table-scroll">
          <table id="tableTeacher">
            <thead><tr>
              <th>地區</th><th>課程</th><th>台詞</th><th class="right">操作</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

<script>
// ================== 專案設定 ==================
// C：本專案（管理面板操作的 DB）
const C_URL = 'https://pptmmkpipwcgbxbimarp.supabase.co';
const C_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwdG1ta3BpcHdjZ2J4YmltYXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NDE5NjQsImV4cCI6MjA3MzUxNzk2NH0.E5ynYRbCKqnsppdhNZFHN4biiS-8hxhBplEG9FeUdcU';
const DB = window.supabase.createClient(C_URL, C_ANON);

// A：登入/角色 專案（抓玩家/過審角色）
const A_URL = 'https://wfhwhvodgikpducrhgda.supabase.co';
const A_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaHdodm9kZ2lrcGR1Y3JoZ2RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTAwNjEsImV4cCI6MjA2MzU4NjA2MX0.P6P-x4SxjiR4VdWH6VFgY_ktgMac_OzuI4Bl7HWskz8';
const ADB = window.supabase.createClient(A_URL, A_ANON);

// ================== Auth（C 專案） ==================
const loginView = document.getElementById('loginView');
const adminView = document.getElementById('adminView');
const loginMsg = document.getElementById('loginMsg');
const authBox = document.getElementById('authBox');

async function checkSession() {
  const { data: { session } } = await DB.auth.getSession();
  if (session) {
    loginView.classList.add('hidden');
    adminView.classList.remove('hidden');
    authBox.innerHTML = `<span class="pill">已登入</span> <button id="btnLogout" class="btn ghost" style="margin-left:8px;">登出</button>`;
    document.getElementById('btnLogout').onclick = async ()=>{ await DB.auth.signOut(); location.reload(); };
    // 初始化各 Tab 資料
    await Promise.all([
      loadTab1(), loadTab2(), loadTab3(), loadTab4(), loadTab5(), loadTab6()
    ]);
  } else {
    loginView.classList.remove('hidden');
    adminView.classList.add('hidden');
    authBox.textContent = '';
  }
}

document.getElementById('btnLogin').onclick = async () => {
  loginMsg.textContent = '登入中…';
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const { data, error } = await DB.auth.signInWithPassword({ email, password });
  if (error) { loginMsg.innerHTML = `<span class="status-bad">登入失敗：</span> ${error.message}`; return; }
  loginMsg.innerHTML = '<span class="status-ok">登入成功！</span>';
  await checkSession();
};

// ================== Tabs 切換 ==================
const tabButtons = document.querySelectorAll('.tab-btn');
tabButtons.forEach(btn => btn.addEventListener('click', () => {
  tabButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active');
  ['tab1','tab2','tab3','tab4','tab5','tab6'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(btn.dataset.tab).classList.remove('hidden');
}));

// ================== 工具 ==================
const sleep = ms => new Promise(r => setTimeout(r, ms));
function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

// ================== TAB1：玩家/學生 ==================
const tablePlayerLinks = document.querySelector('#tablePlayerLinks tbody');
const tableStudentCache = document.querySelector('#tableStudentCache tbody');
const searchTab1 = document.getElementById('searchTab1');
const syncStatus = document.getElementById('syncStatus');

document.getElementById('btnRefreshTab1').onclick = ()=> loadTab1();
document.getElementById('btnSyncApproved').onclick = ()=> syncApproved();

async function loadTab1(){
  // 玩家綁定
  const { data: players, error: pErr } = await DB.from('player_links').select('player_id, player_name, discord_user_id, is_admin').order('player_name', { ascending:true });
  if (pErr) { console.warn(pErr); return; }
  renderPlayerLinks(players||[]);

  // 學生快取
  const { data: students, error: sErr } = await DB.from('student_cache').select('student_id, student_name, player_id').order('student_name', { ascending:true });
  if (sErr) { console.warn(sErr); return; }
  renderStudentCache(students||[]);
}

function renderPlayerLinks(rows){
  const q = (searchTab1.value||'').toLowerCase();
  const data = rows.filter(r => [r.player_name, r.discord_user_id, r.player_id].join(' ').toLowerCase().includes(q));
  tablePlayerLinks.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="muted">${r.player_id}</td>
      <td><input data-k="player_name" value="${r.player_name||''}" style="width:180px" /></td>
      <td><input data-k="discord_user_id" value="${r.discord_user_id||''}" style="width:180px" placeholder="DCID" /></td>
      <td>
        <select data-k="is_admin">
          <option value="false" ${!r.is_admin?'selected':''}>否</option>
          <option value="true" ${r.is_admin?'selected':''}>是</option>
        </select>
      </td>
      <td class="right">
        <button class="btn ghost" data-act="save">儲存</button>
      </td>`;
    // 綁定事件
    tr.querySelector('[data-act="save"]').onclick = async () => {
      const payload = {
        player_id: r.player_id,
        player_name: tr.querySelector('[data-k="player_name"]').value.trim()||null,
        discord_user_id: (tr.querySelector('[data-k="discord_user_id"]').value.trim()||null),
        is_admin: tr.querySelector('[data-k="is_admin"]').value === 'true'
      };
      const { error } = await DB.from('player_links').upsert(payload, { onConflict: 'player_id' });
      if (error) alert('更新失敗：'+error.message); else alert('已儲存');
      loadTab1();
    };
    tablePlayerLinks.appendChild(tr);
  });
}

function renderStudentCache(rows){
  const q = (searchTab1.value||'').toLowerCase();
  const data = rows.filter(r => [r.student_name, r.student_id, r.player_id].join(' ').toLowerCase().includes(q));
  tableStudentCache.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="muted">${r.student_id}</td>
      <td>${r.student_name}</td>
      <td class="muted">${r.player_id}</td>`;
    tableStudentCache.appendChild(tr);
  });
}

searchTab1.addEventListener('input', ()=>{ // 即時篩選
  // 重新拉資料效率較差，直接重新 render 舊資料較好
  // 但為簡化，直接重載
  loadTab1();
});

// 從 A 專案同步：玩家（全抓） + 學生（僅 student_code 不為 NULL）
async function syncApproved(){
  syncStatus.textContent = '同步中…';
  // players
  const players = await fetchAllAPlayers();
  // students (approved only)
  const students = await fetchAllAStudentsApproved();

  // Upsert 到 C 專案
  // 1) player_links：只寫入 player_id + player_name（不動 discord_user_id）
  const playerPayload = players.map(p => ({ player_id: p.player_id, player_name: p.username||'玩家' }));
  await upsertChunked('player_links', playerPayload, 'player_id');

  // 2) student_cache：student_id, student_name, player_id
  const stuPayload = students.map(s => ({ student_id: s.student_id, student_name: s.name, player_id: s.player_id }));
  await upsertChunked('student_cache', stuPayload, 'student_id');

  syncStatus.innerHTML = `<span class="status-ok">同步完成</span>（玩家 ${players.length} 筆；過審學生 ${students.length} 筆）`;
  await loadTab1();
}

async function fetchAllAPlayers(){
  let from=0, step=1000; const out=[]; let done=false;
  while(!done){
    const { data, error, count } = await ADB.from('players')
      .select('player_id, username', { count: 'exact' })
      .range(from, from+step-1);
    if (error) { console.warn('[A.players] error', error); break; }
    out.push(...(data||[]));
    from += step; if (!data || data.length < step) done = true; await sleep(40);
  }
  return out;
}

async function fetchAllAStudentsApproved(){
  let from=0, step=1000; const out=[]; let done=false;
  while(!done){
    const { data, error } = await ADB.from('students')
      .select('student_id, name, student_code, player_id')
      .not('student_code', 'is', null)
      .order('name', { ascending: true })
      .range(from, from+step-1);
    if (error) { console.warn('[A.students] error', error); break; }
    out.push(...(data||[]));
    from += step; if (!data || data.length < step) done = true; await sleep(40);
  }
  return out;
}

async function upsertChunked(table, rows, onConflictKey){
  const groups = chunk(rows, 500);
  for (const g of groups){
    const { error } = await DB.from(table).upsert(g, { onConflict: onConflictKey });
    if (error) { console.warn(`[${table}] upsert error`, error); throw error; }
    await sleep(50);
  }
}

// ================== TAB2：地區 ==================
const tableArea = document.querySelector('#tableArea tbody');
const areaName = document.getElementById('areaName');
const areaType = document.getElementById('areaType');
const areaThread = document.getElementById('areaThread');
const areaWebhook = document.getElementById('areaWebhook');
const areaDailyLimit = document.getElementById('areaDailyLimit');

document.getElementById('btnAddArea').onclick = async ()=>{
  const payload = {
    area_name: areaName.value.trim(),
    area_type: areaType.value,
    dc_thread_id: areaThread.value.trim()||null,
    webhook_url: areaWebhook.value.trim()||null,
    daily_limit: areaDailyLimit.value? Number(areaDailyLimit.value): null
  };
  if (!payload.area_name) { alert('請輸入地區名稱'); return; }
  const { error } = await DB.from('area').insert(payload);
  if (error) { alert('新增失敗：'+error.message); return; }
  areaName.value = areaThread.value = areaWebhook.value = ''; areaDailyLimit.value = '';
  loadTab2();
};

document.getElementById('btnRefreshTab2').onclick = ()=> loadTab2();

async function loadTab2(){
  const { data, error } = await DB.from('area').select('*').order('area_name', { ascending: true });
  if (error) { console.warn(error); return; }
  renderArea(data||[]);
  // 也刷新學習型別地區給 TAB6 下拉
  await loadTeacherAreas();
}

function renderArea(rows){
  tableArea.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input data-k="area_name" value="${r.area_name||''}" /></td>
      <td>
        <select data-k="area_type">
          ${['學習','愛校','打工','特殊打工','遊戲'].map(t=>`<option value="${t}" ${r.area_type===t?'selected':''}>${t}</option>`).join('')}
        </select>
      </td>
      <td><input data-k="dc_thread_id" value="${r.dc_thread_id||''}" /></td>
      <td><input data-k="webhook_url" value="${r.webhook_url||''}" /></td>
      <td><input data-k="daily_limit" type="number" value="${r.daily_limit??''}" /></td>
      <td class="right">
        <button class="btn ghost" data-act="save">儲存</button>
        <button class="btn danger" data-act="del">刪除</button>
      </td>`;
    tr.querySelector('[data-act="save"]').onclick = async ()=>{
      const payload = {
        area_name: tr.querySelector('[data-k="area_name"]').value.trim(),
        area_type: tr.querySelector('[data-k="area_type"]').value,
        dc_thread_id: tr.querySelector('[data-k="dc_thread_id"]').value.trim()||null,
        webhook_url: tr.querySelector('[data-k="webhook_url"]').value.trim()||null,
        daily_limit: (tr.querySelector('[data-k="daily_limit"]').value || null)
      };
      const { error } = await DB.from('area').update(payload).eq('area_id', r.area_id);
      if (error) alert('更新失敗：'+error.message); else alert('已儲存');
      loadTab2();
    };
    tr.querySelector('[data-act="del"]').onclick = async ()=>{
      if (!confirm('確定刪除此地區？')) return;
      const { error } = await DB.from('area').delete().eq('area_id', r.area_id);
      if (error) alert('刪除失敗：'+error.message); else tr.remove();
      loadTeacherAreas();
    };
    tableArea.appendChild(tr);
  });
}

// ================== TAB3：時薪設定 ==================
const wageWork = document.getElementById('wageWork');
const wageSpecial = document.getElementById('wageSpecial');
const wageInfo = document.getElementById('wageInfo');

document.getElementById('btnRefreshTab3').onclick = ()=> loadTab3();
document.getElementById('btnSaveWage').onclick = async ()=>{
  const work = Number(wageWork.value||0); const sp = Number(wageSpecial.value||0);
  const { error } = await DB.from('wage_config').upsert({ config_id:1, work_wage_default:work, special_wage_default:sp });
  if (error) { alert('儲存失敗：'+error.message); return; }
  alert('儲存成功'); loadTab3();
};

async function loadTab3(){
  const { data, error } = await DB.from('wage_config').select('*').eq('config_id', 1).maybeSingle();
  if (error) { console.warn(error); return; }
  wageWork.value = data?.work_wage_default ?? 100;
  wageSpecial.value = data?.special_wage_default ?? 5;
  wageInfo.textContent = data? `最後更新：${new Date(data.updated_at).toLocaleString('zh-TW')}` : '';
}

// ================== TAB4：販售道具 ==================
const shopItemName = document.getElementById('shopItemName');
const shopPriceType = document.getElementById('shopPriceType');
const shopPrice = document.getElementById('shopPrice');
const shopStock = document.getElementById('shopStock');
const shopEffect = document.getElementById('shopEffect');
const shopEffectCode = document.getElementById('shopEffectCode');
const shopMaxUses = document.getElementById('shopMaxUses');
const tableShop = document.querySelector('#tableShop tbody');

document.getElementById('btnAddShopItem').onclick = async ()=>{
  const payload = {
    item_name: shopItemName.value.trim(),
    price_type: shopPriceType.value,
    price: Number(shopPrice.value||0),
    stock: Number(shopStock.value||0),
    item_effect: shopEffect.value.trim()||null,
    effect_code: shopEffectCode.value.trim()||null,
    max_uses: shopMaxUses.value? Number(shopMaxUses.value): null
  };
  if (!payload.item_name) { alert('請輸入道具名稱'); return; }
  const { error } = await DB.from('shop_items').insert(payload);
  if (error) { alert('新增失敗：'+error.message); return; }
  shopItemName.value = shopPrice.value = shopStock.value = shopEffect.value = shopEffectCode.value = shopMaxUses.value = '';
  loadTab4();
};

document.getElementById('btnRefreshTab4').onclick = ()=> loadTab4();

async function loadTab4(){
  const { data, error } = await DB.from('shop_items').select('*').order('item_name', { ascending:true });
  if (error) { console.warn(error); return; }
  tableShop.innerHTML = '';
  (data||[]).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input data-k="item_name" value="${r.item_name}" /></td>
      <td>
        <select data-k="price_type">
          ${['一般貨幣','謝爾夏貨幣','愛校點數'].map(t=>`<option value="${t}" ${r.price_type===t?'selected':''}>${t}</option>`).join('')}
        </select>
      </td>
      <td><input data-k="price" type="number" value="${r.price}" style="width:80px"/></td>
      <td><input data-k="stock" type="number" value="${r.stock}" style="width:80px"/></td>
      <td><input data-k="item_effect" value="${r.item_effect||''}" /></td>
      <td><input data-k="effect_code" value="${r.effect_code||''}" /></td>
      <td><input data-k="max_uses" type="number" value="${r.max_uses??''}" style="width:80px"/></td>
      <td class="right">
        <button class="btn ghost" data-act="save">儲存</button>
        <button class="btn danger" data-act="del">刪除</button>
      </td>`;
    tr.querySelector('[data-act="save"]').onclick = async ()=>{
      const payload = {
        item_name: tr.querySelector('[data-k="item_name"]').value.trim(),
        price_type: tr.querySelector('[data-k="price_type"]').value,
        price: Number(tr.querySelector('[data-k="price"]').value||0),
        stock: Number(tr.querySelector('[data-k="stock"]').value||0),
        item_effect: tr.querySelector('[data-k="item_effect"]').value.trim()||null,
        effect_code: tr.querySelector('[data-k="effect_code"]').value.trim()||null,
        max_uses: tr.querySelector('[data-k="max_uses"]').value? Number(tr.querySelector('[data-k="max_uses"]').value): null
      };
      const { error } = await DB.from('shop_items').update(payload).eq('id', r.id);
      if (error) alert('更新失敗：'+error.message); else alert('已儲存');
      loadTab4();
    };
    tr.querySelector('[data-act="del"]').onclick = async ()=>{
      if (!confirm('確定刪除此項目？')) return;
      const { error } = await DB.from('shop_items').delete().eq('id', r.id);
      if (error) alert('刪除失敗：'+error.message); else tr.remove();
    };
    tableShop.appendChild(tr);
  });
}

// ================== TAB5：戰鬥攜帶物 ==================
const tableBattle = document.querySelector('#tableBattle tbody');

document.getElementById('btnAddBattleItem').onclick = async ()=>{
  const payload = {
    student_name: document.getElementById('battleStudent').value.trim(),
    slot: Number(document.getElementById('battleSlot').value||0),
    item_name: document.getElementById('battleItemName').value.trim(),
    uses_left: document.getElementById('battleUses').value? Number(document.getElementById('battleUses').value): null,
    item_effect: document.getElementById('battleEffect').value.trim()||null,
    locked_until_broken: document.getElementById('battleLocked').value === 'true'
  };
  if (!payload.student_name || !payload.slot || !payload.item_name) { alert('請完整填寫'); return; }
  const { error } = await DB.from('battle_items').insert(payload);
  if (error) { alert('新增失敗：'+error.message); return; }
  ['battleStudent','battleSlot','battleItemName','battleUses','battleEffect'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('battleLocked').value='false';
  loadTab5();
};

document.getElementById('btnRefreshTab5').onclick = ()=> loadTab5();

async function loadTab5(){
  const { data, error } = await DB.from('battle_items').select('*').order('student_name', { ascending:true });
  if (error) { console.warn(error); return; }
  tableBattle.innerHTML = '';
  (data||[]).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input data-k="student_name" value="${r.student_name}" /></td>
      <td><input data-k="slot" type="number" min="1" max="4" value="${r.slot}" style="width:60px"/></td>
      <td><input data-k="item_name" value="${r.item_name}" /></td>
      <td><input data-k="uses_left" type="number" value="${r.uses_left??''}" style="width:80px"/></td>
      <td><input data-k="item_effect" value="${r.item_effect||''}" /></td>
      <td>
        <select data-k="locked_until_broken">
          <option value="false" ${!r.locked_until_broken?'selected':''}>否</option>
          <option value="true" ${r.locked_until_broken?'selected':''}>是</option>
        </select>
      </td>
      <td class="right">
        <button class="btn ghost" data-act="save">儲存</button>
        <button class="btn danger" data-act="del">刪除</button>
      </td>`;
    tr.querySelector('[data-act="save"]').onclick = async ()=>{
      const payload = {
        student_name: tr.querySelector('[data-k="student_name"]').value.trim(),
        slot: Number(tr.querySelector('[data-k="slot"]').value||0),
        item_name: tr.querySelector('[data-k="item_name"]').value.trim(),
        uses_left: tr.querySelector('[data-k="uses_left"]').value? Number(tr.querySelector('[data-k="uses_left"]').value): null,
        item_effect: tr.querySelector('[data-k="item_effect"]').value.trim()||null,
        locked_until_broken: tr.querySelector('[data-k="locked_until_broken"]').value === 'true'
      };
      const { error } = await DB.from('battle_items').update(payload).eq('id', r.id);
      if (error) alert('更新失敗：'+error.message); else alert('已儲存');
      loadTab5();
    };
    tr.querySelector('[data-act="del"]').onclick = async ()=>{
      if (!confirm('確定刪除？')) return;
      const { error } = await DB.from('battle_items').delete().eq('id', r.id);
      if (error) alert('刪除失敗：'+error.message); else tr.remove();
    };
    tableBattle.appendChild(tr);
  });
}

// ================== TAB6：教師文本 ==================
const tableTeacher = document.querySelector('#tableTeacher tbody');
const teacherArea = document.getElementById('teacherArea');

async function loadTeacherAreas(){
  const { data, error } = await DB.from('area').select('area_id, area_name').eq('area_type', '學習').order('area_name', { ascending:true });
  if (error) { console.warn(error); return; }
  teacherArea.innerHTML = '';
  (data||[]).forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.area_id; opt.textContent = a.area_name; teacherArea.appendChild(opt);
  });
}

document.getElementById('btnAddTeacherText').onclick = async ()=>{
  const payload = {
    area_id: teacherArea.value,
    course_name: document.getElementById('teacherCourse').value.trim(),
    reply_text: document.getElementById('teacherText').value.trim()
  };
  if (!payload.area_id || !payload.course_name || !payload.reply_text) { alert('請完整填寫'); return; }
  const { error } = await DB.from('teacher_texts').insert(payload);
  if (error) { alert('新增失敗：'+error.message); return; }
  document.getElementById('teacherCourse').value='';
  document.getElementById('teacherText').value='';
  loadTab6();
};

document.getElementById('btnRefreshTab6').onclick = ()=> loadTab6();

async function loadTab6(){
  await loadTeacherAreas();
  const { data, error } = await DB.from('teacher_texts').select('id, area_id, course_name, reply_text').order('id', { ascending:false });
  if (error) { console.warn(error); return; }

  // 取地區名稱 map
  const { data: areas } = await DB.from('area').select('area_id, area_name');
  const nameMap = {}; (areas||[]).forEach(a=> nameMap[a.area_id]=a.area_name);

  tableTeacher.innerHTML = '';
  (data||[]).sort((a,b)=> String(nameMap[a.area_id]||'').localeCompare(String(nameMap[b.area_id]||''), 'zh-Hant', { numeric:true }))
    .forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nameMap[r.area_id]||'-'}</td>
        <td><input data-k="course_name" value="${r.course_name||''}"/></td>
        <td><input data-k="reply_text" value="${r.reply_text||''}" class="grow"/></td>
        <td class="right">
          <button class="btn ghost" data-act="save">儲存</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>`;
      tr.querySelector('[data-act="save"]').onclick = async ()=>{
        const payload = {
          course_name: tr.querySelector('[data-k="course_name"]').value.trim(),
          reply_text: tr.querySelector('[data-k="reply_text"]').value.trim()
        };
        const { error } = await DB.from('teacher_texts').update(payload).eq('id', r.id);
        if (error) alert('更新失敗：'+error.message); else alert('已儲存');
        loadTab6();
      };
      tr.querySelector('[data-act="del"]').onclick = async ()=>{
        if (!confirm('確定刪除此台詞？')) return;
        const { error } = await DB.from('teacher_texts').delete().eq('id', r.id);
        if (error) alert('刪除失敗：'+error.message); else tr.remove();
      };
      tableTeacher.appendChild(tr);
    });
}

// ============== 啟動 ==============
checkSession();
</script>
</body>
</html>
